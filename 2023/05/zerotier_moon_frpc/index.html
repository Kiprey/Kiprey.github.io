<!DOCTYPE html>


<html lang="zh-CN">


<head>
  <meta charset="utf-8" />
   
  <meta name="keywords" content="ZeroTier, tools,漏洞挖掘, 调试, 代码, 计算机科学, Kiprey, Blog, 二进制，信息安全" />
   
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    使用 Frpc 进行内网穿透构建 ZeroTier Moon 记录 |  Kiprey&#39;s Blog
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">
  
<link rel="stylesheet" href="/css/custom.css">

  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  
<script>
var _hmt = _hmt || [];
(function() {
	var hm = document.createElement("script");
	hm.src = "https://hm.baidu.com/hm.js?acff2772e1f74a625e1e26c280afa6c2";
	var s = document.getElementsByTagName("script")[0]; 
	s.parentNode.insertBefore(hm, s);
})();
</script>


<link rel="alternate" href="/atom.xml" title="Kiprey's Blog" type="application/atom+xml">
</head>

</html>

<body>
  <div id="app">
    
      
      <canvas width="1777" height="841"
        style="position: fixed; left: 0px; top: 0px; z-index: 99999; pointer-events: none;"></canvas>
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-zerotier_moon_frpc"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  使用 Frpc 进行内网穿透构建 ZeroTier Moon 记录
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/05/zerotier_moon_frpc/" class="article-date">
  <time datetime="2023-05-16T16:00:00.000Z" itemprop="datePublished">2023-05-17</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tools/">Tools</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">3.6k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">15 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="一、简介">一、简介</h2>
<p>Zerotier 是一个专用于异地组网的工具，它方便将多台异地机器以 P2P 或者 中转 Relay 的方式实现宛如局域网般的流畅体验。</p>
<p>Zerotier 组网中节点分为三个部分，分别是位于国外的中央服务器 Planet，用户自建节点 Moon，以及用户其他节点 Leaf。</p>
<p>由于 Planet 位于国外，当两台机器地理位置相隔甚远时，无论是 UDP 打洞还是 Relay 中继，速度都非常慢，因此尝试自建一台国内Zerotier Moon 来提高打洞概率 + 中继速度。</p>
<p>网上搭建 Zerotier Moon 的教程都需要购买一台服务器，但本人不想这么折腾，因此尝试探索 FRPC 内网穿透的搭建方式。</p>
<a id="more"></a>
<h2 id="二、Zerotier-打洞-中继">二、Zerotier 打洞/中继</h2>
<p>在做内网穿透/搭建 Moon 之前，我们得先理解 Zerotier 的打洞和中继原理。</p>
<blockquote>
<p>本节参考：<a href="https://github.com/zerotier/ZeroTierOne/blob/adfbbc3/service/OneService.cpp" target="_blank" rel="noopener">ZeroTierOne/service/OneService.cpp - github</a>，以及自己花费大量时间调试 + wireshark 抓包的痛苦经验。</p>
</blockquote>
<h3 id="1-监听状态">1. 监听状态</h3>
<p>Zerotier 会在本地同时使用 <strong>3 个端口</strong>，其中每个端口都会分别<strong>监听 TCP 和 UDP 连接</strong>。以下是 Zerotier 在我本机上的监听：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜  zerotier-one sudo lsof -i -P -n | grep zerotier</span><br><span class="line">zerotier- 2091716    zerotier-one    6u  IPv4 868501026      0t0  TCP 127.0.0.1:9993 (LISTEN)</span><br><span class="line">zerotier- 2091716    zerotier-one    7u  IPv6 868501027      0t0  TCP [::1]:9993 (LISTEN)</span><br><span class="line"></span><br><span class="line">zerotier- 2091716    zerotier-one   16u  IPv4 868501047      0t0  UDP 192.168.51.236:9993</span><br><span class="line">zerotier- 2091716    zerotier-one   17u  IPv4 868501048      0t0  TCP 192.168.51.236:9993 (LISTEN)</span><br><span class="line"></span><br><span class="line">zerotier- 2091716    zerotier-one   14u  IPv4 868501045      0t0  UDP 192.168.51.236:30978</span><br><span class="line">zerotier- 2091716    zerotier-one   15u  IPv4 868501046      0t0  TCP 192.168.51.236:30978 (LISTEN)</span><br><span class="line"></span><br><span class="line">zerotier- 2091716    zerotier-one   18u  IPv4 868501049      0t0  UDP 192.168.51.236:42276</span><br><span class="line">zerotier- 2091716    zerotier-one   19u  IPv4 868501050      0t0  TCP 192.168.51.236:42276 (LISTEN)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ... 略去剩余 IPv6 监听信息</span></span><br></pre></td></tr></table></figure>
<h3 id="2-三个端口">2. 三个端口</h3>
<p>先讲端口，这三个端口分别为首选端口、次选端口和末选端口，这三个端口的定义如注释所描述的那样：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ref: https://github.com/zerotier/ZeroTierOne/blob/adfbbc3/service/OneService.cpp#L802</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* To attempt to handle NAT/gateway craziness we use three local UDP ports:</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* [0] is the normal/default port, usually 9993</span></span><br><span class="line"><span class="comment">* [1] is a port derived from our ZeroTier address</span></span><br><span class="line"><span class="comment">* [2] is a port computed from the normal/default for use with uPnP/NAT-PMP mappings</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* [2] exists because on some gateways trying to do regular NAT-t interferes</span></span><br><span class="line"><span class="comment">* destructively with uPnP port mapping behavior in very weird buggy ways.</span></span><br><span class="line"><span class="comment">* It's only used if uPnP/NAT-PMP is enabled in this build.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>其中<strong>首选端口默认固定为 9993</strong>（默认端口可被修改，参阅<a href="https://github.com/zerotier/ZeroTierOne/blob/adfbbc3/service/README.md" target="_blank" rel="noopener">ZeroTier One Network Virtualization Service Documentation</a>）。</p>
<blockquote>
<p>我在网上看搭建 Moon 的教程中有看到过设置 9995 端口的，不看源码是真容易搞不清楚哪个端口更重要。</p>
<p>现在明确一点，Zerotier 默认情况下不涉及 9995 端口，<strong>只涉及到 9993 端口</strong>。</p>
</blockquote>
<p>当 host 尝试连接 peer 时，这三个端口会同时发送 <strong>UDP 数据</strong>至 peer。</p>
<blockquote>
<p>上下文中 host 指代本机，尽管 p2p 是去中心化的，但是为了便于说明还是要区分本机和远程对等机。</p>
</blockquote>
<p>peer 在接收到数据后，对应端口会立即朝着源地址返回一个 UDP 包打洞。倘若 host 接收到 peer 返回的三个 UDP 包的任意一个，则视为可被 DIRECT ACCESS，即 P2P 打洞成功。host 和 peer 会定期发送心跳包维护 p2p 洞，此时数据传递所使用的端口即 <strong>host 成功接收到的 peer 包的那个端口</strong>。</p>
<blockquote>
<p>在抓包时，经常看见 host 发三个 udp 给 Peer（注意一共有三个端口，一个端口发一个），而最后只能从 peer 那边接收到一个 UDP 包。</p>
</blockquote>
<p>使用 <code>zerotier-cli peers</code> 命令可以查看本机与其他 peer 的连接是 DIRECT(p2p) 还是 relay（中继），只有这两种连接状态。</p>
<blockquote>
<p>该命令需要 sudo/管理员权限。</p>
</blockquote>
<p>我们同时还可以看到 Zerotier 会监听这三个端口的 TCP 协议数据。这里的 <strong>TCP 协议数据与打洞/peers沟通无关</strong>，它实际上使用的是 Http 协议，主要用来与本地的 zerotier-cli 进行交互，例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  zerotier-one <span class="built_in">echo</span> <span class="string">"GET /info HTTP/1.1\r\nX-ZT1-Auth: <span class="variable">$(sudo cat /var/lib/zerotier-one/authtoken.secret)</span>\r\n\r\n"</span> | nc 127.0.0.1 9993 -v</span><br><span class="line">Connection to 127.0.0.1 9993 port [tcp/*] succeeded!</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 91</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"controller"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"apiVersion"</span>: 4,</span><br><span class="line">        <span class="string">"clock"</span>: 1684295560845,</span><br><span class="line">        <span class="string">"databaseReady"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里我只测试成功过 <code>127.0.0.1:9993</code> 的 TCP 连接，其他监听端口/监听地址的组合我都无法用 nc 测试成功过，暂不了解具体原因。</p>
</blockquote>
<p>具体其他的 HTTP 请求选项可以参考 <a href="https://github.com/zerotier/ZeroTierOne/blob/adfbbc3fb00becc578afc0645c60b1de3d84bb4c/service/README.md#network-virtualization-service-api" target="_blank" rel="noopener">Network Virtualization Service API</a> 来理解，这里不再赘述。</p>
<h3 id="3-中继">3. 中继</h3>
<p>当 host 和 peer 没法 p2p 直连时，Zerotier 会尝试使用中继手段，相关逻辑位于 <a href="https://github.com/zerotier/ZeroTierOne/blob/adfbbc3/service/OneService.cpp#L3233" target="_blank" rel="noopener">nodeWirePacketSendFunction 函数</a> 中。</p>
<p>中继也分为两种，一种是 TCP 中继，一种是 UDP 中继：</p>
<ul>
<li>
<p><strong>UDP 中继</strong>。UDP中继是 Zerotier 的主流中继实现方式，它会寻找 Moon/Planet 并要求他们来为待发送的数据包进行 UDP 中继，因此无论是 host 还是 peer，中继发送/接收的数据全部都是 UDP 数据，逻辑比较简单。</p>
</li>
<li>
<p><strong>TCP 中继。</strong> Zerotier 认为 <strong>TCP 中继开销太大</strong>，因此只在极端恶劣的情况下（例如UDP中继完全失败，即所有UDP数据包全被网关过滤或者超时非常严重等情况，）才会使用 TCP 中继，但事实上这种恶劣情况概率极小，所以可以等同于 Zerotier 基本上不使用 TCP 中继。</p>
<p>Zerotier 只有在 60s 没有接收到任何数据时才能进行 TCP中继，这个时间相当的长，相信大多情况下应该都不会触发这个条件。</p>
</li>
</ul>
<p>用户可以根据 <a href="https://github.com/zerotier/ZeroTierOne/blob/adfbbc3/tcp-proxy/README.md" target="_blank" rel="noopener">ZeroTier TCP Proxy Server Documentation</a> 配置 <code>local.conf</code> 来指定是否<strong>强制使用 TCP 中继</strong>。在启用强制TCP中继后，UDP中继功能将不再启用。虽然 <strong>Zerotier 认为 TCP 中继会比 UDP 中继慢</strong>，但事实上我用 ping 测试发现 <strong>TCP 中继节点比 UDP 中继节点距离我更近一点</strong>，延迟更小，因此 Zerotier 的这个说法仁者见仁智者见智，需要理论联系实际。</p>
<h2 id="三、Frpc-内网穿透">三、Frpc 内网穿透</h2>
<h3 id="1-做法">1. 做法</h3>
<p><strong>Frpc 用来穿透 Moon 服务器的 9993 UDP 端口。</strong></p>
<p>这里本人用的是 <a href="https://www.natfrp.com/" target="_blank" rel="noopener">NatFrp</a>，这个真的相当良心，免费版每月 5Gb/10Mbps/2tunnel，基本满足绝大多数的需求。</p>
<p>选一个距离 peers 比较近一点的机房，然后选<strong>多线</strong>机房（个人理解是同时接入多个运营商网络的机房），这样本机在任何运营商网络下都能有比较高的 p2p 打洞成功概率，这是我的隧道配置：</p>
<p><img src="/2023/05/zerotier_moon_frpc/image-20230517132531412.png" alt="image-20230517132531412"></p>
<p>注意这里指定本机 IP 时<strong>一定要指定为局域网IP</strong>（即 192.168.0.0/16 等），<strong>而非回环IP（即127.0.0.1</strong>），符合条件的局域网 IP 范围如下图所示：</p>
<p><img src="/2023/05/zerotier_moon_frpc/image-20230517120903864.png" alt="image-20230517120903864"></p>
<blockquote>
<p>代码位置位于 <a href="https://github.com/zerotier/ZeroTierOne/blob/adfbbc3fb00becc578afc0645c60b1de3d84bb4c/node/InetAddress.cpp#L29" target="_blank" rel="noopener">InetAddress::ipScope 函数</a>。</p>
</blockquote>
<p>可能有人看到 <code>172.16.0.0/12</code> 也可以，因此就在 Zerotier 控制面板上给 moon 服务器/被穿透的服务额外增添了一个 <code>172.16</code> 打头的虚拟网 IP，之后把 Frpc 绑定到这样新添加的 172.16 打头IP上，以为也能达到要求。但经过本人实验是不行的，<strong>原因是 Zerotier 服务不会监听 Zerotier 自己虚拟网段下的 IP</strong>。</p>
<p>这里填写的本机IP，一定要是既<strong>符合上图网段要求</strong>，同时还<strong>被 Zerotier 监听 UDP 协议</strong>的 IP。</p>
<h3 id="2-原理">2. 原理</h3>
<blockquote>
<p>如果兴趣不大则可以跳过本节内容。</p>
</blockquote>
<p>这是因为 <a href="https://github.com/zerotier/ZeroTierOne/blob/adfbbc3fb00becc578afc0645c60b1de3d84bb4c/node/Path.hpp#L223" target="_blank" rel="noopener">isAddressValidForPath 函数</a> 只把<strong>四种类型</strong>的 IP 视为有效地址：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Check whether this address is valid for a ZeroTier path</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * This checks the address type and scope against address types and scopes</span></span><br><span class="line"><span class="comment">  * that we currently support for ZeroTier communication.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * @param a Address to check</span></span><br><span class="line"><span class="comment">  * @return True if address is good for ZeroTier path use</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">isAddressValidForPath</span><span class="params">(<span class="keyword">const</span> InetAddress &amp;a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((a.ss_family == AF_INET)||(a.ss_family == AF_INET6)) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(a.ipScope()) &#123;</span><br><span class="line">                <span class="comment">/* Note: we don't do link-local at the moment. Unfortunately these</span></span><br><span class="line"><span class="comment">         * cause several issues. The first is that they usually require a</span></span><br><span class="line"><span class="comment">         * device qualifier, which we don't handle yet and can't portably</span></span><br><span class="line"><span class="comment">         * push in PUSH_DIRECT_PATHS. The second is that some OSes assign</span></span><br><span class="line"><span class="comment">         * these very ephemerally or otherwise strangely. So we'll use</span></span><br><span class="line"><span class="comment">         * private, pseudo-private, shared (e.g. carrier grade NAT), or</span></span><br><span class="line"><span class="comment">         * global IP addresses. */</span></span><br><span class="line">            <span class="keyword">case</span> InetAddress::IP_SCOPE_PRIVATE:</span><br><span class="line">            <span class="keyword">case</span> InetAddress::IP_SCOPE_PSEUDOPRIVATE:</span><br><span class="line">            <span class="keyword">case</span> InetAddress::IP_SCOPE_SHARED:</span><br><span class="line">            <span class="keyword">case</span> InetAddress::IP_SCOPE_GLOBAL:</span><br><span class="line">                <span class="keyword">if</span> (a.ss_family == AF_INET6) &#123;</span><br><span class="line">                    <span class="comment">// TEMPORARY HACK: for now, we are going to blacklist he.net IPv6</span></span><br><span class="line">                    <span class="comment">// tunnels due to very spotty performance and low MTU issues over</span></span><br><span class="line">                    <span class="comment">// these IPv6 tunnel links.</span></span><br><span class="line">                    <span class="keyword">const</span> <span class="keyword">uint8_t</span> *ipd = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">uint8_t</span> *&gt;(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> struct sockaddr_in6 *&gt;(&amp;a)-&gt;sin6_addr.s6_addr);</span><br><span class="line">                    <span class="keyword">if</span> ((ipd[<span class="number">0</span>] == <span class="number">0x20</span>)&amp;&amp;(ipd[<span class="number">1</span>] == <span class="number">0x01</span>)&amp;&amp;(ipd[<span class="number">2</span>] == <span class="number">0x04</span>)&amp;&amp;(ipd[<span class="number">3</span>] == <span class="number">0x70</span>)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这其中包括了 <code>IP_SCOPE_PRIVATE</code> 局域网地址和 <code>IP_SCOPE_GLOBAL</code> 公网地址，但并不包括 <code>IP_SCOPE_LOOPBACK</code> 回环地址。</p>
<p>Zerotier 在接收到 UDP 数据包后会获取包中的<strong>目的 IP</strong>，进而判断该数据包是否合法。这个逻辑比较容易理解，只要知道对方朝的是自己哪个 IP 地址发包，就能得知哪个网卡可以 p2p 打洞。</p>
<p>但倘若 FRP 绑定的是本机的 127.0.0.1，那么即便其他 peer 能通过 FRP 发包到 <code>udp://127.0.0.1:9993</code>，Zerotier 也会丢弃接收到的 UDP 数据，造成 p2p 失败。</p>
<h2 id="三、Frpc-测试">三、Frpc 测试</h2>
<p>在创建好隧道并且也在远程 moon 节点所在机器上也连接好 Frpc 隧道后，接下来<strong>需要测试一下 host 和 moon 之间的 UDP 收发能力</strong>。</p>
<p><strong>这一步非常重要</strong>，因为 UDP 协议的特殊性，很多网络都会对 UDP 数据包有着严苛的过滤条件。</p>
<blockquote>
<p>例如本人在学校校园网中就无法成功收发 UDP 数据包。</p>
</blockquote>
<p>测试步骤很简单：</p>
<ol>
<li>
<p><strong>修改 moon 机器上 frpc 待转发的端口</strong>，从 9993 修改为 9992，之后重新启动 frpc，此时穿透的 UDP 数据应该会发送至本机 9992 端口处。</p>
<p>这一步可以通过直接修改 frpc.ini 或者在网页面板上修改并重新拉取配置文件来完成。</p>
<p>9992端口没有什么特殊性，可以随便改成一个自己记得住的端口；这里修改端口是因为 9993 端口已经被 Zerotier 服务占用了，一个端口无法同时被多个 UDP 监听。</p>
</li>
<li>
<p><strong>在 moon 机器上启动 UDP-EchoServer 服务</strong>，以下是我用来测试的 python 代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python3 /tmp/udp-echoserver.py 192.168.XX.XX 9992</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">udp_echo_server</span><span class="params">(host, port)</span>:</span></span><br><span class="line">    server_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">    server_socket.bind((host, port))</span><br><span class="line">    print(<span class="string">f"UDP Echo server started on <span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>"</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">       data, addr = server_socket.recvfrom(<span class="number">1024</span>)</span><br><span class="line">       print(<span class="string">f"Received data from <span class="subst">&#123;addr&#125;</span>: <span class="subst">&#123;len(data)&#125;</span>"</span>)</span><br><span class="line">       server_socket.sendto(<span class="string">b"server: "</span> + data, addr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt; <span class="number">3</span>:</span><br><span class="line">        print(<span class="string">"Usage: python udp_echo_server.py &lt;host&gt; &lt;port&gt;"</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    host = sys.argv[<span class="number">1</span>]</span><br><span class="line">    port = int(sys.argv[<span class="number">2</span>])</span><br><span class="line">    udp_echo_server(host, port)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>host 上运行 <code>nc -u &lt;ip&gt; &lt;port&gt;</code> 向 Frpc 中转服务器发送 UDP 数据包，查看发送的数据包能否被转发回来。</p>
</li>
</ol>
<p>测试效果如下，图中上面两个窗口是 moon 服务器的 shell，最下方窗口是 host 的 shell。host 使用 <code>nc -u &lt;ip&gt; &lt;port&gt;</code> 并在交互式界面中输入数据并按下 enter 键发送。该 UDP 数据包将被发送至 Frpc 中转服务器并穿透至 moon 的 <code>udp://192.168.x.x:9992</code>，随后 9992 端口上的 echo server 就会把该数据包原样返回。<strong>只要 host 能在发送 UDP 数据包后原封不动的接收到 UDP 数据，即可证明双方 UDP 收发功能正常。</strong></p>
<p><img src="/2023/05/zerotier_moon_frpc/image-20230517135624795.png" alt="image-20230517135624795"></p>
<p>这一步可能会有一定概率失败，失败的原因主要有两个（都是本人遇到过的）：</p>
<ol>
<li>
<p>Frpc <strong>公网中转服务器所分配的端口号过大</strong>，例如分配了 50000+ 的端口号。过大的 UDP 端口号可能会被路由策略过滤，只能重新申请分配新的 UDP 隧道或者更换中转服务器节点，来<strong>降低所分配的 UDP 端口号</strong>。</p>
<blockquote>
<p>本人测试 UDP 端口号 &lt; 30000 基本上没有出现过问题。</p>
</blockquote>
</li>
<li>
<p><strong>复杂或受限网络可能会限制 UDP 数据包的收发</strong>，例如校园网。本人连接校园网后实测无法收发 UDP 数据包，但切换为手机热点就可以通过 UDP 测试。</p>
</li>
</ol>
<blockquote>
<p>如果想测试 9993 端口的收信功能则可以使用命令：<code>sudo tshark -i any udp port 9993 and src host 192.168.x.x</code></p>
<p><strong>UDP测试完成后记得把隧道端口号改回 9993</strong>。</p>
</blockquote>
<h2 id="四、Zerotier-Moon-搭建">四、Zerotier Moon 搭建</h2>
<p>关于 Zerotier Moon 搭建网上教程是非常多的，基本上都是大同小异。可以参考这个 <a href="https://dengzile.com/2019/05/%E6%90%AD%E5%BB%BAzerotier%E7%9A%84moon%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B0%8F%E8%AE%B0/" target="_blank" rel="noopener">搭建ZeroTier的Moon服务器小记 - dengzile</a></p>
<ul>
<li>
<p>Moon 服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 0. 切换工作目录</span></span><br><span class="line"><span class="built_in">cd</span> /var/lib/zerotier-one</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 创建基础 moon 文件</span></span><br><span class="line">sudo zerotier-idtool initmoon identity.public &gt; moon.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 此处需要修改 moon.json 中 stableEndpoints 为 Frpc 分配的公网IP和端口</span></span><br><span class="line"><span class="comment"># （注意该隧道需要映射至 moon 的 9993 端口）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 给 moon.json 文件签名，生成 moon 文件</span></span><br><span class="line">sudo zerotier-idtool genmoon moon.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 将签名好的 moon 文件移动至 moons.d 文件夹下</span></span><br><span class="line">mkdir moons.d</span><br><span class="line">mv 000000*.moon moons.d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 重启 zerotier-one 服务</span></span><br><span class="line">sudo service zerotier-one restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 此时可以罗列出当前的 moons 信息</span></span><br><span class="line">sudo zerotier-cli listmoons</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>windows （本机），<strong>使用管理员权限</strong>打开 cmd：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">0</span>. 切换工作目录</span><br><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Kiprey</span>&gt;<span class="title">cd</span> <span class="title">C</span>:\<span class="title">ProgramData</span>\<span class="title">ZeroTier</span>\<span class="title">One</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 1. 创建 <span class="title">moons.d</span> 文件夹并切换</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">ProgramData</span>\<span class="title">ZeroTier</span>\<span class="title">One</span>&gt;<span class="title">mkdir</span> <span class="title">moons.d</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">ProgramData</span>\<span class="title">ZeroTier</span>\<span class="title">One</span>&gt;<span class="title">cd</span> <span class="title">moons.d</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 2. 拷贝远程 <span class="title">moon</span> 节点上的 <span class="title">moon</span> 文件，由于此时 <span class="title">moon</span> 还没配置好，因此这种数据下载实际上是通过 <span class="title">UDP</span> 中继完成。</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">ProgramData</span>\<span class="title">ZeroTier</span>\<span class="title">One</span>\<span class="title">moons.d</span>&gt;<span class="title">scp</span> <span class="title">kiprey</span>@172.24.0.133:/<span class="title">var</span>/<span class="title">lib</span>/<span class="title">zerotier</span>-<span class="title">one</span>/<span class="title">moons.d</span>/000000<span class="title">xxxxxxxxxx.moon</span> .</span></span><br><span class="line"><span class="function">000000<span class="title">xxxxxxxxxx.moon</span>                        100%  259     0.5<span class="title">KB</span>/<span class="title">s</span>   00:00</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 3. 重启服务</span></span><br><span class="line"><span class="function"># 键入 <span class="title">win</span> + <span class="title">R</span> 启动 "运行" 窗口 -&gt; <span class="title">services.msc</span> -&gt; 找到 <span class="title">Zerotier</span>-<span class="title">One</span> 服务并重启</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>这种下发 moon 文件的操作应该是可以通过 <code>zerotier-cli orbit</code> 命令来实现，但本人在实际测试的是否发现 orbit 可能会失败，即没能成功下发 moon 文件，不太清楚是哪里有问题，因此最终还是手动下载了一下。</p>
<p>不过这个问题并不重要，只是随口提起。</p>
</blockquote>
<p>重启本机 Zerotier 服务后再运行 <code>zerotier-cli peers</code>，可以发现 Moon 节点以及和 Moon 相近的节点全部从 RELAY 中继变成了 DIRECT 直连：</p>
<ul>
<li>
<p>配置 moon 前：</p>
<p><img src="/2023/05/zerotier_moon_frpc/image-20230517142839955.png" alt="image-20230517142839955"></p>
<p>sshping 延迟平均高达 300ms，操作 ssh 一卡一卡的。</p>
</li>
<li>
<p>配置 moon 后：</p>
<p><img src="/2023/05/zerotier_moon_frpc/image-20230517142520240.png" alt="image-20230517142520240"></p>
<p>sshping 的延迟降低到了 100ms 左右，ssh 操作明显的流畅起来了。</p>
</li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://kiprey.github.io/2023/05/zerotier_moon_frpc/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ZeroTier/" rel="tag">ZeroTier</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2023/08/curve_finance_vuln/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            Curve Finance 漏洞复现
          
        </div>
      </a>
    
    
      <a href="/2023/01/idek_coroutine/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">idekCTF2022 - Coroutine Writeup</div>
      </a>
    
  </nav>

   
 
   
<div class="gitalk" id="gitalk-container"></div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css">


<script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script>

<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: '5f6c407f4cb8963d03ac',
    clientSecret: '1d6faa663a735dbfd671990187d6e62b32498560',
    repo: 'kiprey.github.io',
    owner: 'kiprey',
    admin: ['kiprey'],
    // id: location.pathname,      // Ensure uniqueness and length less than 50
    id: md5(location.pathname),
    distractionFreeMode: false,  // Facebook-like distraction free mode
    pagerDirection: 'last'
  })

  gitalk.render('gitalk-container')
</script>
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2020-2025
        <i class="ri-heart-fill heart_icon"></i> Kiprey
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        <!-- <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
        <script>
            $(document).ready(function() {
                var int1 = setInterval(fixCount1, 100);
                var int2 = setInterval(fixCount2, 100);

                var busuanziValueSiteOffset = 100000000000;
                var busuanziValuePageOffset = 200000000000;
                function fixCount1() {
                    if ($("#busuanzi_value_site_uv").css("display") != "none") {
                        clearInterval(int1);
                        $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + busuanziValueSiteOffset);
                    }
                }
                function fixCount2() {
                    if ($("#busuanzi_value_page_pv").css("display") != "none") {
                        clearInterval(int2);
                        $("#busuanzi_value_page_pv").html(parseInt($("#busuanzi_value_page_pv").html()) + busuanziValuePageOffset);
                    }
                }
            });
        </script> -->
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Kiprey&#39;s Blog"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->


<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true
  }
</script>

<!-- Katex -->

<!-- busuanzi  -->


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->


<script src="/js/clickBoom2.js"></script>


<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


<script src="/js/dz.js"></script>


<!-- mermaid -->

  <script src='https://cdn.bootcdn.net/ajax/libs/mermaid/8.5.2/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>

<!-- baiduSpider auto push -->

  <script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https'){
       bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      }
      else{
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
    </script>


    
  </div>
</body>

</html>